2025-12-16T13:45:25.5049545Z ##[group]Run cargo fmt --all -- --check
2025-12-16T13:45:25.5049900Z [36;1mcargo fmt --all -- --check[0m
2025-12-16T13:45:25.5085922Z shell: /usr/bin/bash -e {0}
2025-12-16T13:45:25.5086177Z env:
2025-12-16T13:45:25.5086364Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:25.5086589Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:25.5086826Z   CARGO_INCREMENTAL: 0
2025-12-16T13:45:25.5087021Z ##[endgroup]
2025-12-16T13:45:25.6781841Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:17:
2025-12-16T13:45:25.6787766Z  use std::net::SocketAddr;
2025-12-16T13:45:25.6788069Z  use std::sync::Arc;
2025-12-16T13:45:25.6788306Z  use tokio::net::TcpListener;
2025-12-16T13:45:25.6788570Z -use tracing::{info, error, warn, Level};
2025-12-16T13:45:25.6789140Z +use tracing::{error, info, warn, Level};
2025-12-16T13:45:25.6789509Z  use tracing_subscriber::FmtSubscriber;
2025-12-16T13:45:25.6789766Z  
2025-12-16T13:45:25.6789927Z  mod socks5;
2025-12-16T13:45:25.6790449Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:24:
2025-12-16T13:45:25.6790930Z -mod tunnel;
2025-12-16T13:45:25.6791157Z  mod stream_manager;
2025-12-16T13:45:25.6791347Z +mod tunnel;
2025-12-16T13:45:25.6791524Z  mod vpn;
2025-12-16T13:45:25.6791683Z  
2025-12-16T13:45:25.6791868Z -use tunnel::TunnelClient;
2025-12-16T13:45:25.6792113Z  use socks5::Socks5Server;
2025-12-16T13:45:25.6792374Z -use vpn::{VpnController, VpnConfig};
2025-12-16T13:45:25.6792645Z +use tunnel::TunnelClient;
2025-12-16T13:45:25.6792998Z +use vpn::{VpnConfig, VpnController};
2025-12-16T13:45:25.6793408Z  
2025-12-16T13:45:25.6793709Z  /// Operating mode for the VPN client
2025-12-16T13:45:25.6794241Z  #[derive(Debug, Clone, Copy, ValueEnum, Default, PartialEq)]
2025-12-16T13:45:25.6795040Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:90:
2025-12-16T13:45:25.6795758Z      let args = Args::parse();
2025-12-16T13:45:25.6796098Z  
2025-12-16T13:45:25.6796384Z      // Initialize logging
2025-12-16T13:45:25.6796905Z -    let level = if args.verbose { Level::DEBUG } else { Level::INFO };
2025-12-16T13:45:25.6797486Z -    let subscriber = FmtSubscriber::builder()
2025-12-16T13:45:25.6797927Z -        .with_max_level(level)
2025-12-16T13:45:25.6798279Z -        .finish();
2025-12-16T13:45:25.6798597Z +    let level = if args.verbose {
2025-12-16T13:45:25.6799129Z +        Level::DEBUG
2025-12-16T13:45:25.6799382Z +    } else {
2025-12-16T13:45:25.6799556Z +        Level::INFO
2025-12-16T13:45:25.6799741Z +    };
2025-12-16T13:45:25.6800031Z +    let subscriber = FmtSubscriber::builder().with_max_level(level).finish();
2025-12-16T13:45:25.6800476Z      tracing::subscriber::set_global_default(subscriber)?;
2025-12-16T13:45:25.6800753Z  
2025-12-16T13:45:25.6800914Z      // Display banner
2025-12-16T13:45:25.6801305Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:119:
2025-12-16T13:45:25.6802079Z      info!("║         ZKS-Tunnel VPN - Serverless & Free                   ║");
2025-12-16T13:45:25.6802589Z      info!("╠══════════════════════════════════════════════════════════════╣");
2025-12-16T13:45:25.6802923Z      info!("║  Worker: {}  ", args.worker);
2025-12-16T13:45:25.6803165Z -    
2025-12-16T13:45:25.6803319Z +
2025-12-16T13:45:25.6803474Z      match args.mode {
2025-12-16T13:45:25.6803684Z          Mode::Socks5 => {
2025-12-16T13:45:25.6804043Z              info!("║  Mode:   SOCKS5 Proxy (browser only)                        ║");
2025-12-16T13:45:25.6804542Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:126:
2025-12-16T13:45:25.6805084Z -            info!("║  Listen: {}:{}                                  ", args.bind, args.port);
2025-12-16T13:45:25.6805390Z +            info!(
2025-12-16T13:45:25.6805661Z +                "║  Listen: {}:{}                                  ",
2025-12-16T13:45:25.6805945Z +                args.bind, args.port
2025-12-16T13:45:25.6806180Z +            );
2025-12-16T13:45:25.6806869Z          }
2025-12-16T13:45:25.6807054Z          Mode::Vpn => {
2025-12-16T13:45:25.6807410Z              info!("║  Mode:   System-Wide VPN (all traffic)                      ║");
2025-12-16T13:45:25.6807909Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:130:
2025-12-16T13:45:25.6808424Z -            info!("║  TUN:    {}                                             ", args.tun_name);
2025-12-16T13:45:25.6808843Z -            info!("║  VPN IP: {}                                          ", args.vpn_address);
2025-12-16T13:45:25.6809404Z +            info!(
2025-12-16T13:45:25.6809698Z +                "║  TUN:    {}                                             ",
2025-12-16T13:45:25.6809974Z +                args.tun_name
2025-12-16T13:45:25.6810179Z +            );
2025-12-16T13:45:25.6810353Z +            info!(
2025-12-16T13:45:25.6810617Z +                "║  VPN IP: {}                                          ",
2025-12-16T13:45:25.6810922Z +                args.vpn_address
2025-12-16T13:45:25.6811154Z +            );
2025-12-16T13:45:25.6811322Z          }
2025-12-16T13:45:25.6811473Z      }
2025-12-16T13:45:25.6811627Z -    
2025-12-16T13:45:25.6811778Z +
2025-12-16T13:45:25.6812093Z      info!("╚══════════════════════════════════════════════════════════════╝");
2025-12-16T13:45:25.6812370Z  }
2025-12-16T13:45:25.6812511Z  
2025-12-16T13:45:25.6812847Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:139:
2025-12-16T13:45:25.6813384Z  async fn run_socks5_mode(args: Args, tunnel: TunnelClient) -> Result<(), BoxError> {
2025-12-16T13:45:25.6813863Z      let bind_addr: SocketAddr = format!("{}:{}", args.bind, args.port).parse()?;
2025-12-16T13:45:25.6814265Z      let listener = TcpListener::bind(bind_addr).await?;
2025-12-16T13:45:25.6814528Z -    
2025-12-16T13:45:25.6814677Z +
2025-12-16T13:45:25.6814929Z      info!("🚀 SOCKS5 proxy listening on {}", bind_addr);
2025-12-16T13:45:25.6815345Z -    info!("   Configure your browser to use SOCKS5 proxy: {}:{}", args.bind, args.port);
2025-12-16T13:45:25.6815747Z +    info!(
2025-12-16T13:45:25.6815975Z +        "   Configure your browser to use SOCKS5 proxy: {}:{}",
2025-12-16T13:45:25.6816264Z +        args.bind, args.port
2025-12-16T13:45:25.6816469Z +    );
2025-12-16T13:45:25.6816620Z      info!("");
2025-12-16T13:45:25.6816934Z      info!("   Firefox: Settings → Network → Manual proxy → SOCKS5");
2025-12-16T13:45:25.6817273Z      info!("   Chrome:  Use SwitchyOmega extension");
2025-12-16T13:45:25.6817714Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:161:
2025-12-16T13:45:25.6818200Z          error!("   Rebuild with: cargo build --release --features vpn");
2025-12-16T13:45:25.6818547Z          return Err("VPN feature not enabled".into());
2025-12-16T13:45:25.6818799Z      }
2025-12-16T13:45:25.6819112Z -    
2025-12-16T13:45:25.6819308Z +
2025-12-16T13:45:25.6819469Z      #[cfg(feature = "vpn")]
2025-12-16T13:45:25.6819707Z      {
2025-12-16T13:45:25.6819902Z          // Check for admin/root privileges
2025-12-16T13:45:25.6820330Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:168:
2025-12-16T13:45:25.6820758Z          check_privileges()?;
2025-12-16T13:45:25.6820966Z -        
2025-12-16T13:45:25.6821124Z +
2025-12-16T13:45:25.6821392Z          let vpn_addr: std::net::Ipv4Addr = args.vpn_address.parse()?;
2025-12-16T13:45:25.6821691Z -        
2025-12-16T13:45:25.6821840Z +
2025-12-16T13:45:25.6822017Z          let config = VpnConfig {
2025-12-16T13:45:25.6822280Z              device_name: args.tun_name.clone(),
2025-12-16T13:45:25.6822551Z              address: vpn_addr,
2025-12-16T13:45:25.6822961Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:177:
2025-12-16T13:45:25.6823398Z              dns_protection: args.dns_protection,
2025-12-16T13:45:25.6823686Z              kill_switch: args.kill_switch,
2025-12-16T13:45:25.6823917Z          };
2025-12-16T13:45:25.6824360Z -        
2025-12-16T13:45:25.6824508Z +
2025-12-16T13:45:25.6824759Z          info!("🔒 Starting system-wide VPN...");
2025-12-16T13:45:25.6825102Z          info!("   All traffic will be routed through the tunnel.");
2025-12-16T13:45:25.6825388Z -        
2025-12-16T13:45:25.6825534Z +
2025-12-16T13:45:25.6825710Z          if args.kill_switch {
2025-12-16T13:45:25.6826026Z              info!("   Kill switch: ENABLED (traffic blocked if VPN drops)");
2025-12-16T13:45:25.6826325Z          }
2025-12-16T13:45:25.6826697Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:187:
2025-12-16T13:45:25.6827084Z -        
2025-12-16T13:45:25.6827234Z +
2025-12-16T13:45:25.6827403Z          if args.dns_protection {
2025-12-16T13:45:25.6827710Z              info!("   DNS protection: ENABLED (queries via DoH)");
2025-12-16T13:45:25.6827978Z          }
2025-12-16T13:45:25.6828355Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:191:
2025-12-16T13:45:25.6828852Z -        
2025-12-16T13:45:25.6829245Z +
2025-12-16T13:45:25.6829454Z          let tunnel = Arc::new(tunnel);
2025-12-16T13:45:25.6829770Z          let vpn = VpnController::new(tunnel, config);
2025-12-16T13:45:25.6830030Z -        
2025-12-16T13:45:25.6830184Z +
2025-12-16T13:45:25.6830347Z          vpn.start().await?;
2025-12-16T13:45:25.6830553Z -        
2025-12-16T13:45:25.6830699Z +
2025-12-16T13:45:25.6830864Z          // Wait for Ctrl+C
2025-12-16T13:45:25.6831067Z          info!("");
2025-12-16T13:45:25.6831302Z          info!("Press Ctrl+C to disconnect VPN...");
2025-12-16T13:45:25.6831826Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:200:
2025-12-16T13:45:25.6832532Z -        
2025-12-16T13:45:25.6832811Z +
2025-12-16T13:45:25.6833120Z          tokio::signal::ctrl_c().await?;
2025-12-16T13:45:25.6833513Z -        
2025-12-16T13:45:25.6833761Z +
2025-12-16T13:45:25.6834022Z          info!("");
2025-12-16T13:45:25.6834375Z          info!("Shutting down VPN...");
2025-12-16T13:45:25.6834806Z          vpn.stop().await?;
2025-12-16T13:45:25.6835474Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:206:
2025-12-16T13:45:25.6836045Z -        
2025-12-16T13:45:25.6836199Z +
2025-12-16T13:45:25.6836352Z          Ok(())
2025-12-16T13:45:25.6836522Z      }
2025-12-16T13:45:25.6836670Z -    
2025-12-16T13:45:25.6836829Z +
2025-12-16T13:45:25.6836997Z      #[cfg(not(feature = "vpn"))]
2025-12-16T13:45:25.6837215Z      Ok(())
2025-12-16T13:45:25.6837363Z  }
2025-12-16T13:45:25.6837853Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:221:
2025-12-16T13:45:25.6858672Z          warn!("⚠️  VPN mode requires Administrator privileges on Windows");
2025-12-16T13:45:25.6859702Z          warn!("   Right-click zks-vpn.exe → Run as administrator");
2025-12-16T13:45:25.6860192Z      }
2025-12-16T13:45:25.6860471Z -    
2025-12-16T13:45:25.6860712Z +
2025-12-16T13:45:25.6861018Z      #[cfg(unix)]
2025-12-16T13:45:25.6861331Z      {
2025-12-16T13:45:25.6861713Z          use std::os::unix::fs::MetadataExt;
2025-12-16T13:45:25.6862503Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:231:
2025-12-16T13:45:25.6863369Z              return Err("Root privileges required for VPN mode".into());
2025-12-16T13:45:25.6863929Z          }
2025-12-16T13:45:25.6864222Z      }
2025-12-16T13:45:25.6864499Z -    
2025-12-16T13:45:25.6864762Z +
2025-12-16T13:45:25.6865027Z      Ok(())
2025-12-16T13:45:25.6865283Z  }
2025-12-16T13:45:25.6865536Z  
2025-12-16T13:45:25.6866258Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/socks5.rs:3:
2025-12-16T13:45:25.6867147Z  //! Implements RFC 1928 (SOCKS5) for proxying TCP connections.
2025-12-16T13:45:25.6867872Z  //! Only supports CONNECT command (not BIND or UDP ASSOCIATE).
2025-12-16T13:45:25.6868435Z  
2025-12-16T13:45:25.6868784Z -use tokio::net::{TcpListener, TcpStream};
2025-12-16T13:45:25.6869825Z -use tokio::io::{AsyncReadExt, AsyncWriteExt};
2025-12-16T13:45:25.6870517Z -use std::sync::Arc;
2025-12-16T13:45:25.6870907Z -use tracing::{info, error, debug};
2025-12-16T13:45:25.6871358Z  use crate::tunnel::TunnelClient;
2025-12-16T13:45:25.6871762Z +use std::sync::Arc;
2025-12-16T13:45:25.6872243Z +use tokio::io::{AsyncReadExt, AsyncWriteExt};
2025-12-16T13:45:25.6872780Z +use tokio::net::{TcpListener, TcpStream};
2025-12-16T13:45:25.6873288Z +use tracing::{debug, error, info};
2025-12-16T13:45:25.6873667Z  
2025-12-16T13:45:25.6873952Z  /// SOCKS5 versions
2025-12-16T13:45:25.6874228Z  const SOCKS_VERSION: u8 = 0x05;
2025-12-16T13:45:25.6874680Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/socks5.rs:42:
2025-12-16T13:45:25.6875094Z          }
2025-12-16T13:45:25.6875253Z      }
2025-12-16T13:45:25.6875409Z  
2025-12-16T13:45:25.6875851Z -    pub async fn run(&self, listener: TcpListener) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.6876311Z +    pub async fn run(
2025-12-16T13:45:25.6876516Z +        &self,
2025-12-16T13:45:25.6876725Z +        listener: TcpListener,
2025-12-16T13:45:25.6877037Z +    ) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.6877325Z          loop {
2025-12-16T13:45:25.6877563Z              let (stream, addr) = listener.accept().await?;
2025-12-16T13:45:25.6877899Z              debug!("New SOCKS5 connection from {}", addr);
2025-12-16T13:45:25.6878406Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/stream_manager.rs:2:
2025-12-16T13:45:25.6878823Z  //!
2025-12-16T13:45:25.6879349Z  //! Each stream corresponds to one TCP connection being proxied.
2025-12-16T13:45:25.6879652Z  
2025-12-16T13:45:25.6879832Z +use bytes::Bytes;
2025-12-16T13:45:25.6880046Z  use std::collections::HashMap;
2025-12-16T13:45:25.6880289Z  use tokio::sync::mpsc;
2025-12-16T13:45:25.6880493Z -use bytes::Bytes;
2025-12-16T13:45:25.6880710Z  use zks_tunnel_proto::StreamId;
2025-12-16T13:45:25.6880945Z  
2025-12-16T13:45:25.6881106Z  #[allow(dead_code)]
2025-12-16T13:45:25.6881548Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/stream_manager.rs:29:
2025-12-16T13:45:25.6882124Z      pub fn create_stream(&mut self, id: StreamId) -> mpsc::Receiver<Bytes> {
2025-12-16T13:45:25.6882505Z          let (tx, rx) = mpsc::channel(100);
2025-12-16T13:45:25.6882827Z          let (_out_tx, out_rx) = mpsc::channel::<Bytes>(100);
2025-12-16T13:45:25.6883103Z -        
2025-12-16T13:45:25.6883260Z +
2025-12-16T13:45:25.6883515Z          self.streams.insert(id, StreamState { tx, rx: out_rx });
2025-12-16T13:45:25.6883812Z          rx
2025-12-16T13:45:25.6883969Z      }
2025-12-16T13:45:25.6884371Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/stream_manager.rs:46:
2025-12-16T13:45:25.6884790Z          }
2025-12-16T13:45:25.6884952Z      }
2025-12-16T13:45:25.6885101Z  }
2025-12-16T13:45:25.6885250Z -
2025-12-16T13:45:25.6885404Z  
2025-12-16T13:45:25.6885773Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:6:
2025-12-16T13:45:25.6886212Z  //! - Connection keepalive via ping/pong
2025-12-16T13:45:25.6886505Z  //! - Memory-efficient buffer management
2025-12-16T13:45:25.6886734Z  
2025-12-16T13:45:25.6886907Z -use tokio::net::TcpStream;
2025-12-16T13:45:25.6887155Z -use tokio::sync::{mpsc, Mutex};
2025-12-16T13:45:25.6887588Z -use tokio_tungstenite::{connect_async, tungstenite::Message, WebSocketStream, MaybeTlsStream};
2025-12-16T13:45:25.6888004Z +use bytes::Bytes;
2025-12-16T13:45:25.6888211Z  use futures::{SinkExt, StreamExt};
2025-12-16T13:45:25.6888463Z  use std::collections::HashMap;
2025-12-16T13:45:25.6888682Z -use std::sync::Arc;
2025-12-16T13:45:25.6889117Z  use std::sync::atomic::{AtomicU32, Ordering};
2025-12-16T13:45:25.6889427Z -use tracing::{info, error, debug, warn};
2025-12-16T13:45:25.6889733Z -use zks_tunnel_proto::{TunnelMessage, StreamId};
2025-12-16T13:45:25.6890008Z -use bytes::Bytes;
2025-12-16T13:45:25.6890482Z +use std::sync::Arc;
2025-12-16T13:45:25.6890728Z  use tokio::io::{AsyncReadExt, AsyncWriteExt};
2025-12-16T13:45:25.6890997Z +use tokio::net::TcpStream;
2025-12-16T13:45:25.6891226Z +use tokio::sync::{mpsc, Mutex};
2025-12-16T13:45:25.6891652Z +use tokio_tungstenite::{connect_async, tungstenite::Message, MaybeTlsStream, WebSocketStream};
2025-12-16T13:45:25.6892098Z +use tracing::{debug, error, info, warn};
2025-12-16T13:45:25.6892401Z +use zks_tunnel_proto::{StreamId, TunnelMessage};
2025-12-16T13:45:25.6892658Z  
2025-12-16T13:45:25.6892816Z  #[allow(dead_code)]
2025-12-16T13:45:25.6893137Z  type WsStream = WebSocketStream<MaybeTlsStream<tokio::net::TcpStream>>;
2025-12-16T13:45:25.6893679Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:40:
2025-12-16T13:45:25.6894177Z      /// Connect to the ZKS-Tunnel Worker with automatic reconnection
2025-12-16T13:45:25.6894677Z      pub async fn connect_ws(url: &str) -> Result<Self, Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.6895152Z          info!("Connecting to ZKS-Tunnel Worker at {}", url);
2025-12-16T13:45:25.6895426Z -        
2025-12-16T13:45:25.6895582Z +
2025-12-16T13:45:25.6895816Z          let (ws_stream, response) = connect_async(url).await?;
2025-12-16T13:45:25.6896195Z          info!("WebSocket connected (status: {})", response.status());
2025-12-16T13:45:25.6896485Z  
2025-12-16T13:45:25.6896854Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:50:
2025-12-16T13:45:25.6897373Z          let (sender, mut receiver) = mpsc::channel::<TunnelMessage>(256);
2025-12-16T13:45:25.6897680Z  
2025-12-16T13:45:25.6897924Z          // Streams map - shared between reader task and main client
2025-12-16T13:45:25.6898313Z -        let streams: Arc<Mutex<HashMap<StreamId, StreamState>>> = 
2025-12-16T13:45:25.6898699Z +        let streams: Arc<Mutex<HashMap<StreamId, StreamState>>> =
2025-12-16T13:45:25.6899213Z              Arc::new(Mutex::new(HashMap::new()));
2025-12-16T13:45:25.6899527Z          let streams_clone = streams.clone();
2025-12-16T13:45:25.6899759Z  
2025-12-16T13:45:25.6900113Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:89:
2025-12-16T13:45:25.6900557Z                                      streams.remove(&stream_id);
2025-12-16T13:45:25.6900889Z                                      debug!("Stream {} closed by server", stream_id);
2025-12-16T13:45:25.6901184Z                                  }
2025-12-16T13:45:25.6901517Z -                                TunnelMessage::ErrorReply { stream_id, code, message } => {
2025-12-16T13:45:25.6901956Z -                                    error!("Stream {} error: {} (code {})", stream_id, message, code);
2025-12-16T13:45:25.6902332Z +                                TunnelMessage::ErrorReply {
2025-12-16T13:45:25.6902627Z +                                    stream_id,
2025-12-16T13:45:25.6902889Z +                                    code,
2025-12-16T13:45:25.6903148Z +                                    message,
2025-12-16T13:45:25.6903397Z +                                } => {
2025-12-16T13:45:25.6903634Z +                                    error!(
2025-12-16T13:45:25.6903910Z +                                        "Stream {} error: {} (code {})",
2025-12-16T13:45:25.6904209Z +                                        stream_id, message, code
2025-12-16T13:45:25.6904478Z +                                    );
2025-12-16T13:45:25.6904766Z                                      let mut streams = streams_clone.lock().await;
2025-12-16T13:45:25.6905089Z                                      streams.remove(&stream_id);
2025-12-16T13:45:25.6905356Z                                  }
2025-12-16T13:45:25.6905769Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:170:
2025-12-16T13:45:25.6906245Z          let local_to_tunnel = tokio::spawn(async move {
2025-12-16T13:45:25.6906561Z              // Use a reasonably sized buffer for efficiency
2025-12-16T13:45:25.6907121Z              let mut buf = vec![0u8; 16384]; // 16KB buffer
2025-12-16T13:45:25.6907371Z -            
2025-12-16T13:45:25.6907545Z +
2025-12-16T13:45:25.6907696Z              loop {
2025-12-16T13:45:25.6907921Z                  match read_half.read(&mut buf).await {
2025-12-16T13:45:25.6908186Z                      Ok(0) => {
2025-12-16T13:45:25.6908581Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:221:
2025-12-16T13:45:25.6909166Z          }
2025-12-16T13:45:25.6909325Z  
2025-12-16T13:45:25.6909509Z          // Send close command to server
2025-12-16T13:45:25.6909878Z -        let _ = sender_for_close.send(TunnelMessage::Close { stream_id }).await;
2025-12-16T13:45:25.6910221Z +        let _ = sender_for_close
2025-12-16T13:45:25.6910486Z +            .send(TunnelMessage::Close { stream_id })
2025-12-16T13:45:25.6910744Z +            .await;
2025-12-16T13:45:25.6910916Z  
2025-12-16T13:45:25.6911081Z          // Clean up stream
2025-12-16T13:45:25.6911299Z          {
2025-12-16T13:45:25.6949703Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:19:
2025-12-16T13:45:25.6950716Z  
2025-12-16T13:45:25.6951077Z  #[cfg(feature = "vpn")]
2025-12-16T13:45:25.6951519Z  mod implementation {
2025-12-16T13:45:25.6952009Z +    use futures::{SinkExt, StreamExt};
2025-12-16T13:45:25.6952548Z      use std::net::Ipv4Addr;
2025-12-16T13:45:25.6953025Z -    use std::sync::Arc;
2025-12-16T13:45:25.6953564Z -    use std::sync::atomic::{AtomicBool, Ordering};
2025-12-16T13:45:25.6954168Z      use std::process::Command;
2025-12-16T13:45:25.6954646Z -    use tokio::sync::Mutex;
2025-12-16T13:45:25.6955167Z +    use std::sync::atomic::{AtomicBool, Ordering};
2025-12-16T13:45:25.6955617Z +    use std::sync::Arc;
2025-12-16T13:45:25.6956070Z      use tokio::io::{AsyncReadExt, AsyncWriteExt}; // Still needed for tunnel stream
2025-12-16T13:45:25.6956581Z -    use tracing::{info, error, debug};
2025-12-16T13:45:25.6957041Z -    use futures::{StreamExt, SinkExt}; // Needed for Stack stream/sink
2025-12-16T13:45:25.6957368Z -    
2025-12-16T13:45:25.6957556Z +    use tokio::sync::Mutex;
2025-12-16T13:45:25.6957866Z +    use tracing::{debug, error, info}; // Needed for Stack stream/sink
2025-12-16T13:45:25.6958169Z +
2025-12-16T13:45:25.6958351Z      use crate::tunnel::TunnelClient;
2025-12-16T13:45:25.6958626Z      use zks_tunnel_proto::TunnelMessage;
2025-12-16T13:45:25.6958859Z -    
2025-12-16T13:45:25.6959275Z +
2025-12-16T13:45:25.6959476Z      // Import netstack-smoltcp types
2025-12-16T13:45:25.6959738Z      #[cfg(feature = "vpn")]
2025-12-16T13:45:25.6959985Z      use netstack_smoltcp::StackBuilder;
2025-12-16T13:45:25.6960424Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:37:
2025-12-16T13:45:25.6960811Z -    
2025-12-16T13:45:25.6960958Z +
2025-12-16T13:45:25.6961129Z      #[cfg(feature = "vpn")]
2025-12-16T13:45:25.6961349Z      use reqwest::Client;
2025-12-16T13:45:25.6961553Z -    
2025-12-16T13:45:25.6961707Z +
2025-12-16T13:45:25.6961877Z      /// VPN configuration
2025-12-16T13:45:25.6962095Z      #[derive(Debug, Clone)]
2025-12-16T13:45:25.6962313Z      #[allow(dead_code)]
2025-12-16T13:45:25.6962695Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:55:
2025-12-16T13:45:25.6963163Z          /// Enable kill switch (block traffic if disconnected)
2025-12-16T13:45:25.6963470Z          pub kill_switch: bool,
2025-12-16T13:45:25.6963676Z      }
2025-12-16T13:45:25.6963837Z -    
2025-12-16T13:45:25.6963983Z +
2025-12-16T13:45:25.6964163Z      impl Default for VpnConfig {
2025-12-16T13:45:25.6964401Z          fn default() -> Self {
2025-12-16T13:45:25.6964612Z              Self {
2025-12-16T13:45:25.6965086Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:68:
2025-12-16T13:45:25.6965750Z              }
2025-12-16T13:45:25.6966009Z          }
2025-12-16T13:45:25.6966174Z      }
2025-12-16T13:45:25.6966524Z -    
2025-12-16T13:45:25.6966784Z +
2025-12-16T13:45:25.6966954Z      /// VPN connection state
2025-12-16T13:45:25.6967214Z      #[derive(Debug, Clone, Copy, PartialEq, Eq)]
2025-12-16T13:45:25.6967504Z      pub enum VpnState {
2025-12-16T13:45:25.6967884Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:77:
2025-12-16T13:45:25.6968271Z          Connected,
2025-12-16T13:45:25.6968457Z          Disconnecting,
2025-12-16T13:45:25.6968647Z      }
2025-12-16T13:45:25.6968793Z -    
2025-12-16T13:45:25.6969068Z +
2025-12-16T13:45:25.6969264Z      /// Statistics for the VPN connection
2025-12-16T13:45:25.6969522Z      #[derive(Debug, Default)]
2025-12-16T13:45:25.6969750Z      pub struct VpnStats {
2025-12-16T13:45:25.6970137Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:87:
2025-12-16T13:45:25.6970548Z          pub packets_received: u64,
2025-12-16T13:45:25.6970798Z          pub connections_opened: u64,
2025-12-16T13:45:25.6971032Z      }
2025-12-16T13:45:25.6971186Z -    
2025-12-16T13:45:25.6971335Z +
2025-12-16T13:45:25.6971561Z      /// System-Wide VPN controller with full TUN integration
2025-12-16T13:45:25.6971872Z      pub struct VpnController {
2025-12-16T13:45:25.6972121Z          config: VpnConfig,
2025-12-16T13:45:25.6972504Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:99:
2025-12-16T13:45:25.6972908Z          #[cfg(target_os = "windows")]
2025-12-16T13:45:25.6973194Z          original_fw_policy: Arc<Mutex<Option<String>>>,
2025-12-16T13:45:25.6973452Z      }
2025-12-16T13:45:25.6973597Z -    
2025-12-16T13:45:25.6973749Z +
2025-12-16T13:45:25.6973912Z      impl VpnController {
2025-12-16T13:45:25.6974151Z          /// Create a new VPN controller
2025-12-16T13:45:25.6974494Z          pub fn new(tunnel: Arc<TunnelClient>, config: VpnConfig) -> Self {
2025-12-16T13:45:25.6974998Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:117:
2025-12-16T13:45:25.6975477Z                  original_fw_policy: Arc::new(Mutex::new(None)),
2025-12-16T13:45:25.6975753Z              }
2025-12-16T13:45:25.6975921Z          }
2025-12-16T13:45:25.6976075Z -        
2025-12-16T13:45:25.6976229Z +
2025-12-16T13:45:25.6976470Z          /// Start the VPN (create TUN device and begin routing traffic)
2025-12-16T13:45:25.6976930Z          pub async fn start(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.6977323Z              let mut state = self.state.lock().await;
2025-12-16T13:45:25.6977765Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:126:
2025-12-16T13:45:25.6978154Z              }
2025-12-16T13:45:25.6978358Z              *state = VpnState::Connecting;
2025-12-16T13:45:25.6978607Z              drop(state);
2025-12-16T13:45:25.6978799Z -            
2025-12-16T13:45:25.6979068Z +
2025-12-16T13:45:25.6979265Z              info!("Starting system-wide VPN...");
2025-12-16T13:45:25.6979579Z              info!("  Device: {}", self.config.device_name);
2025-12-16T13:45:25.6979970Z              info!("  Address: {}/{}", self.config.address, self.config.netmask);
2025-12-16T13:45:25.6980467Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:133:
2025-12-16T13:45:25.6980889Z              info!("  MTU: {}", self.config.mtu);
2025-12-16T13:45:25.6981124Z -            
2025-12-16T13:45:25.6981290Z +
2025-12-16T13:45:25.6981509Z              self.running.store(true, Ordering::SeqCst);
2025-12-16T13:45:25.6981768Z -            
2025-12-16T13:45:25.6981923Z +
2025-12-16T13:45:25.6982119Z              // Optional: enable OS-level kill switch
2025-12-16T13:45:25.6982399Z              if self.config.kill_switch {
2025-12-16T13:45:25.6982707Z                  if let Err(e) = self.enable_kill_switch().await {
2025-12-16T13:45:25.6983164Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:143:
2025-12-16T13:45:25.6983538Z  
2025-12-16T13:45:25.6983890Z              // Create TUN device and start packet processing
2025-12-16T13:45:25.6984289Z              self.run_tun_loop().await?;
2025-12-16T13:45:25.6984521Z -            
2025-12-16T13:45:25.6984673Z +
2025-12-16T13:45:25.6984870Z              let mut state = self.state.lock().await;
2025-12-16T13:45:25.6985154Z              *state = VpnState::Connected;
2025-12-16T13:45:25.6985390Z -            
2025-12-16T13:45:25.6985549Z +
2025-12-16T13:45:25.6985839Z              info!("✅ System-wide VPN is now active!");
2025-12-16T13:45:25.6986186Z              info!("   All traffic is being routed through the tunnel.");
2025-12-16T13:45:25.6986471Z -            
2025-12-16T13:45:25.6986631Z +
2025-12-16T13:45:25.6986780Z              Ok(())
2025-12-16T13:45:25.6986966Z          }
2025-12-16T13:45:25.6987120Z -        
2025-12-16T13:45:25.6987274Z +
2025-12-16T13:45:25.6987429Z          /// Stop the VPN
2025-12-16T13:45:25.6987778Z          pub async fn stop(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.6988455Z              let mut state = self.state.lock().await;
2025-12-16T13:45:25.6989347Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:161:
2025-12-16T13:45:25.6990029Z              }
2025-12-16T13:45:25.6990380Z              *state = VpnState::Disconnecting;
2025-12-16T13:45:25.6990803Z              drop(state);
2025-12-16T13:45:25.6991115Z -            
2025-12-16T13:45:25.6991386Z +
2025-12-16T13:45:25.6991614Z              info!("Stopping system-wide VPN...");
2025-12-16T13:45:25.6991875Z -            
2025-12-16T13:45:25.6992036Z +
2025-12-16T13:45:25.6992211Z              // Signal the TUN loop to stop
2025-12-16T13:45:25.6992514Z              self.running.store(false, Ordering::SeqCst);
2025-12-16T13:45:25.6992769Z  
2025-12-16T13:45:25.6993108Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:173:
2025-12-16T13:45:25.6993557Z                      error!("Failed to disable kill switch: {}", e);
2025-12-16T13:45:25.6993847Z                  }
2025-12-16T13:45:25.6994065Z              }
2025-12-16T13:45:25.6994237Z -            
2025-12-16T13:45:25.6994392Z +
2025-12-16T13:45:25.6994587Z              let mut state = self.state.lock().await;
2025-12-16T13:45:25.6994880Z              *state = VpnState::Disconnected;
2025-12-16T13:45:25.6995114Z -            
2025-12-16T13:45:25.6995279Z +
2025-12-16T13:45:25.6995439Z              // Print stats
2025-12-16T13:45:25.6995678Z              let stats = self.stats.lock().await;
2025-12-16T13:45:25.6995943Z              info!("VPN Statistics:");
2025-12-16T13:45:25.6996359Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:185:
2025-12-16T13:45:25.6996800Z              info!("  Packets sent: {}", stats.packets_sent);
2025-12-16T13:45:25.6997146Z              info!("  Packets received: {}", stats.packets_received);
2025-12-16T13:45:25.6997527Z              info!("  Connections opened: {}", stats.connections_opened);
2025-12-16T13:45:25.6997822Z -            
2025-12-16T13:45:25.6997988Z +
2025-12-16T13:45:25.6998229Z              info!("✅ System-wide VPN stopped.");
2025-12-16T13:45:25.6998474Z -            
2025-12-16T13:45:25.6998627Z +
2025-12-16T13:45:25.6998776Z              Ok(())
2025-12-16T13:45:25.6999142Z          }
2025-12-16T13:45:25.6999338Z -        
2025-12-16T13:45:25.6999493Z +
2025-12-16T13:45:25.6999747Z          /// Main TUN device loop - creates device and processes packets
2025-12-16T13:45:25.7000222Z          async fn run_tun_loop(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7000600Z              info!("Creating TUN device...");
2025-12-16T13:45:25.7001035Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:197:
2025-12-16T13:45:25.7001420Z -            
2025-12-16T13:45:25.7001579Z +
2025-12-16T13:45:25.7001762Z              // Use tun-rs DeviceBuilder API (v2)
2025-12-16T13:45:25.7002124Z              #[cfg(any(target_os = "linux", target_os = "macos", target_os = "windows"))]
2025-12-16T13:45:25.7002782Z              {
2025-12-16T13:45:25.7003142Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:202:
2025-12-16T13:45:25.7003646Z                      .ipv4(self.config.address, 24, None) // Hardcoded /24 for testing
2025-12-16T13:45:25.7003993Z                      .mtu(self.config.mtu)
2025-12-16T13:45:25.7004252Z                      .build_async()?;
2025-12-16T13:45:25.7004470Z -                
2025-12-16T13:45:25.7004742Z +
2025-12-16T13:45:25.7005052Z                  // Run the netstack with the device
2025-12-16T13:45:25.7005520Z                  self.run_netstack(device).await?;
2025-12-16T13:45:25.7005859Z -                
2025-12-16T13:45:25.7006031Z +
2025-12-16T13:45:25.7006190Z                  Ok(())
2025-12-16T13:45:25.7006370Z              }
2025-12-16T13:45:25.7006536Z -            
2025-12-16T13:45:25.7006694Z +
2025-12-16T13:45:25.7006985Z              #[cfg(not(any(target_os = "linux", target_os = "macos", target_os = "windows")))]
2025-12-16T13:45:25.7007345Z              {
2025-12-16T13:45:25.7007612Z                  Err("TUN devices are not supported on this platform".into())
2025-12-16T13:45:25.7008096Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:215:
2025-12-16T13:45:25.7008488Z              }
2025-12-16T13:45:25.7008646Z          }
2025-12-16T13:45:25.7008810Z -        
2025-12-16T13:45:25.7009083Z +
2025-12-16T13:45:25.7009317Z          /// Run the userspace network stack (netstack-smoltcp)
2025-12-16T13:45:25.7009861Z -        async fn run_netstack(&self, device: tun_rs::AsyncDevice) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7010311Z +        async fn run_netstack(
2025-12-16T13:45:25.7010521Z +            &self,
2025-12-16T13:45:25.7010723Z +            device: tun_rs::AsyncDevice,
2025-12-16T13:45:25.7011042Z +        ) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7011391Z              info!("Initializing userspace TCP/IP stack...");
2025-12-16T13:45:25.7011666Z -            
2025-12-16T13:45:25.7011828Z +
2025-12-16T13:45:25.7011988Z              // Create the stack
2025-12-16T13:45:25.7012336Z              // StackBuilder::build() returns (Stack, Runner, UdpSocket, TcpListener)
2025-12-16T13:45:25.7012840Z              let (stack, runner_opt, udp_socket_opt, tcp_listener_opt) = StackBuilder::default()
2025-12-16T13:45:25.7013382Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:230:
2025-12-16T13:45:25.7013827Z              let runner = runner_opt.ok_or("Runner missing")?;
2025-12-16T13:45:25.7014187Z              let udp_socket = udp_socket_opt.ok_or("UDP socket missing")?;
2025-12-16T13:45:25.7014593Z              let tcp_listener = tcp_listener_opt.ok_or("TCP listener missing")?;
2025-12-16T13:45:25.7014899Z -            
2025-12-16T13:45:25.7015062Z +
2025-12-16T13:45:25.7015227Z              // Spawn stack runner
2025-12-16T13:45:25.7015481Z              tokio::spawn(async move {
2025-12-16T13:45:25.7015751Z                  if let Err(e) = runner.await {
2025-12-16T13:45:25.7016179Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:244:
2025-12-16T13:45:25.7016593Z              let stats = self.stats.clone();
2025-12-16T13:45:25.7016900Z              let http_client = self.http_client.clone();
2025-12-16T13:45:25.7017220Z              let dns_protection = self.config.dns_protection;
2025-12-16T13:45:25.7017491Z -            
2025-12-16T13:45:25.7017650Z +
2025-12-16T13:45:25.7017830Z              // Spawn TCP listener task
2025-12-16T13:45:25.7018117Z              let tcp_task = tokio::spawn(async move {
2025-12-16T13:45:25.7018408Z                  // Pin locally inside the async block
2025-12-16T13:45:25.7018839Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:251:
2025-12-16T13:45:25.7019361Z                  tokio::pin!(tcp_listener);
2025-12-16T13:45:25.7019748Z -                
2025-12-16T13:45:25.7020026Z +
2025-12-16T13:45:25.7020241Z                  while running.load(Ordering::SeqCst) {
2025-12-16T13:45:25.7020531Z                      match tcp_listener.next().await {
2025-12-16T13:45:25.7020839Z                          Some((stream, local_addr, remote_addr)) => {
2025-12-16T13:45:25.7021291Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:256:
2025-12-16T13:45:25.7021777Z                              debug!("New TCP connection: {} -> {}", remote_addr, local_addr);
2025-12-16T13:45:25.7022098Z -                            
2025-12-16T13:45:25.7022289Z +
2025-12-16T13:45:25.7022484Z                              let tunnel = tunnel.clone();
2025-12-16T13:45:25.7022763Z                              let stats = stats.clone();
2025-12-16T13:45:25.7023013Z -                            
2025-12-16T13:45:25.7023210Z +
2025-12-16T13:45:25.7023393Z                              // Spawn connection handler
2025-12-16T13:45:25.7023687Z                              tokio::spawn(async move {
2025-12-16T13:45:25.7023944Z                                  {
2025-12-16T13:45:25.7024337Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:264:
2025-12-16T13:45:25.7024763Z                                      let mut s = stats.lock().await;
2025-12-16T13:45:25.7025060Z                                      s.connections_opened += 1;
2025-12-16T13:45:25.7025318Z                                  }
2025-12-16T13:45:25.7025542Z -                                
2025-12-16T13:45:25.7025744Z +
2025-12-16T13:45:25.7025941Z                                  // Open tunnel stream to destination
2025-12-16T13:45:25.7026481Z                                  let dest_host: String = local_addr.to_string(); // Assuming SocketAddr
2025-12-16T13:45:25.7026862Z                                  let dest_port = local_addr.port();
2025-12-16T13:45:25.7027299Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:271:
2025-12-16T13:45:25.7027762Z -                                
2025-12-16T13:45:25.7027967Z +
2025-12-16T13:45:25.7028207Z                                  match tunnel.open_stream(&dest_host, dest_port).await {
2025-12-16T13:45:25.7028537Z                                      Ok((stream_id, rx)) => {
2025-12-16T13:45:25.7029008Z -                                        debug!("Tunnel stream {} opened for {}", stream_id, local_addr);
2025-12-16T13:45:25.7029350Z -                                        
2025-12-16T13:45:25.7029602Z +                                        debug!(
2025-12-16T13:45:25.7029886Z +                                            "Tunnel stream {} opened for {}",
2025-12-16T13:45:25.7030191Z +                                            stream_id, local_addr
2025-12-16T13:45:25.7030457Z +                                        );
2025-12-16T13:45:25.7030673Z +
2025-12-16T13:45:25.7030853Z                                          // Relay data
2025-12-16T13:45:25.7031220Z -                                        let (mut read_half, mut write_half) = tokio::io::split(stream);
2025-12-16T13:45:25.7031593Z +                                        let (mut read_half, mut write_half) =
2025-12-16T13:45:25.7031906Z +                                            tokio::io::split(stream);
2025-12-16T13:45:25.7032216Z                                          let tunnel_tx = tunnel.sender();
2025-12-16T13:45:25.7032497Z -                                        
2025-12-16T13:45:25.7032711Z +
2025-12-16T13:45:25.7032913Z                                          // Task 1: Netstack -> Tunnel
2025-12-16T13:45:25.7033206Z                                          let mut buf = vec![0u8; 16384];
2025-12-16T13:45:25.7033516Z                                          let tunnel_tx_clone = tunnel_tx.clone();
2025-12-16T13:45:25.7033965Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:283:
2025-12-16T13:45:25.7034407Z                                          let stats_clone = stats.clone();
2025-12-16T13:45:25.7034922Z -                                        
2025-12-16T13:45:25.7035150Z +
2025-12-16T13:45:25.7035356Z                                          let ns_to_tunnel = async move {
2025-12-16T13:45:25.7035639Z                                              loop {
2025-12-16T13:45:25.7035943Z                                                  match read_half.read(&mut buf).await {
2025-12-16T13:45:25.7036392Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:289:
2025-12-16T13:45:25.7036823Z                                                      Ok(n) => {
2025-12-16T13:45:25.7037137Z                                                          let msg = TunnelMessage::Data {
2025-12-16T13:45:25.7037446Z                                                              stream_id,
2025-12-16T13:45:25.7037907Z -                                                            payload: bytes::Bytes::copy_from_slice(&buf[..n]),
2025-12-16T13:45:25.7038566Z +                                                            payload: bytes::Bytes::copy_from_slice(
2025-12-16T13:45:25.7039261Z +                                                                &buf[..n],
2025-12-16T13:45:25.7039736Z +                                                            ),
2025-12-16T13:45:25.7040192Z                                                          };
2025-12-16T13:45:25.7040735Z -                                                        if tunnel_tx_clone.send(msg).await.is_err() {
2025-12-16T13:45:25.7041332Z +                                                        if tunnel_tx_clone.send(msg).await.is_err()
2025-12-16T13:45:25.7041850Z +                                                        {
2025-12-16T13:45:25.7042294Z                                                              break;
2025-12-16T13:45:25.7042745Z                                                          }
2025-12-16T13:45:25.7043040Z -                                                        
2025-12-16T13:45:25.7043297Z +
2025-12-16T13:45:25.7043530Z                                                          let mut s = stats_clone.lock().await;
2025-12-16T13:45:25.7043850Z                                                          s.bytes_sent += n as u64;
2025-12-16T13:45:25.7044135Z                                                      }
2025-12-16T13:45:25.7044560Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:302:
2025-12-16T13:45:25.7044977Z                                                  }
2025-12-16T13:45:25.7045227Z                                              }
2025-12-16T13:45:25.7045478Z                                          };
2025-12-16T13:45:25.7045723Z -                                        
2025-12-16T13:45:25.7045937Z +
2025-12-16T13:45:25.7046138Z                                          // Task 2: Tunnel -> Netstack
2025-12-16T13:45:25.7046426Z                                          let mut rx = rx;
2025-12-16T13:45:25.7046721Z                                          let stats_clone2 = stats.clone();
2025-12-16T13:45:25.7047177Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:315:
2025-12-16T13:45:25.7047631Z                                                  s.bytes_received += data.len() as u64;
2025-12-16T13:45:25.7047920Z                                              }
2025-12-16T13:45:25.7048160Z                                          };
2025-12-16T13:45:25.7048402Z -                                        
2025-12-16T13:45:25.7048617Z +
2025-12-16T13:45:25.7048814Z                                          // Run both directions
2025-12-16T13:45:25.7049360Z                                          let _ = tokio::join!(ns_to_tunnel, tunnel_to_ns);
2025-12-16T13:45:25.7049667Z -                                        
2025-12-16T13:45:25.7049885Z +
2025-12-16T13:45:25.7050077Z                                          // Close tunnel stream
2025-12-16T13:45:25.7050454Z -                                        let _ = tunnel_tx.send(TunnelMessage::Close { stream_id }).await;
2025-12-16T13:45:25.7051077Z +                                        let _ = tunnel_tx
2025-12-16T13:45:25.7051398Z +                                            .send(TunnelMessage::Close { stream_id })
2025-12-16T13:45:25.7051694Z +                                            .await;
2025-12-16T13:45:25.7051951Z                                      }
2025-12-16T13:45:25.7052196Z                                      Err(e) => {
2025-12-16T13:45:25.7052505Z                                          error!("Failed to open tunnel stream: {}", e);
2025-12-16T13:45:25.7052965Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:335:
2025-12-16T13:45:25.7053352Z                      }
2025-12-16T13:45:25.7053540Z                  }
2025-12-16T13:45:25.7053708Z              });
2025-12-16T13:45:25.7053880Z -            
2025-12-16T13:45:25.7054040Z +
2025-12-16T13:45:25.7054227Z              // Spawn UDP handler (for DNS)
2025-12-16T13:45:25.7054646Z              // Note: netstack-smoltcp v0.2.0 UdpSocket doesn't expose standard Stream/Sink traits
2025-12-16T13:45:25.7055114Z              // For now, we keep the socket alive but don't actively process UDP
2025-12-16T13:45:25.7055605Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:342:
2025-12-16T13:45:25.7056113Z              // DNS will work through the system resolver or future DoH implementation
2025-12-16T13:45:25.7056483Z              let _dns_protection = dns_protection;
2025-12-16T13:45:25.7056763Z              let _http_client = http_client;
2025-12-16T13:45:25.7057000Z -            
2025-12-16T13:45:25.7057159Z +
2025-12-16T13:45:25.7057380Z              let udp_task = tokio::spawn(async move {
2025-12-16T13:45:25.7057737Z                  // Keep UDP socket alive - it's required for the stack to function
2025-12-16T13:45:25.7058156Z                  // In future versions, we can implement UDP tunneling via worker
2025-12-16T13:45:25.7058653Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:352:
2025-12-16T13:45:25.7059215Z                  // Ensure socket is kept alive until task ends
2025-12-16T13:45:25.7059505Z                  drop(udp_socket);
2025-12-16T13:45:25.7059723Z              });
2025-12-16T13:45:25.7059898Z -            
2025-12-16T13:45:25.7060058Z +
2025-12-16T13:45:25.7060253Z              // Bridge TUN device and Netstack
2025-12-16T13:45:25.7060529Z              let device = Arc::new(device);
2025-12-16T13:45:25.7060796Z              let device_reader = device.clone();
2025-12-16T13:45:25.7061223Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:359:
2025-12-16T13:45:25.7061640Z              let device_writer = device.clone();
2025-12-16T13:45:25.7061881Z -            
2025-12-16T13:45:25.7062041Z +
2025-12-16T13:45:25.7062258Z              // Stack implements Stream and Sink (of packets)
2025-12-16T13:45:25.7062589Z              // We split it into sink (writer) and stream (reader)
2025-12-16T13:45:25.7063160Z              let (mut stack_sink, mut stack_stream) = stack.split();
2025-12-16T13:45:25.7063963Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:364:
2025-12-16T13:45:25.7064634Z -            
2025-12-16T13:45:25.7064911Z +
2025-12-16T13:45:25.7065164Z              // TUN -> Netstack
2025-12-16T13:45:25.7065568Z              let tun_to_ns = tokio::spawn(async move {
2025-12-16T13:45:25.7065859Z                  let mut buf = vec![0u8; 1500];
2025-12-16T13:45:25.7066281Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:382:
2025-12-16T13:45:25.7066666Z                      }
2025-12-16T13:45:25.7066854Z                  }
2025-12-16T13:45:25.7067025Z              });
2025-12-16T13:45:25.7067199Z -            
2025-12-16T13:45:25.7067365Z +
2025-12-16T13:45:25.7067532Z              // Netstack -> TUN
2025-12-16T13:45:25.7067795Z              let ns_to_tun = tokio::spawn(async move {
2025-12-16T13:45:25.7069123Z                  while let Some(packet_result) = stack_stream.next().await {
2025-12-16T13:45:25.7069981Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:401:
2025-12-16T13:45:25.7070428Z                      }
2025-12-16T13:45:25.7070621Z                  }
2025-12-16T13:45:25.7070799Z              });
2025-12-16T13:45:25.7070973Z -            
2025-12-16T13:45:25.7071138Z +
2025-12-16T13:45:25.7071315Z              // Wait for bridge tasks
2025-12-16T13:45:25.7071660Z              let _ = tokio::join!(tun_to_ns, ns_to_tun, tcp_task, udp_task);
2025-12-16T13:45:25.7071955Z -            
2025-12-16T13:45:25.7072120Z +
2025-12-16T13:45:25.7072269Z              Ok(())
2025-12-16T13:45:25.7072446Z          }
2025-12-16T13:45:25.7072598Z  
2025-12-16T13:45:25.7072950Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:426:
2025-12-16T13:45:25.7073332Z  
2025-12-16T13:45:25.7073559Z                  // Set default outbound to block for current profile
2025-12-16T13:45:25.7073908Z                  let _ = Command::new("netsh")
2025-12-16T13:45:25.7074349Z -                    .args(["advfirewall", "set", "currentprofile", "firewallpolicy", "blockinbound,blockoutbound"])
2025-12-16T13:45:25.7074767Z +                    .args([
2025-12-16T13:45:25.7074989Z +                        "advfirewall",
2025-12-16T13:45:25.7075230Z +                        "set",
2025-12-16T13:45:25.7075459Z +                        "currentprofile",
2025-12-16T13:45:25.7075714Z +                        "firewallpolicy",
2025-12-16T13:45:25.7075983Z +                        "blockinbound,blockoutbound",
2025-12-16T13:45:25.7076245Z +                    ])
2025-12-16T13:45:25.7076447Z                      .status()?;
2025-12-16T13:45:25.7076651Z  
2025-12-16T13:45:25.7076899Z                  // Allow this executable to go out so the tunnel can connect
2025-12-16T13:45:25.7077391Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:434:
2025-12-16T13:45:25.7077864Z                  let exe_str = exe.to_string_lossy().to_string();
2025-12-16T13:45:25.7078171Z                  let _ = Command::new("netsh")
2025-12-16T13:45:25.7078416Z                      .args([
2025-12-16T13:45:25.7078672Z -                        "advfirewall", "firewall", "add", "rule",
2025-12-16T13:45:25.7079238Z -                        "name=ZKS VPN Allow", "dir=out", "action=allow", "program=",
2025-12-16T13:45:25.7079571Z +                        "advfirewall",
2025-12-16T13:45:25.7079816Z +                        "firewall",
2025-12-16T13:45:25.7080052Z +                        "add",
2025-12-16T13:45:25.7080261Z +                        "rule",
2025-12-16T13:45:25.7080499Z +                        "name=ZKS VPN Allow",
2025-12-16T13:45:25.7080743Z +                        "dir=out",
2025-12-16T13:45:25.7080983Z +                        "action=allow",
2025-12-16T13:45:25.7081220Z +                        "program=",
2025-12-16T13:45:25.7081457Z                      ])
2025-12-16T13:45:25.7081663Z                      .status();
2025-12-16T13:45:25.7082034Z                  // Note: The above approach to join args with program= may not include path with spaces.
2025-12-16T13:45:25.7082602Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:442:
2025-12-16T13:45:25.7083050Z                  // Use a single command string fallback for safety.
2025-12-16T13:45:25.7083367Z                  let _ = Command::new("netsh")
2025-12-16T13:45:25.7083607Z                      .args([
2025-12-16T13:45:25.7083864Z -                        "advfirewall", "firewall", "add", "rule",
2025-12-16T13:45:25.7084258Z -                        "name=ZKS VPN Allow", "dir=out", "action=allow", "enable=yes", "profile=any",
2025-12-16T13:45:25.7084611Z +                        "advfirewall",
2025-12-16T13:45:25.7084849Z +                        "firewall",
2025-12-16T13:45:25.7085068Z +                        "add",
2025-12-16T13:45:25.7085457Z +                        "rule",
2025-12-16T13:45:25.7085797Z +                        "name=ZKS VPN Allow",
2025-12-16T13:45:25.7086048Z +                        "dir=out",
2025-12-16T13:45:25.7086275Z +                        "action=allow",
2025-12-16T13:45:25.7086518Z +                        "enable=yes",
2025-12-16T13:45:25.7086760Z +                        "profile=any",
2025-12-16T13:45:25.7087026Z                          &format!("program={}", exe_str),
2025-12-16T13:45:25.7087276Z                      ])
2025-12-16T13:45:25.7087468Z                      .status()?;
2025-12-16T13:45:25.7087860Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:462:
2025-12-16T13:45:25.7088243Z          }
2025-12-16T13:45:25.7088402Z  
2025-12-16T13:45:25.7088645Z          /// Disable OS-level kill switch and restore firewall defaults
2025-12-16T13:45:25.7089353Z -        async fn disable_kill_switch(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7089786Z +        async fn disable_kill_switch(
2025-12-16T13:45:25.7090015Z +            &self,
2025-12-16T13:45:25.7090274Z +        ) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7090578Z              #[cfg(target_os = "windows")]
2025-12-16T13:45:25.7090817Z              {
2025-12-16T13:45:25.7091000Z                  use std::env;
2025-12-16T13:45:25.7091391Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:472:
2025-12-16T13:45:25.7091842Z                      let exe_str = exe.to_string_lossy().to_string();
2025-12-16T13:45:25.7092155Z                      let _ = Command::new("netsh")
2025-12-16T13:45:25.7092412Z                          .args([
2025-12-16T13:45:25.7092675Z -                            "advfirewall", "firewall", "delete", "rule",
2025-12-16T13:45:25.7092972Z +                            "advfirewall",
2025-12-16T13:45:25.7093219Z +                            "firewall",
2025-12-16T13:45:25.7093467Z +                            "delete",
2025-12-16T13:45:25.7093703Z +                            "rule",
2025-12-16T13:45:25.7093982Z                              "name=ZKS VPN Allow",
2025-12-16T13:45:25.7094261Z                              &format!("program={}", exe_str),
2025-12-16T13:45:25.7094522Z                          ])
2025-12-16T13:45:25.7094903Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:482:
2025-12-16T13:45:25.7095374Z                  // Attempt to restore original profile policy if captured
2025-12-16T13:45:25.7095794Z                  if let Some(snapshot) = self.original_fw_policy.lock().await.clone() {
2025-12-16T13:45:25.7096297Z                      // Heuristic: if snapshot contains "Outbound Policy\s+:\s+Allow" then set allowoutbound
2025-12-16T13:45:25.7096716Z -                    let allow_out = snapshot
2025-12-16T13:45:25.7096965Z -                        .lines()
2025-12-16T13:45:25.7097409Z -                        .any(|l| l.to_ascii_lowercase().contains("outbound policy") && l.to_ascii_lowercase().contains("allow"));
2025-12-16T13:45:25.7097905Z +                    let allow_out = snapshot.lines().any(|l| {
2025-12-16T13:45:25.7098240Z +                        l.to_ascii_lowercase().contains("outbound policy")
2025-12-16T13:45:25.7098594Z +                            && l.to_ascii_lowercase().contains("allow")
2025-12-16T13:45:25.7098857Z +                    });
2025-12-16T13:45:25.7099216Z  
2025-12-16T13:45:25.7099587Z -                    let policy = if allow_out { "allowinbound,allowoutbound" } else { "blockinbound,allowoutbound" };
2025-12-16T13:45:25.7100034Z +                    let policy = if allow_out {
2025-12-16T13:45:25.7100326Z +                        "allowinbound,allowoutbound"
2025-12-16T13:45:25.7100585Z +                    } else {
2025-12-16T13:45:25.7100823Z +                        "blockinbound,allowoutbound"
2025-12-16T13:45:25.7101066Z +                    };
2025-12-16T13:45:25.7101295Z                      let _ = Command::new("netsh")
2025-12-16T13:45:25.7101916Z -                        .args(["advfirewall", "set", "currentprofile", "firewallpolicy", policy])
2025-12-16T13:45:25.7102265Z +                        .args([
2025-12-16T13:45:25.7102495Z +                            "advfirewall",
2025-12-16T13:45:25.7102737Z +                            "set",
2025-12-16T13:45:25.7102983Z +                            "currentprofile",
2025-12-16T13:45:25.7103240Z +                            "firewallpolicy",
2025-12-16T13:45:25.7103488Z +                            policy,
2025-12-16T13:45:25.7103707Z +                        ])
2025-12-16T13:45:25.7103915Z                          .status();
2025-12-16T13:45:25.7104128Z                  } else {
2025-12-16T13:45:25.7104381Z                      // Fallback: set default back to allow outbounds
2025-12-16T13:45:25.7104833Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:495:
2025-12-16T13:45:25.7105261Z                      let _ = Command::new("netsh")
2025-12-16T13:45:25.7105716Z -                        .args(["advfirewall", "set", "currentprofile", "firewallpolicy", "blockinbound,allowoutbound"])
2025-12-16T13:45:25.7106119Z +                        .args([
2025-12-16T13:45:25.7106350Z +                            "advfirewall",
2025-12-16T13:45:25.7106583Z +                            "set",
2025-12-16T13:45:25.7106821Z +                            "currentprofile",
2025-12-16T13:45:25.7107073Z +                            "firewallpolicy",
2025-12-16T13:45:25.7107350Z +                            "blockinbound,allowoutbound",
2025-12-16T13:45:25.7107621Z +                        ])
2025-12-16T13:45:25.7107822Z                          .status();
2025-12-16T13:45:25.7108037Z                  }
2025-12-16T13:45:25.7108203Z  
2025-12-16T13:45:25.7108540Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:507:
2025-12-16T13:45:25.7109064Z  
2025-12-16T13:45:25.7109241Z              Ok(())
2025-12-16T13:45:25.7109432Z          }
2025-12-16T13:45:25.7109594Z -        
2025-12-16T13:45:25.7109747Z +
2025-12-16T13:45:25.7109954Z          /// Resolve DNS query via DoH (Cloudflare 1.1.1.1)
2025-12-16T13:45:25.7110368Z          /// Note: Currently unused - will be enabled when UDP handling is implemented
2025-12-16T13:45:25.7110733Z          #[allow(dead_code)]
2025-12-16T13:45:25.7111132Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:514:
2025-12-16T13:45:25.7111779Z -        async fn resolve_doh(client: &Client, query: &[u8]) -> Result<Vec<u8>, Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7112233Z +        async fn resolve_doh(
2025-12-16T13:45:25.7112454Z +            client: &Client,
2025-12-16T13:45:25.7112671Z +            query: &[u8],
2025-12-16T13:45:25.7112955Z +        ) -> Result<Vec<u8>, Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7113328Z              let url = "https://1.1.1.1/dns-query";
2025-12-16T13:45:25.7113599Z -            
2025-12-16T13:45:25.7113812Z -            let response = client.post(url)
2025-12-16T13:45:25.7114057Z +
2025-12-16T13:45:25.7114223Z +            let response = client
2025-12-16T13:45:25.7114457Z +                .post(url)
2025-12-16T13:45:25.7114721Z                  .header("Content-Type", "application/dns-message")
2025-12-16T13:45:25.7115056Z                  .header("Accept", "application/dns-message")
2025-12-16T13:45:25.7115335Z                  .body(query.to_vec())
2025-12-16T13:45:25.7115751Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:521:
2025-12-16T13:45:25.7116147Z                  .send()
2025-12-16T13:45:25.7116339Z                  .await?;
2025-12-16T13:45:25.7116531Z -                
2025-12-16T13:45:25.7116698Z +
2025-12-16T13:45:25.7116885Z              if !response.status().is_success() {
2025-12-16T13:45:25.7117253Z                  return Err(format!("DoH request failed: {}", response.status()).into());
2025-12-16T13:45:25.7117725Z              }
2025-12-16T13:45:25.7118226Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:527:
2025-12-16T13:45:25.7118616Z -            
2025-12-16T13:45:25.7118780Z +
2025-12-16T13:45:25.7119120Z              let bytes = response.bytes().await?;
2025-12-16T13:45:25.7119394Z              Ok(bytes.to_vec())
2025-12-16T13:45:25.7119599Z          }
2025-12-16T13:45:25.7119948Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:531:
2025-12-16T13:45:25.7120335Z -        
2025-12-16T13:45:25.7120495Z +
2025-12-16T13:45:25.7120662Z          /// Get current VPN state
2025-12-16T13:45:25.7120901Z          #[allow(dead_code)]
2025-12-16T13:45:25.7121142Z          pub async fn state(&self) -> VpnState {
2025-12-16T13:45:25.7121582Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:535:
2025-12-16T13:45:25.7121999Z              *self.state.lock().await
2025-12-16T13:45:25.7122220Z          }
2025-12-16T13:45:25.7122393Z -        
2025-12-16T13:45:25.7122550Z +
2025-12-16T13:45:25.7122729Z          /// Get current VPN statistics
2025-12-16T13:45:25.7122971Z          #[allow(dead_code)]
2025-12-16T13:45:25.7123214Z          pub async fn stats(&self) -> VpnStats {
2025-12-16T13:45:25.7123636Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:566:
2025-12-16T13:45:25.7124049Z          pub dns_protection: bool,
2025-12-16T13:45:25.7124294Z          pub kill_switch: bool,
2025-12-16T13:45:25.7124497Z      }
2025-12-16T13:45:25.7124653Z -    
2025-12-16T13:45:25.7124803Z +
2025-12-16T13:45:25.7124971Z      /// VPN state (stub)
2025-12-16T13:45:25.7125211Z      #[derive(Debug, Clone, Copy, PartialEq, Eq)]
2025-12-16T13:45:25.7125481Z      pub enum VpnState {
2025-12-16T13:45:25.7125855Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:573:
2025-12-16T13:45:25.7126252Z          Disconnected,
2025-12-16T13:45:25.7126434Z      }
2025-12-16T13:45:25.7126598Z -    
2025-12-16T13:45:25.7126758Z +
2025-12-16T13:45:25.7126961Z      /// VPN controller (stub - feature not enabled)
2025-12-16T13:45:25.7127251Z      pub struct VpnController;
2025-12-16T13:45:25.7127461Z -    
2025-12-16T13:45:25.7127610Z +
2025-12-16T13:45:25.7127769Z      impl VpnController {
2025-12-16T13:45:25.7128160Z -        pub fn new(_tunnel: std::sync::Arc<crate::tunnel::TunnelClient>, _config: VpnConfig) -> Self {
2025-12-16T13:45:25.7128544Z +        pub fn new(
2025-12-16T13:45:25.7128801Z +            _tunnel: std::sync::Arc<crate::tunnel::TunnelClient>,
2025-12-16T13:45:25.7129342Z +            _config: VpnConfig,
2025-12-16T13:45:25.7129567Z +        ) -> Self {
2025-12-16T13:45:25.7129744Z              Self
2025-12-16T13:45:25.7129917Z          }
2025-12-16T13:45:25.7130077Z -        
2025-12-16T13:45:25.7130227Z +
2025-12-16T13:45:25.7130528Z          pub async fn start(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7130987Z              Err("VPN feature is not enabled. Rebuild with --features vpn".into())
2025-12-16T13:45:25.7131331Z          }
2025-12-16T13:45:25.7131671Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:587:
2025-12-16T13:45:25.7132060Z -        
2025-12-16T13:45:25.7132208Z +
2025-12-16T13:45:25.7132500Z          pub async fn stop(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7132953Z              Err("VPN feature is not enabled. Rebuild with --features vpn".into())
2025-12-16T13:45:25.7133262Z          }
2025-12-16T13:45:25.7133604Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:591:
2025-12-16T13:45:25.7133980Z -        
2025-12-16T13:45:25.7134135Z +
2025-12-16T13:45:25.7134320Z          pub async fn state(&self) -> VpnState {
2025-12-16T13:45:25.7134600Z              VpnState::Disconnected
2025-12-16T13:45:25.7134821Z          }
2025-12-16T13:45:25.7135179Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/lib.rs:3:
2025-12-16T13:45:25.7135910Z  //! This crate defines the binary protocol for communication between
2025-12-16T13:45:25.7136245Z  //! the ZKS-Tunnel client and worker.
2025-12-16T13:45:25.7136477Z  
2025-12-16T13:45:25.7136626Z -mod message;
2025-12-16T13:45:25.7136798Z  mod error;
2025-12-16T13:45:25.7136959Z +mod message;
2025-12-16T13:45:25.7137121Z  
2025-12-16T13:45:25.7137285Z -pub use message::*;
2025-12-16T13:45:25.7137513Z  pub use error::*;
2025-12-16T13:45:25.7137707Z +pub use message::*;
2025-12-16T13:45:25.7137998Z  
2025-12-16T13:45:25.7138441Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:68:
2025-12-16T13:45:25.7139181Z          port: u16,
2025-12-16T13:45:25.7139465Z      },
2025-12-16T13:45:25.7139761Z      /// Data payload for a stream (TCP)
2025-12-16T13:45:25.7140080Z -    Data {
2025-12-16T13:45:25.7140433Z -        stream_id: StreamId,
2025-12-16T13:45:25.7140718Z -        payload: Bytes,
2025-12-16T13:45:25.7141009Z -    },
2025-12-16T13:45:25.7141351Z +    Data { stream_id: StreamId, payload: Bytes },
2025-12-16T13:45:25.7141748Z      /// Close a stream
2025-12-16T13:45:25.7142054Z -    Close {
2025-12-16T13:45:25.7142365Z -        stream_id: StreamId,
2025-12-16T13:45:25.7142665Z -    },
2025-12-16T13:45:25.7142885Z +    Close { stream_id: StreamId },
2025-12-16T13:45:25.7153917Z      /// Error on a stream
2025-12-16T13:45:25.7154250Z      ErrorReply {
2025-12-16T13:45:25.7154462Z          stream_id: StreamId,
2025-12-16T13:45:25.7154908Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:131:
2025-12-16T13:45:25.7155403Z          let mut buf = BytesMut::with_capacity(256);
2025-12-16T13:45:25.7155664Z  
2025-12-16T13:45:25.7155819Z          match self {
2025-12-16T13:45:25.7156100Z -            TunnelMessage::Connect { stream_id, host, port } => {
2025-12-16T13:45:25.7156423Z +            TunnelMessage::Connect {
2025-12-16T13:45:25.7156663Z +                stream_id,
2025-12-16T13:45:25.7156886Z +                host,
2025-12-16T13:45:25.7157083Z +                port,
2025-12-16T13:45:25.7157272Z +            } => {
2025-12-16T13:45:25.7157505Z                  buf.put_u8(CommandType::Connect as u8);
2025-12-16T13:45:25.7157788Z                  buf.put_u32(*stream_id);
2025-12-16T13:45:25.7158037Z                  buf.put_u16(*port);
2025-12-16T13:45:25.7158468Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:148:
2025-12-16T13:45:25.7159081Z                  buf.put_u8(CommandType::Close as u8);
2025-12-16T13:45:25.7159390Z                  buf.put_u32(*stream_id);
2025-12-16T13:45:25.7159619Z              }
2025-12-16T13:45:25.7159895Z -            TunnelMessage::ErrorReply { stream_id, code, message } => {
2025-12-16T13:45:25.7160246Z +            TunnelMessage::ErrorReply {
2025-12-16T13:45:25.7160485Z +                stream_id,
2025-12-16T13:45:25.7160691Z +                code,
2025-12-16T13:45:25.7160874Z +                message,
2025-12-16T13:45:25.7161084Z +            } => {
2025-12-16T13:45:25.7161312Z                  buf.put_u8(CommandType::ErrorReply as u8);
2025-12-16T13:45:25.7161597Z                  buf.put_u32(*stream_id);
2025-12-16T13:45:25.7161836Z                  buf.put_u16(*code);
2025-12-16T13:45:25.7162261Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:161:
2025-12-16T13:45:25.7162689Z              TunnelMessage::Pong => {
2025-12-16T13:45:25.7162962Z                  buf.put_u8(CommandType::Pong as u8);
2025-12-16T13:45:25.7163211Z              }
2025-12-16T13:45:25.7163505Z -            TunnelMessage::UdpDatagram { request_id, host, port, payload } => {
2025-12-16T13:45:25.7163876Z +            TunnelMessage::UdpDatagram {
2025-12-16T13:45:25.7164115Z +                request_id,
2025-12-16T13:45:25.7164317Z +                host,
2025-12-16T13:45:25.7164496Z +                port,
2025-12-16T13:45:25.7164677Z +                payload,
2025-12-16T13:45:25.7165053Z +            } => {
2025-12-16T13:45:25.7165399Z                  buf.put_u8(CommandType::UdpDatagram as u8);
2025-12-16T13:45:25.7165705Z                  buf.put_u32(*request_id);
2025-12-16T13:45:25.7165960Z                  buf.put_u16(*port);
2025-12-16T13:45:25.7166387Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:176:
2025-12-16T13:45:25.7166826Z                  buf.put_u32(query.len() as u32);
2025-12-16T13:45:25.7167097Z                  buf.put_slice(query);
2025-12-16T13:45:25.7167323Z              }
2025-12-16T13:45:25.7167593Z -            TunnelMessage::DnsResponse { request_id, response } => {
2025-12-16T13:45:25.7167933Z +            TunnelMessage::DnsResponse {
2025-12-16T13:45:25.7168179Z +                request_id,
2025-12-16T13:45:25.7168391Z +                response,
2025-12-16T13:45:25.7168580Z +            } => {
2025-12-16T13:45:25.7168817Z                  buf.put_u8(CommandType::DnsResponse as u8);
2025-12-16T13:45:25.7169422Z                  buf.put_u32(*request_id);
2025-12-16T13:45:25.7169748Z                  buf.put_u32(response.len() as u32);
2025-12-16T13:45:25.7170192Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:204:
2025-12-16T13:45:25.7170625Z                  let stream_id = cursor.get_u32();
2025-12-16T13:45:25.7170898Z                  let port = cursor.get_u16();
2025-12-16T13:45:25.7171173Z                  let host_len = cursor.get_u16() as usize;
2025-12-16T13:45:25.7171425Z -                
2025-12-16T13:45:25.7171588Z +
2025-12-16T13:45:25.7171772Z                  if cursor.remaining() < host_len {
2025-12-16T13:45:25.7172098Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7172378Z                  }
2025-12-16T13:45:25.7172755Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:211:
2025-12-16T13:45:25.7173196Z                  let mut host_bytes = vec![0u8; host_len];
2025-12-16T13:45:25.7173499Z                  cursor.copy_to_slice(&mut host_bytes);
2025-12-16T13:45:25.7173804Z -                let host = String::from_utf8(host_bytes)
2025-12-16T13:45:25.7174125Z -                    .map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7174405Z +                let host =
2025-12-16T13:45:25.7174748Z +                    String::from_utf8(host_bytes).map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7175077Z  
2025-12-16T13:45:25.7175306Z -                Ok(TunnelMessage::Connect { stream_id, host, port })
2025-12-16T13:45:25.7175622Z +                Ok(TunnelMessage::Connect {
2025-12-16T13:45:25.7175860Z +                    stream_id,
2025-12-16T13:45:25.7176071Z +                    host,
2025-12-16T13:45:25.7176259Z +                    port,
2025-12-16T13:45:25.7176441Z +                })
2025-12-16T13:45:25.7176602Z              }
2025-12-16T13:45:25.7176794Z              CommandType::Data => {
2025-12-16T13:45:25.7177039Z                  if cursor.remaining() < 8 {
2025-12-16T13:45:25.7177326Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:221:
2025-12-16T13:45:25.7177396Z                  }
2025-12-16T13:45:25.7177498Z                  let stream_id = cursor.get_u32();
2025-12-16T13:45:25.7177634Z                  let payload_len = cursor.get_u32() as usize;
2025-12-16T13:45:25.7177703Z -                
2025-12-16T13:45:25.7177765Z +
2025-12-16T13:45:25.7177877Z                  if cursor.remaining() < payload_len {
2025-12-16T13:45:25.7178031Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7178100Z                  }
2025-12-16T13:45:25.7178359Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:228:
2025-12-16T13:45:25.7178617Z -                let payload = Bytes::copy_from_slice(&data[cursor.position() as usize..][..payload_len]);
2025-12-16T13:45:25.7178701Z +                let payload =
2025-12-16T13:45:25.7179089Z +                    Bytes::copy_from_slice(&data[cursor.position() as usize..][..payload_len]);
2025-12-16T13:45:25.7179432Z  
2025-12-16T13:45:25.7179586Z                  Ok(TunnelMessage::Data { stream_id, payload })
2025-12-16T13:45:25.7179655Z              }
2025-12-16T13:45:25.7179955Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:243:
2025-12-16T13:45:25.7180076Z                  let stream_id = cursor.get_u32();
2025-12-16T13:45:25.7180172Z                  let code = cursor.get_u16();
2025-12-16T13:45:25.7180287Z                  let msg_len = cursor.get_u16() as usize;
2025-12-16T13:45:25.7180364Z -                
2025-12-16T13:45:25.7180427Z +
2025-12-16T13:45:25.7180535Z                  if cursor.remaining() < msg_len {
2025-12-16T13:45:25.7180693Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7180763Z                  }
2025-12-16T13:45:25.7181036Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:250:
2025-12-16T13:45:25.7181165Z                  let mut msg_bytes = vec![0u8; msg_len];
2025-12-16T13:45:25.7181278Z                  cursor.copy_to_slice(&mut msg_bytes);
2025-12-16T13:45:25.7181401Z -                let message = String::from_utf8(msg_bytes)
2025-12-16T13:45:25.7181541Z -                    .map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7181629Z +                let message =
2025-12-16T13:45:25.7181840Z +                    String::from_utf8(msg_bytes).map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7181903Z  
2025-12-16T13:45:25.7182078Z -                Ok(TunnelMessage::ErrorReply { stream_id, code, message })
2025-12-16T13:45:25.7182193Z +                Ok(TunnelMessage::ErrorReply {
2025-12-16T13:45:25.7182273Z +                    stream_id,
2025-12-16T13:45:25.7182346Z +                    code,
2025-12-16T13:45:25.7182433Z +                    message,
2025-12-16T13:45:25.7182501Z +                })
2025-12-16T13:45:25.7182574Z              }
2025-12-16T13:45:25.7182715Z              CommandType::Ping => Ok(TunnelMessage::Ping),
2025-12-16T13:45:25.7182839Z              CommandType::Pong => Ok(TunnelMessage::Pong),
2025-12-16T13:45:25.7183105Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:263:
2025-12-16T13:45:25.7183209Z                  let request_id = cursor.get_u32();
2025-12-16T13:45:25.7183312Z                  let port = cursor.get_u16();
2025-12-16T13:45:25.7183421Z                  let host_len = cursor.get_u16() as usize;
2025-12-16T13:45:25.7183489Z -                
2025-12-16T13:45:25.7183558Z +
2025-12-16T13:45:25.7183661Z                  if cursor.remaining() < host_len {
2025-12-16T13:45:25.7183806Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7183880Z                  }
2025-12-16T13:45:25.7184151Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:270:
2025-12-16T13:45:25.7184256Z                  let mut host_bytes = vec![0u8; host_len];
2025-12-16T13:45:25.7184380Z                  cursor.copy_to_slice(&mut host_bytes);
2025-12-16T13:45:25.7184503Z -                let host = String::from_utf8(host_bytes)
2025-12-16T13:45:25.7184640Z -                    .map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7184708Z -                
2025-12-16T13:45:25.7184791Z +                let host =
2025-12-16T13:45:25.7185004Z +                    String::from_utf8(host_bytes).map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7185067Z +
2025-12-16T13:45:25.7185168Z                  if cursor.remaining() < 4 {
2025-12-16T13:45:25.7185317Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7185385Z                  }
2025-12-16T13:45:25.7185650Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:278:
2025-12-16T13:45:25.7185777Z                  let payload_len = cursor.get_u32() as usize;
2025-12-16T13:45:25.7185943Z -                
2025-12-16T13:45:25.7186080Z +
2025-12-16T13:45:25.7186195Z                  if cursor.remaining() < payload_len {
2025-12-16T13:45:25.7186337Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7186402Z                  }
2025-12-16T13:45:25.7186657Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:283:
2025-12-16T13:45:25.7186916Z -                let payload = Bytes::copy_from_slice(&data[cursor.position() as usize..][..payload_len]);
2025-12-16T13:45:25.7186983Z -                
2025-12-16T13:45:25.7187176Z -                Ok(TunnelMessage::UdpDatagram { request_id, host, port, payload })
2025-12-16T13:45:25.7187263Z +                let payload =
2025-12-16T13:45:25.7187473Z +                    Bytes::copy_from_slice(&data[cursor.position() as usize..][..payload_len]);
2025-12-16T13:45:25.7187534Z +
2025-12-16T13:45:25.7187648Z +                Ok(TunnelMessage::UdpDatagram {
2025-12-16T13:45:25.7187745Z +                    request_id,
2025-12-16T13:45:25.7187828Z +                    host,
2025-12-16T13:45:25.7187903Z +                    port,
2025-12-16T13:45:25.7187985Z +                    payload,
2025-12-16T13:45:25.7188053Z +                })
2025-12-16T13:45:25.7188117Z              }
2025-12-16T13:45:25.7188219Z              CommandType::DnsQuery => {
2025-12-16T13:45:25.7188316Z                  if cursor.remaining() < 8 {
2025-12-16T13:45:25.7188576Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:290:
2025-12-16T13:45:25.7188644Z                  }
2025-12-16T13:45:25.7188751Z                  let request_id = cursor.get_u32();
2025-12-16T13:45:25.7188863Z                  let query_len = cursor.get_u32() as usize;
2025-12-16T13:45:25.7189093Z -                
2025-12-16T13:45:25.7189171Z +
2025-12-16T13:45:25.7189289Z                  if cursor.remaining() < query_len {
2025-12-16T13:45:25.7189442Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7189534Z                  }
2025-12-16T13:45:25.7189799Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:297:
2025-12-16T13:45:25.7190038Z -                let query = Bytes::copy_from_slice(&data[cursor.position() as usize..][..query_len]);
2025-12-16T13:45:25.7190106Z -                
2025-12-16T13:45:25.7190192Z +                let query =
2025-12-16T13:45:25.7190394Z +                    Bytes::copy_from_slice(&data[cursor.position() as usize..][..query_len]);
2025-12-16T13:45:25.7190458Z +
2025-12-16T13:45:25.7190606Z                  Ok(TunnelMessage::DnsQuery { request_id, query })
2025-12-16T13:45:25.7190673Z              }
2025-12-16T13:45:25.7190781Z              CommandType::DnsResponse => {
2025-12-16T13:45:25.7191043Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:304:
2025-12-16T13:45:25.7191110Z                  }
2025-12-16T13:45:25.7191214Z                  let request_id = cursor.get_u32();
2025-12-16T13:45:25.7191351Z                  let response_len = cursor.get_u32() as usize;
2025-12-16T13:45:25.7191423Z -                
2025-12-16T13:45:25.7191485Z +
2025-12-16T13:45:25.7191597Z                  if cursor.remaining() < response_len {
2025-12-16T13:45:25.7191749Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7191818Z                  }
2025-12-16T13:45:25.7192074Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:311:
2025-12-16T13:45:25.7192337Z -                let response = Bytes::copy_from_slice(&data[cursor.position() as usize..][..response_len]);
2025-12-16T13:45:25.7192411Z -                
2025-12-16T13:45:25.7192579Z -                Ok(TunnelMessage::DnsResponse { request_id, response })
2025-12-16T13:45:25.7192665Z +                let response =
2025-12-16T13:45:25.7192886Z +                    Bytes::copy_from_slice(&data[cursor.position() as usize..][..response_len]);
2025-12-16T13:45:25.7193222Z +
2025-12-16T13:45:25.7193335Z +                Ok(TunnelMessage::DnsResponse {
2025-12-16T13:45:25.7193422Z +                    request_id,
2025-12-16T13:45:25.7193503Z +                    response,
2025-12-16T13:45:25.7193571Z +                })
2025-12-16T13:45:25.7193638Z              }
2025-12-16T13:45:25.7193709Z          }
2025-12-16T13:45:25.7193773Z      }
2025-12-16T13:45:25.7194069Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:329:
2025-12-16T13:45:25.7194144Z          };
2025-12-16T13:45:25.7194235Z          let encoded = msg.encode();
2025-12-16T13:45:25.7194388Z          let decoded = TunnelMessage::decode(&encoded).unwrap();
2025-12-16T13:45:25.7194456Z -        
2025-12-16T13:45:25.7194523Z +
2025-12-16T13:45:25.7194601Z          match decoded {
2025-12-16T13:45:25.7194753Z -            TunnelMessage::Connect { stream_id, host, port } => {
2025-12-16T13:45:25.7194865Z +            TunnelMessage::Connect {
2025-12-16T13:45:25.7194956Z +                stream_id,
2025-12-16T13:45:25.7195038Z +                host,
2025-12-16T13:45:25.7195112Z +                port,
2025-12-16T13:45:25.7195186Z +            } => {
2025-12-16T13:45:25.7195282Z                  assert_eq!(stream_id, 42);
2025-12-16T13:45:25.7195381Z                  assert_eq!(host, "google.com");
2025-12-16T13:45:25.7195477Z                  assert_eq!(port, 443);
2025-12-16T13:45:25.7195734Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:349:
2025-12-16T13:45:25.7195802Z          };
2025-12-16T13:45:25.7195891Z          let encoded = msg.encode();
2025-12-16T13:45:25.7196045Z          let decoded = TunnelMessage::decode(&encoded).unwrap();
2025-12-16T13:45:25.7196113Z -        
2025-12-16T13:45:25.7196175Z +
2025-12-16T13:45:25.7196259Z          match decoded {
2025-12-16T13:45:25.7196415Z -            TunnelMessage::Data { stream_id, payload: p } => {
2025-12-16T13:45:25.7196513Z +            TunnelMessage::Data {
2025-12-16T13:45:25.7196614Z +                stream_id,
2025-12-16T13:45:25.7196697Z +                payload: p,
2025-12-16T13:45:25.7196765Z +            } => {
2025-12-16T13:45:25.7196859Z                  assert_eq!(stream_id, 1);
2025-12-16T13:45:25.7196959Z                  assert_eq!(p, payload);
2025-12-16T13:45:25.7197028Z              }
2025-12-16T13:45:25.7197276Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/lib.rs:28:
2025-12-16T13:45:25.7197349Z  
2025-12-16T13:45:25.7197423Z      // Health check
2025-12-16T13:45:25.7197528Z      if path == "/health" || path == "/" {
2025-12-16T13:45:25.7197640Z -        return Response::ok(serde_json::json!({
2025-12-16T13:45:25.7197728Z -            "status": "ok",
2025-12-16T13:45:25.7197820Z -            "service": "zks-tunnel",
2025-12-16T13:45:25.7197902Z -            "version": "0.1.0",
2025-12-16T13:45:25.7198023Z -            "capabilities": ["tcp", "websocket", "zks"]
2025-12-16T13:45:25.7198099Z -        }).to_string());
2025-12-16T13:45:25.7198202Z +        return Response::ok(
2025-12-16T13:45:25.7198288Z +            serde_json::json!({
2025-12-16T13:45:25.7198375Z +                "status": "ok",
2025-12-16T13:45:25.7198472Z +                "service": "zks-tunnel",
2025-12-16T13:45:25.7198556Z +                "version": "0.1.0",
2025-12-16T13:45:25.7198686Z +                "capabilities": ["tcp", "websocket", "zks"]
2025-12-16T13:45:25.7198755Z +            })
2025-12-16T13:45:25.7198833Z +            .to_string(),
2025-12-16T13:45:25.7198898Z +        );
2025-12-16T13:45:25.7199124Z      }
2025-12-16T13:45:25.7199189Z  
2025-12-16T13:45:25.7199387Z      Response::error("Not Found. Use /tunnel for VPN connection.", 404)
2025-12-16T13:45:25.7199655Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/lib.rs:43:
2025-12-16T13:45:25.7199841Z  async fn handle_tunnel(req: Request, env: Env) -> Result<Response> {
2025-12-16T13:45:25.7199963Z      // Get or create Durable Object for this session
2025-12-16T13:45:25.7200351Z      let namespace = env.durable_object("TUNNEL_SESSION")?;
2025-12-16T13:45:25.7200415Z -    
2025-12-16T13:45:25.7200481Z +
2025-12-16T13:45:25.7200572Z      // Generate unique session ID
2025-12-16T13:45:25.7200676Z      let session_id = generate_session_id();
2025-12-16T13:45:25.7200795Z      let id = namespace.id_from_name(&session_id)?;
2025-12-16T13:45:25.7201188Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:6:
2025-12-16T13:45:25.7201292Z  //! - Memory-efficient buffer management
2025-12-16T13:45:25.7201435Z  //! - Hibernation support for zero-cost idle connections
2025-12-16T13:45:25.7201500Z  
2025-12-16T13:45:25.7201576Z -use worker::*;
2025-12-16T13:45:25.7201675Z -use worker::wasm_bindgen::JsCast;
2025-12-16T13:45:25.7201811Z -use zks_tunnel_proto::{TunnelMessage, StreamId};
2025-12-16T13:45:25.7201905Z -use std::collections::HashMap;
2025-12-16T13:45:25.7201988Z  use std::cell::RefCell;
2025-12-16T13:45:25.7202090Z +use std::collections::HashMap;
2025-12-16T13:45:25.7202173Z  use std::rc::Rc;
2025-12-16T13:45:25.7202264Z +use worker::wasm_bindgen::JsCast;
2025-12-16T13:45:25.7202339Z +use worker::*;
2025-12-16T13:45:25.7202471Z +use zks_tunnel_proto::{StreamId, TunnelMessage};
2025-12-16T13:45:25.7202531Z  
2025-12-16T13:45:25.7202643Z  /// Connection state for tracking active streams
2025-12-16T13:45:25.7202744Z  #[derive(Clone, Copy, PartialEq, Eq)]
2025-12-16T13:45:25.7203034Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:61:
2025-12-16T13:45:25.7203141Z          self.state.accept_web_socket(&server);
2025-12-16T13:45:25.7203201Z  
2025-12-16T13:45:25.7203316Z          *self.connection_count.borrow_mut() += 1;
2025-12-16T13:45:25.7203574Z -        console_log!("[TunnelSession] Connection #{} established", self.connection_count.borrow());
2025-12-16T13:45:25.7203648Z +        console_log!(
2025-12-16T13:45:25.7203774Z +            "[TunnelSession] Connection #{} established",
2025-12-16T13:45:25.7203888Z +            self.connection_count.borrow()
2025-12-16T13:45:25.7203953Z +        );
2025-12-16T13:45:25.7204017Z  
2025-12-16T13:45:25.7204118Z          Response::from_websocket(client)
2025-12-16T13:45:25.7204181Z      }
2025-12-16T13:45:25.7204461Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:77:
2025-12-16T13:45:25.7204531Z              }
2025-12-16T13:45:25.7204663Z              WebSocketIncomingMessage::String(text) => {
2025-12-16T13:45:25.7204816Z                  // Handle text messages (could be JSON commands in future)
2025-12-16T13:45:25.7205033Z -                console_log!("[TunnelSession] Text message received: {} bytes", text.len());
2025-12-16T13:45:25.7205113Z +                console_log!(
2025-12-16T13:45:25.7205246Z +                    "[TunnelSession] Text message received: {} bytes",
2025-12-16T13:45:25.7205324Z +                    text.len()
2025-12-16T13:45:25.7205395Z +                );
2025-12-16T13:45:25.7205469Z              }
2025-12-16T13:45:25.7205539Z          }
2025-12-16T13:45:25.7205609Z          Ok(())
2025-12-16T13:45:25.7205889Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:92:
2025-12-16T13:45:25.7205965Z      ) -> Result<()> {
2025-12-16T13:45:25.7206044Z          console_log!(
2025-12-16T13:45:25.7206224Z              "[TunnelSession] Connection closed: code={}, reason={}, clean={}",
2025-12-16T13:45:25.7206312Z -            code, reason, was_clean
2025-12-16T13:45:25.7206380Z +            code,
2025-12-16T13:45:25.7206456Z +            reason,
2025-12-16T13:45:25.7206527Z +            was_clean
2025-12-16T13:45:25.7206592Z          );
2025-12-16T13:45:25.7206661Z -        
2025-12-16T13:45:25.7206720Z +
2025-12-16T13:45:25.7206804Z          // Clean up all streams
2025-12-16T13:45:25.7206946Z          let stream_count = self.active_streams.borrow().len();
2025-12-16T13:45:25.7207060Z          self.active_streams.borrow_mut().clear();
2025-12-16T13:45:25.7207517Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:101:
2025-12-16T13:45:25.7207580Z -        
2025-12-16T13:45:25.7207645Z +
2025-12-16T13:45:25.7207831Z          console_log!("[TunnelSession] Cleaned up {} streams", stream_count);
2025-12-16T13:45:25.7207898Z          Ok(())
2025-12-16T13:45:25.7207960Z      }
2025-12-16T13:45:25.7208248Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:121:
2025-12-16T13:45:25.7208314Z          };
2025-12-16T13:45:25.7208374Z  
2025-12-16T13:45:25.7208450Z          match msg {
2025-12-16T13:45:25.7208604Z -            TunnelMessage::Connect { stream_id, host, port } => {
2025-12-16T13:45:25.7208702Z +            TunnelMessage::Connect {
2025-12-16T13:45:25.7208780Z +                stream_id,
2025-12-16T13:45:25.7208854Z +                host,
2025-12-16T13:45:25.7209077Z +                port,
2025-12-16T13:45:25.7209170Z +            } => {
2025-12-16T13:45:25.7209288Z                  // Validate host to prevent SSRF
2025-12-16T13:45:25.7209402Z                  if !Self::is_valid_host(&host) {
2025-12-16T13:45:25.7209583Z                      console_warn!("[TunnelSession] Rejected invalid host: {}", host);
2025-12-16T13:45:25.7209865Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:128:
2025-12-16T13:45:25.7210014Z                      Self::send_error(ws, stream_id, 400, "Invalid host");
2025-12-16T13:45:25.7210097Z                      return Ok(());
2025-12-16T13:45:25.7210166Z                  }
2025-12-16T13:45:25.7210239Z -                
2025-12-16T13:45:25.7210465Z -                console_log!("[TunnelSession] CONNECT stream={} to {}:{}", stream_id, host, port);
2025-12-16T13:45:25.7210528Z +
2025-12-16T13:45:25.7210608Z +                console_log!(
2025-12-16T13:45:25.7210731Z +                    "[TunnelSession] CONNECT stream={} to {}:{}",
2025-12-16T13:45:25.7210809Z +                    stream_id,
2025-12-16T13:45:25.7210899Z +                    host,
2025-12-16T13:45:25.7210979Z +                    port
2025-12-16T13:45:25.7211046Z +                );
2025-12-16T13:45:25.7211194Z                  self.handle_connect(ws, stream_id, &host, port).await?;
2025-12-16T13:45:25.7211263Z              }
2025-12-16T13:45:25.7211401Z              TunnelMessage::Data { stream_id, payload } => {
2025-12-16T13:45:25.7211682Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:151:
2025-12-16T13:45:25.7211902Z                  console_warn!("[TunnelSession] Received unexpected ErrorReply from client");
2025-12-16T13:45:25.7211970Z              }
2025-12-16T13:45:25.7212111Z              TunnelMessage::DnsQuery { request_id, query } => {
2025-12-16T13:45:25.7212357Z -                console_log!("[TunnelSession] DNS query request_id={} len={}", request_id, query.len());
2025-12-16T13:45:25.7212441Z +                console_log!(
2025-12-16T13:45:25.7212581Z +                    "[TunnelSession] DNS query request_id={} len={}",
2025-12-16T13:45:25.7212670Z +                    request_id,
2025-12-16T13:45:25.7212752Z +                    query.len()
2025-12-16T13:45:25.7212819Z +                );
2025-12-16T13:45:25.7212958Z                  self.handle_dns_query(ws, request_id, &query).await?;
2025-12-16T13:45:25.7213029Z              }
2025-12-16T13:45:25.7213142Z              TunnelMessage::DnsResponse { .. } => {
2025-12-16T13:45:25.7213428Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:158:
2025-12-16T13:45:25.7213564Z                  // Unexpected - worker sends responses, not client
2025-12-16T13:45:25.7213788Z                  console_warn!("[TunnelSession] Received unexpected DnsResponse from client");
2025-12-16T13:45:25.7213854Z              }
2025-12-16T13:45:25.7214054Z -            TunnelMessage::UdpDatagram { request_id, host, port, payload } => {
2025-12-16T13:45:25.7214259Z -                console_log!("[TunnelSession] UDP datagram request_id={} to {}:{} len={}", 
2025-12-16T13:45:25.7214606Z -                    request_id, host, port, payload.len());
2025-12-16T13:45:25.7214711Z +            TunnelMessage::UdpDatagram {
2025-12-16T13:45:25.7214793Z +                request_id,
2025-12-16T13:45:25.7214865Z +                host,
2025-12-16T13:45:25.7214937Z +                port,
2025-12-16T13:45:25.7215011Z +                payload,
2025-12-16T13:45:25.7215081Z +            } => {
2025-12-16T13:45:25.7215159Z +                console_log!(
2025-12-16T13:45:25.7215325Z +                    "[TunnelSession] UDP datagram request_id={} to {}:{} len={}",
2025-12-16T13:45:25.7215408Z +                    request_id,
2025-12-16T13:45:25.7215482Z +                    host,
2025-12-16T13:45:25.7215554Z +                    port,
2025-12-16T13:45:25.7215637Z +                    payload.len()
2025-12-16T13:45:25.7215708Z +                );
2025-12-16T13:45:25.7215838Z                  // Note: Workers don't have raw UDP socket support
2025-12-16T13:45:25.7215965Z                  // For DNS (port 53), we redirect to DoH
2025-12-16T13:45:25.7216048Z                  if port == 53 {
2025-12-16T13:45:25.7216332Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:183:
2025-12-16T13:45:25.7216445Z      /// Validate hostname to prevent SSRF attacks
2025-12-16T13:45:25.7216545Z      fn is_valid_host(host: &str) -> bool {
2025-12-16T13:45:25.7216648Z          // Block internal/private networks
2025-12-16T13:45:25.7216824Z -        let blocked_prefixes = ["127.", "10.", "192.168.", "172.16.", "172.17.", 
2025-12-16T13:45:25.7216950Z -                                "172.18.", "172.19.", "172.20.", "172.21.", "172.22.",
2025-12-16T13:45:25.7217073Z -                                "172.23.", "172.24.", "172.25.", "172.26.", "172.27.",
2025-12-16T13:45:25.7217198Z -                                "172.28.", "172.29.", "172.30.", "172.31.", "169.254.",
2025-12-16T13:45:25.7217334Z -                                "0.", "localhost", "::1", "fc", "fd", "fe80"];
2025-12-16T13:45:25.7217413Z -        
2025-12-16T13:45:25.7217501Z +        let blocked_prefixes = [
2025-12-16T13:45:25.7217569Z +            "127.",
2025-12-16T13:45:25.7217636Z +            "10.",
2025-12-16T13:45:25.7217712Z +            "192.168.",
2025-12-16T13:45:25.7217782Z +            "172.16.",
2025-12-16T13:45:25.7217850Z +            "172.17.",
2025-12-16T13:45:25.7217920Z +            "172.18.",
2025-12-16T13:45:25.7217987Z +            "172.19.",
2025-12-16T13:45:25.7218053Z +            "172.20.",
2025-12-16T13:45:25.7218120Z +            "172.21.",
2025-12-16T13:45:25.7218191Z +            "172.22.",
2025-12-16T13:45:25.7218258Z +            "172.23.",
2025-12-16T13:45:25.7218325Z +            "172.24.",
2025-12-16T13:45:25.7218395Z +            "172.25.",
2025-12-16T13:45:25.7218461Z +            "172.26.",
2025-12-16T13:45:25.7218527Z +            "172.27.",
2025-12-16T13:45:25.7218595Z +            "172.28.",
2025-12-16T13:45:25.7218678Z +            "172.29.",
2025-12-16T13:45:25.7218747Z +            "172.30.",
2025-12-16T13:45:25.7218815Z +            "172.31.",
2025-12-16T13:45:25.7218888Z +            "169.254.",
2025-12-16T13:45:25.7219141Z +            "0.",
2025-12-16T13:45:25.7219226Z +            "localhost",
2025-12-16T13:45:25.7219299Z +            "::1",
2025-12-16T13:45:25.7219390Z +            "fc",
2025-12-16T13:45:25.7219461Z +            "fd",
2025-12-16T13:45:25.7219530Z +            "fe80",
2025-12-16T13:45:25.7219599Z +        ];
2025-12-16T13:45:25.7219662Z +
2025-12-16T13:45:25.7219772Z          let host_lower = host.to_lowercase();
2025-12-16T13:45:25.7219837Z -        
2025-12-16T13:45:25.7219902Z +
2025-12-16T13:45:25.7220005Z          for prefix in blocked_prefixes {
2025-12-16T13:45:25.7220113Z              if host_lower.starts_with(prefix) {
2025-12-16T13:45:25.7220201Z                  return false;
2025-12-16T13:45:25.7220506Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:197:
2025-12-16T13:45:25.7220807Z              }
2025-12-16T13:45:25.7220871Z          }
2025-12-16T13:45:25.7220941Z -        
2025-12-16T13:45:25.7221004Z +
2025-12-16T13:45:25.7221097Z          // Block empty or too long hosts
2025-12-16T13:45:25.7221207Z          if host.is_empty() || host.len() > 253 {
2025-12-16T13:45:25.7221286Z              return false;
2025-12-16T13:45:25.7221574Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:203:
2025-12-16T13:45:25.7221639Z          }
2025-12-16T13:45:25.7221707Z -        
2025-12-16T13:45:25.7221769Z +
2025-12-16T13:45:25.7221835Z          true
2025-12-16T13:45:25.7221904Z      }
2025-12-16T13:45:25.7221964Z  
2025-12-16T13:45:25.7222245Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:231:
2025-12-16T13:45:25.7222309Z          }
2025-12-16T13:45:25.7222375Z  
2025-12-16T13:45:25.7222465Z          // Mark stream as connecting
2025-12-16T13:45:25.7222715Z -        self.active_streams.borrow_mut().insert(stream_id, StreamStatus::Connecting);
2025-12-16T13:45:25.7222802Z +        self.active_streams
2025-12-16T13:45:25.7222879Z +            .borrow_mut()
2025-12-16T13:45:25.7223010Z +            .insert(stream_id, StreamStatus::Connecting);
2025-12-16T13:45:25.7223071Z  
2025-12-16T13:45:25.7223186Z          let address = format!("{}:{}", host, port);
2025-12-16T13:45:25.7223339Z          console_log!("[TunnelSession] Connecting to {}", address);
2025-12-16T13:45:25.7223623Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:240:
2025-12-16T13:45:25.7223750Z          match Socket::builder().connect(host, port) {
2025-12-16T13:45:25.7223829Z              Ok(_socket) => {
2025-12-16T13:45:25.7223980Z                  console_log!("[TunnelSession] Connected to {}", address);
2025-12-16T13:45:25.7224050Z -                
2025-12-16T13:45:25.7224111Z +
2025-12-16T13:45:25.7224197Z                  // Mark as connected
2025-12-16T13:45:25.7224439Z -                self.active_streams.borrow_mut().insert(stream_id, StreamStatus::Connected);
2025-12-16T13:45:25.7224513Z -                
2025-12-16T13:45:25.7224599Z +                self.active_streams
2025-12-16T13:45:25.7224680Z +                    .borrow_mut()
2025-12-16T13:45:25.7224817Z +                    .insert(stream_id, StreamStatus::Connected);
2025-12-16T13:45:25.7224879Z +
2025-12-16T13:45:25.7225028Z                  // Note: Full bidirectional I/O requires spawning tasks
2025-12-16T13:45:25.7225168Z                  // In production, we'd spawn reader/writer tasks here
2025-12-16T13:45:25.7225302Z                  // For now, connection is established and tracked
2025-12-16T13:45:25.7225589Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:250:
2025-12-16T13:45:25.7225656Z -                
2025-12-16T13:45:25.7225721Z +
2025-12-16T13:45:25.7225907Z                  console_log!("[TunnelSession] Stream {} ready for data", stream_id);
2025-12-16T13:45:25.7225987Z              }
2025-12-16T13:45:25.7226064Z              Err(e) => {
2025-12-16T13:45:25.7226347Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:264:
2025-12-16T13:45:25.7226605Z      async fn handle_data(&self, ws: &WebSocket, stream_id: StreamId, payload: &[u8]) -> Result<()> {
2025-12-16T13:45:25.7226711Z          // Check stream exists and is connected
2025-12-16T13:45:25.7226894Z          let status = self.active_streams.borrow().get(&stream_id).copied();
2025-12-16T13:45:25.7226960Z -        
2025-12-16T13:45:25.7227022Z +
2025-12-16T13:45:25.7227100Z          match status {
2025-12-16T13:45:25.7227212Z              Some(StreamStatus::Connected) => {
2025-12-16T13:45:25.7227353Z                  // TODO: Write to socket when full I/O is implemented
2025-12-16T13:45:25.7227654Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:271:
2025-12-16T13:45:25.7228048Z -                console_log!("[TunnelSession] DATA stream={} len={}", stream_id, payload.len());
2025-12-16T13:45:25.7228131Z +                console_log!(
2025-12-16T13:45:25.7228248Z +                    "[TunnelSession] DATA stream={} len={}",
2025-12-16T13:45:25.7228333Z +                    stream_id,
2025-12-16T13:45:25.7228421Z +                    payload.len()
2025-12-16T13:45:25.7228489Z +                );
2025-12-16T13:45:25.7228562Z              }
2025-12-16T13:45:25.7228674Z              Some(StreamStatus::Connecting) => {
2025-12-16T13:45:25.7229087Z -                console_warn!("[TunnelSession] DATA received while stream {} still connecting", stream_id);
2025-12-16T13:45:25.7229177Z +                console_warn!(
2025-12-16T13:45:25.7229369Z +                    "[TunnelSession] DATA received while stream {} still connecting",
2025-12-16T13:45:25.7229445Z +                    stream_id
2025-12-16T13:45:25.7229513Z +                );
2025-12-16T13:45:25.7229595Z              }
2025-12-16T13:45:25.7229722Z              Some(StreamStatus::Closing) | None => {
2025-12-16T13:45:25.7229873Z                  Self::send_error(ws, stream_id, 404, "Stream not found");
2025-12-16T13:45:25.7230172Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:278:
2025-12-16T13:45:25.7230240Z              }
2025-12-16T13:45:25.7230304Z          }
2025-12-16T13:45:25.7230368Z -        
2025-12-16T13:45:25.7230434Z +
2025-12-16T13:45:25.7230501Z          Ok(())
2025-12-16T13:45:25.7230564Z      }
2025-12-16T13:45:25.7230630Z  
2025-12-16T13:45:25.7230913Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:284:
2025-12-16T13:45:25.7231021Z      /// Handle CLOSE command - close TCP socket
2025-12-16T13:45:25.7231189Z      async fn handle_close(&self, stream_id: StreamId) -> Result<()> {
2025-12-16T13:45:25.7231385Z          if let Some(status) = self.active_streams.borrow_mut().remove(&stream_id) {
2025-12-16T13:45:25.7231608Z -            console_log!("[TunnelSession] CLOSE stream={} (was {:?})", stream_id, status);
2025-12-16T13:45:25.7231693Z +            console_log!(
2025-12-16T13:45:25.7231817Z +                "[TunnelSession] CLOSE stream={} (was {:?})",
2025-12-16T13:45:25.7231895Z +                stream_id,
2025-12-16T13:45:25.7231965Z +                status
2025-12-16T13:45:25.7232035Z +            );
2025-12-16T13:45:25.7232101Z          } else {
2025-12-16T13:45:25.7232283Z              console_log!("[TunnelSession] CLOSE stream={} (not found)", stream_id);
2025-12-16T13:45:25.7232349Z          }
2025-12-16T13:45:25.7232639Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:296:
2025-12-16T13:45:25.7232880Z      async fn handle_dns_query(&self, ws: &WebSocket, request_id: u32, query: &[u8]) -> Result<()> {
2025-12-16T13:45:25.7233033Z          // Use resolve_dns_via_doh which uses web_sys fetch directly
2025-12-16T13:45:25.7233175Z          let response = self.resolve_dns_via_doh(query).await;
2025-12-16T13:45:25.7233252Z -        
2025-12-16T13:45:25.7233313Z +
2025-12-16T13:45:25.7233393Z          match response {
2025-12-16T13:45:25.7233482Z              Ok(dns_response) => {
2025-12-16T13:45:25.7233603Z                  let msg = TunnelMessage::DnsResponse {
2025-12-16T13:45:25.7233894Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:304:
2025-12-16T13:45:25.7234029Z                      response: bytes::Bytes::from(dns_response),
2025-12-16T13:45:25.7234097Z                  };
2025-12-16T13:45:25.7234214Z                  let _ = ws.send_with_bytes(&msg.encode());
2025-12-16T13:45:25.7234442Z -                console_log!("[TunnelSession] DNS response sent for request_id={}", request_id);
2025-12-16T13:45:25.7234520Z +                console_log!(
2025-12-16T13:45:25.7234672Z +                    "[TunnelSession] DNS response sent for request_id={}",
2025-12-16T13:45:25.7234751Z +                    request_id
2025-12-16T13:45:25.7235051Z +                );
2025-12-16T13:45:25.7235119Z              }
2025-12-16T13:45:25.7235194Z              Err(e) => {
2025-12-16T13:45:25.7235376Z                  console_error!("[TunnelSession] DoH resolution failed: {:?}", e);
2025-12-16T13:45:25.7235667Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:317:
2025-12-16T13:45:25.7235796Z                  let _ = ws.send_with_bytes(&error_msg.encode());
2025-12-16T13:45:25.7235867Z              }
2025-12-16T13:45:25.7235934Z          }
2025-12-16T13:45:25.7236000Z -        
2025-12-16T13:45:25.7236064Z +
2025-12-16T13:45:25.7236134Z          Ok(())
2025-12-16T13:45:25.7236197Z      }
2025-12-16T13:45:25.7236258Z  
2025-12-16T13:45:25.7236539Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:324:
2025-12-16T13:45:25.7236660Z      /// Resolve DNS query via DoH using native fetch
2025-12-16T13:45:25.7236839Z      async fn resolve_dns_via_doh(&self, query: &[u8]) -> Result<Vec<u8>> {
2025-12-16T13:45:25.7236960Z -        use worker::wasm_bindgen::JsValue;
2025-12-16T13:45:25.7237088Z          use worker::js_sys::{ArrayBuffer, Uint8Array};
2025-12-16T13:45:25.7237152Z -        
2025-12-16T13:45:25.7237250Z +        use worker::wasm_bindgen::JsValue;
2025-12-16T13:45:25.7237314Z +
2025-12-16T13:45:25.7237403Z          // Cloudflare DoH endpoint
2025-12-16T13:45:25.7237520Z          let url = "https://1.1.1.1/dns-query";
2025-12-16T13:45:25.7237584Z -        
2025-12-16T13:45:25.7237650Z +
2025-12-16T13:45:25.7237752Z          // Create the request using web_sys
2025-12-16T13:45:25.7237863Z          let opts = web_sys::RequestInit::new();
2025-12-16T13:45:25.7237955Z          opts.set_method("POST");
2025-12-16T13:45:25.7238243Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:335:
2025-12-16T13:45:25.7238308Z -        
2025-12-16T13:45:25.7238369Z +
2025-12-16T13:45:25.7238459Z          // Set body as ArrayBuffer
2025-12-16T13:45:25.7238652Z          let body_array = Uint8Array::new_with_length(query.len() as u32);
2025-12-16T13:45:25.7238744Z          body_array.copy_from(query);
2025-12-16T13:45:25.7239199Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:339:
2025-12-16T13:45:25.7239308Z          opts.set_body(&body_array.buffer());
2025-12-16T13:45:25.7239373Z -        
2025-12-16T13:45:25.7239438Z +
2025-12-16T13:45:25.7239515Z          // Create headers
2025-12-16T13:45:25.7239751Z -        let headers = web_sys::Headers::new().map_err(|_| Error::from("Headers creation failed"))?;
2025-12-16T13:45:25.7240058Z -        headers.set("Content-Type", "application/dns-message").map_err(|_| Error::from("Set header failed"))?;
2025-12-16T13:45:25.7240341Z -        headers.set("Accept", "application/dns-message").map_err(|_| Error::from("Set header failed"))?;
2025-12-16T13:45:25.7240416Z +        let headers =
2025-12-16T13:45:25.7240614Z +            web_sys::Headers::new().map_err(|_| Error::from("Headers creation failed"))?;
2025-12-16T13:45:25.7240705Z +        headers
2025-12-16T13:45:25.7240837Z +            .set("Content-Type", "application/dns-message")
2025-12-16T13:45:25.7240967Z +            .map_err(|_| Error::from("Set header failed"))?;
2025-12-16T13:45:25.7241038Z +        headers
2025-12-16T13:45:25.7241152Z +            .set("Accept", "application/dns-message")
2025-12-16T13:45:25.7241274Z +            .map_err(|_| Error::from("Set header failed"))?;
2025-12-16T13:45:25.7241363Z          opts.set_headers(&headers);
2025-12-16T13:45:25.7241431Z -        
2025-12-16T13:45:25.7241491Z +
2025-12-16T13:45:25.7241569Z          // Create request
2025-12-16T13:45:25.7241744Z          let request = web_sys::Request::new_with_str_and_init(url, &opts)
2025-12-16T13:45:25.7241888Z              .map_err(|_| Error::from("Request creation failed"))?;
2025-12-16T13:45:25.7242175Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:350:
2025-12-16T13:45:25.7242472Z -        
2025-12-16T13:45:25.7242532Z +
2025-12-16T13:45:25.7242613Z          // Use worker's Fetch
2025-12-16T13:45:25.7242723Z          let global = worker::js_sys::global();
2025-12-16T13:45:25.7242944Z          let fetch_fn = worker::js_sys::Reflect::get(&global, &JsValue::from_str("fetch"))
2025-12-16T13:45:25.7243232Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:354:
2025-12-16T13:45:25.7243361Z              .map_err(|_| Error::from("fetch not found"))?;
2025-12-16T13:45:25.7243429Z -        
2025-12-16T13:45:25.7243490Z +
2025-12-16T13:45:25.7243561Z          // Call fetch
2025-12-16T13:45:25.7243724Z -        let fetch_fn = fetch_fn.dyn_into::<worker::js_sys::Function>()
2025-12-16T13:45:25.7243814Z +        let fetch_fn = fetch_fn
2025-12-16T13:45:25.7243925Z +            .dyn_into::<worker::js_sys::Function>()
2025-12-16T13:45:25.7244063Z              .map_err(|_| Error::from("fetch is not a function"))?;
2025-12-16T13:45:25.7244149Z -        
2025-12-16T13:45:25.7244294Z -        let promise = fetch_fn.call1(&JsValue::NULL, &request)
2025-12-16T13:45:25.7244355Z +
2025-12-16T13:45:25.7244444Z +        let promise = fetch_fn
2025-12-16T13:45:25.7244546Z +            .call1(&JsValue::NULL, &request)
2025-12-16T13:45:25.7244669Z              .map_err(|_| Error::from("fetch call failed"))?;
2025-12-16T13:45:25.7244733Z -        
2025-12-16T13:45:25.7244797Z +
2025-12-16T13:45:25.7244937Z          let promise = worker::js_sys::Promise::from(promise);
2025-12-16T13:45:25.7245096Z          let future = wasm_bindgen_futures::JsFuture::from(promise);
2025-12-16T13:45:25.7245165Z -        
2025-12-16T13:45:25.7245410Z -        let response = future.await.map_err(|e| Error::from(format!("fetch failed: {:?}", e)))?;
2025-12-16T13:45:25.7245553Z -        let response: web_sys::Response = response.dyn_into()
2025-12-16T13:45:25.7245616Z +
2025-12-16T13:45:25.7245700Z +        let response = future
2025-12-16T13:45:25.7245775Z +            .await
2025-12-16T13:45:25.7245934Z +            .map_err(|e| Error::from(format!("fetch failed: {:?}", e)))?;
2025-12-16T13:45:25.7246057Z +        let response: web_sys::Response = response
2025-12-16T13:45:25.7246132Z +            .dyn_into()
2025-12-16T13:45:25.7246262Z              .map_err(|_| Error::from("response cast failed"))?;
2025-12-16T13:45:25.7246334Z -        
2025-12-16T13:45:25.7246396Z +
2025-12-16T13:45:25.7246480Z          if !response.ok() {
2025-12-16T13:45:25.7246696Z -            return Err(Error::from(format!("DoH returned status {}", response.status())));
2025-12-16T13:45:25.7246804Z +            return Err(Error::from(format!(
2025-12-16T13:45:25.7246897Z +                "DoH returned status {}",
2025-12-16T13:45:25.7246985Z +                response.status()
2025-12-16T13:45:25.7247054Z +            )));
2025-12-16T13:45:25.7247117Z          }
2025-12-16T13:45:25.7247180Z -        
2025-12-16T13:45:25.7247240Z +
2025-12-16T13:45:25.7247343Z          // Get response body as ArrayBuffer
2025-12-16T13:45:25.7247476Z -        let body_promise = response.array_buffer()
2025-12-16T13:45:25.7247565Z +        let body_promise = response
2025-12-16T13:45:25.7247655Z +            .array_buffer()
2025-12-16T13:45:25.7247797Z              .map_err(|_| Error::from("array_buffer() failed"))?;
2025-12-16T13:45:25.7247861Z -        
2025-12-16T13:45:25.7247924Z +
2025-12-16T13:45:25.7248118Z          let body_future = wasm_bindgen_futures::JsFuture::from(body_promise);
2025-12-16T13:45:25.7248323Z -        let body = body_future.await.map_err(|_| Error::from("body await failed"))?;
2025-12-16T13:45:25.7248388Z -        
2025-12-16T13:45:25.7248518Z -        let array_buffer: ArrayBuffer = body.dyn_into()
2025-12-16T13:45:25.7248603Z +        let body = body_future
2025-12-16T13:45:25.7248673Z +            .await
2025-12-16T13:45:25.7248806Z +            .map_err(|_| Error::from("body await failed"))?;
2025-12-16T13:45:25.7248870Z +
2025-12-16T13:45:25.7249136Z +        let array_buffer: ArrayBuffer = body
2025-12-16T13:45:25.7249490Z +            .dyn_into()
2025-12-16T13:45:25.7249632Z              .map_err(|_| Error::from("body cast failed"))?;
2025-12-16T13:45:25.7249696Z -        
2025-12-16T13:45:25.7249758Z +
2025-12-16T13:45:25.7249895Z          let uint8_array = Uint8Array::new(&array_buffer);
2025-12-16T13:45:25.7250027Z          let mut vec = vec![0u8; uint8_array.length() as usize];
2025-12-16T13:45:25.7250121Z          uint8_array.copy_to(&mut vec);
2025-12-16T13:45:25.7250417Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:387:
2025-12-16T13:45:25.7250486Z -        
2025-12-16T13:45:25.7250546Z +
2025-12-16T13:45:25.7250614Z          Ok(vec)
2025-12-16T13:45:25.7250680Z      }
2025-12-16T13:45:25.7250741Z  }
2025-12-16T13:45:25.7260541Z ##[error]Process completed with exit code 1.
