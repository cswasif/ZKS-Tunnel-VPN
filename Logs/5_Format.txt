2025-12-16T13:45:14.4793846Z Current runner version: '2.329.0'
2025-12-16T13:45:14.4816613Z ##[group]Runner Image Provisioner
2025-12-16T13:45:14.4817427Z Hosted Compute Agent
2025-12-16T13:45:14.4817926Z Version: 20251202.455
2025-12-16T13:45:14.4818637Z Commit: 6c10caca4910e198df60de23adf20ad317c474e3
2025-12-16T13:45:14.4819480Z Build Date: 2025-12-02T15:56:59Z
2025-12-16T13:45:14.4820120Z Worker ID: {696d0377-f5c4-4c8b-9683-c5b871a730ff}
2025-12-16T13:45:14.4820859Z ##[endgroup]
2025-12-16T13:45:14.4821380Z ##[group]Operating System
2025-12-16T13:45:14.4821904Z Ubuntu
2025-12-16T13:45:14.4822424Z 24.04.3
2025-12-16T13:45:14.4822839Z LTS
2025-12-16T13:45:14.4823291Z ##[endgroup]
2025-12-16T13:45:14.4823863Z ##[group]Runner Image
2025-12-16T13:45:14.4824360Z Image: ubuntu-24.04
2025-12-16T13:45:14.4824870Z Version: 20251208.163.1
2025-12-16T13:45:14.4825876Z Included Software: https://github.com/actions/runner-images/blob/ubuntu24/20251208.163/images/ubuntu/Ubuntu2404-Readme.md
2025-12-16T13:45:14.4827452Z Image Release: https://github.com/actions/runner-images/releases/tag/ubuntu24%2F20251208.163
2025-12-16T13:45:14.4828473Z ##[endgroup]
2025-12-16T13:45:14.4829667Z ##[group]GITHUB_TOKEN Permissions
2025-12-16T13:45:14.4831687Z Contents: read
2025-12-16T13:45:14.4832212Z Metadata: read
2025-12-16T13:45:14.4832717Z Packages: read
2025-12-16T13:45:14.4833159Z ##[endgroup]
2025-12-16T13:45:14.4835185Z Secret source: Actions
2025-12-16T13:45:14.4835870Z Prepare workflow directory
2025-12-16T13:45:14.5217077Z Prepare all required actions
2025-12-16T13:45:14.5256032Z Getting action download info
2025-12-16T13:45:14.9806204Z Download action repository 'actions/checkout@v4' (SHA:34e114876b0b11c390a56381ad16ebd13914f8d5)
2025-12-16T13:45:15.0739510Z Download action repository 'dtolnay/rust-toolchain@stable' (SHA:6d9817901c499d6b02debbb57edb38d33daa680b)
2025-12-16T13:45:15.5764670Z Complete job name: Format
2025-12-16T13:45:15.6417544Z ##[group]Run actions/checkout@v4
2025-12-16T13:45:15.6418369Z with:
2025-12-16T13:45:15.6418888Z   repository: cswasif/ZKS-Tunnel-VPN
2025-12-16T13:45:15.6419879Z   token: ***
2025-12-16T13:45:15.6420265Z   ssh-strict: true
2025-12-16T13:45:15.6420645Z   ssh-user: git
2025-12-16T13:45:15.6421053Z   persist-credentials: true
2025-12-16T13:45:15.6421489Z   clean: true
2025-12-16T13:45:15.6421888Z   sparse-checkout-cone-mode: true
2025-12-16T13:45:15.6422359Z   fetch-depth: 1
2025-12-16T13:45:15.6422735Z   fetch-tags: false
2025-12-16T13:45:15.6423131Z   show-progress: true
2025-12-16T13:45:15.6423521Z   lfs: false
2025-12-16T13:45:15.6423880Z   submodules: false
2025-12-16T13:45:15.6424272Z   set-safe-directory: true
2025-12-16T13:45:15.6424952Z env:
2025-12-16T13:45:15.6425316Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:15.6425736Z ##[endgroup]
2025-12-16T13:45:15.7489769Z Syncing repository: cswasif/ZKS-Tunnel-VPN
2025-12-16T13:45:15.7491497Z ##[group]Getting Git version info
2025-12-16T13:45:15.7492334Z Working directory is '/home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN'
2025-12-16T13:45:15.7493337Z [command]/usr/bin/git version
2025-12-16T13:45:15.7594013Z git version 2.52.0
2025-12-16T13:45:15.7619454Z ##[endgroup]
2025-12-16T13:45:15.7633020Z Temporarily overriding HOME='/home/runner/work/_temp/47770859-1656-4220-bd2f-2e575cad8b4a' before making global git config changes
2025-12-16T13:45:15.7634409Z Adding repository directory to the temporary git global config as a safe directory
2025-12-16T13:45:15.7645470Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN
2025-12-16T13:45:15.7686766Z Deleting the contents of '/home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN'
2025-12-16T13:45:15.7690144Z ##[group]Initializing the repository
2025-12-16T13:45:15.7694168Z [command]/usr/bin/git init /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN
2025-12-16T13:45:15.7816480Z hint: Using 'master' as the name for the initial branch. This default branch name
2025-12-16T13:45:15.7817751Z hint: will change to "main" in Git 3.0. To configure the initial branch name
2025-12-16T13:45:15.7819111Z hint: to use in all of your new repositories, which will suppress this warning,
2025-12-16T13:45:15.7820047Z hint: call:
2025-12-16T13:45:15.7820672Z hint:
2025-12-16T13:45:15.7821526Z hint: 	git config --global init.defaultBranch <name>
2025-12-16T13:45:15.7822145Z hint:
2025-12-16T13:45:15.7823005Z hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
2025-12-16T13:45:15.7824647Z hint: 'development'. The just-created branch can be renamed via this command:
2025-12-16T13:45:15.7825944Z hint:
2025-12-16T13:45:15.7826629Z hint: 	git branch -m <name>
2025-12-16T13:45:15.7827462Z hint:
2025-12-16T13:45:15.7828583Z hint: Disable this message with "git config set advice.defaultBranchName false"
2025-12-16T13:45:15.7830769Z Initialized empty Git repository in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/.git/
2025-12-16T13:45:15.7835376Z [command]/usr/bin/git remote add origin https://github.com/cswasif/ZKS-Tunnel-VPN
2025-12-16T13:45:15.7870762Z ##[endgroup]
2025-12-16T13:45:15.7871999Z ##[group]Disabling automatic garbage collection
2025-12-16T13:45:15.7874903Z [command]/usr/bin/git config --local gc.auto 0
2025-12-16T13:45:15.7903490Z ##[endgroup]
2025-12-16T13:45:15.7904662Z ##[group]Setting up auth
2025-12-16T13:45:15.7911227Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-12-16T13:45:15.7941543Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-12-16T13:45:15.8305689Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-12-16T13:45:15.8335395Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-12-16T13:45:15.8551783Z [command]/usr/bin/git config --local --name-only --get-regexp ^includeIf\.gitdir:
2025-12-16T13:45:15.8581459Z [command]/usr/bin/git submodule foreach --recursive git config --local --show-origin --name-only --get-regexp remote.origin.url
2025-12-16T13:45:15.8807793Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***
2025-12-16T13:45:15.8841023Z ##[endgroup]
2025-12-16T13:45:15.8841815Z ##[group]Fetching the repository
2025-12-16T13:45:15.8849377Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +07e5b94c516c63d1da59149cb4db8a89630bdd19:refs/remotes/origin/master
2025-12-16T13:45:16.2743110Z From https://github.com/cswasif/ZKS-Tunnel-VPN
2025-12-16T13:45:16.2745157Z  * [new ref]         07e5b94c516c63d1da59149cb4db8a89630bdd19 -> origin/master
2025-12-16T13:45:16.2775379Z ##[endgroup]
2025-12-16T13:45:16.2776982Z ##[group]Determining the checkout info
2025-12-16T13:45:16.2778724Z ##[endgroup]
2025-12-16T13:45:16.2781786Z [command]/usr/bin/git sparse-checkout disable
2025-12-16T13:45:16.2821223Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2025-12-16T13:45:16.2846371Z ##[group]Checking out the ref
2025-12-16T13:45:16.2850009Z [command]/usr/bin/git checkout --progress --force -B master refs/remotes/origin/master
2025-12-16T13:45:16.2922128Z Reset branch 'master'
2025-12-16T13:45:16.2926321Z branch 'master' set up to track 'origin/master'.
2025-12-16T13:45:16.2933509Z ##[endgroup]
2025-12-16T13:45:16.2967270Z [command]/usr/bin/git log -1 --format=%H
2025-12-16T13:45:16.2988581Z 07e5b94c516c63d1da59149cb4db8a89630bdd19
2025-12-16T13:45:16.3461284Z ##[group]Run dtolnay/rust-toolchain@stable
2025-12-16T13:45:16.3462384Z with:
2025-12-16T13:45:16.3463093Z   components: rustfmt
2025-12-16T13:45:16.3463898Z   toolchain: stable
2025-12-16T13:45:16.3464639Z env:
2025-12-16T13:45:16.3465325Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:16.3466165Z ##[endgroup]
2025-12-16T13:45:16.3600508Z ##[group]Run : parse toolchain version
2025-12-16T13:45:16.3601852Z [36;1m: parse toolchain version[0m
2025-12-16T13:45:16.3602919Z [36;1mif [[ -z $toolchain ]]; then[0m
2025-12-16T13:45:16.3604832Z [36;1m  # GitHub does not enforce `required: true` inputs itself. https://github.com/actions/runner/issues/1070[0m
2025-12-16T13:45:16.3606750Z [36;1m  echo "'toolchain' is a required input" >&2[0m
2025-12-16T13:45:16.3608028Z [36;1m  exit 1[0m
2025-12-16T13:45:16.3609310Z [36;1melif [[ $toolchain =~ ^stable' '[0-9]+' '(year|month|week|day)s?' 'ago$ ]]; then[0m
2025-12-16T13:45:16.3610716Z [36;1m  if [[ Linux == macOS ]]; then[0m
2025-12-16T13:45:16.3612484Z [36;1m    echo "toolchain=1.$((($(date -v-$(sed 's/stable \([0-9]*\) \(.\).*/\1\2/' <<< $toolchain) +%s)/60/60/24-16569)/7/6))" >> $GITHUB_OUTPUT[0m
2025-12-16T13:45:16.3614207Z [36;1m  else[0m
2025-12-16T13:45:16.3615568Z [36;1m    echo "toolchain=1.$((($(date --date "${toolchain#stable }" +%s)/60/60/24-16569)/7/6))" >> $GITHUB_OUTPUT[0m
2025-12-16T13:45:16.3617130Z [36;1m  fi[0m
2025-12-16T13:45:16.3618159Z [36;1melif [[ $toolchain =~ ^stable' 'minus' '[0-9]+' 'releases?$ ]]; then[0m
2025-12-16T13:45:16.3620101Z [36;1m  echo "toolchain=1.$((($(date +%s)/60/60/24-16569)/7/6-${toolchain//[^0-9]/}))" >> $GITHUB_OUTPUT[0m
2025-12-16T13:45:16.3621682Z [36;1melif [[ $toolchain =~ ^1\.[0-9]+$ ]]; then[0m
2025-12-16T13:45:16.3623462Z [36;1m  echo "toolchain=1.$((i=${toolchain#1.}, c=($(date +%s)/60/60/24-16569)/7/6, i+9*i*(10*i<=c)+90*i*(100*i<=c)))" >> $GITHUB_OUTPUT[0m
2025-12-16T13:45:16.3625135Z [36;1melse[0m
2025-12-16T13:45:16.3625987Z [36;1m  echo "toolchain=$toolchain" >> $GITHUB_OUTPUT[0m
2025-12-16T13:45:16.3627042Z [36;1mfi[0m
2025-12-16T13:45:16.3664924Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:16.3666101Z env:
2025-12-16T13:45:16.3666758Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:16.3667577Z   toolchain: stable
2025-12-16T13:45:16.3668296Z ##[endgroup]
2025-12-16T13:45:16.3831315Z ##[group]Run : construct rustup command line
2025-12-16T13:45:16.3832428Z [36;1m: construct rustup command line[0m
2025-12-16T13:45:16.3833955Z [36;1mecho "targets=$(for t in ${targets//,/ }; do echo -n ' --target' $t; done)" >> $GITHUB_OUTPUT[0m
2025-12-16T13:45:16.3836095Z [36;1mecho "components=$(for c in ${components//,/ }; do echo -n ' --component' $c; done)" >> $GITHUB_OUTPUT[0m
2025-12-16T13:45:16.3837760Z [36;1mecho "downgrade=" >> $GITHUB_OUTPUT[0m
2025-12-16T13:45:16.3868493Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:16.3869819Z env:
2025-12-16T13:45:16.3870471Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:16.3871289Z   targets: 
2025-12-16T13:45:16.3871964Z   components: rustfmt
2025-12-16T13:45:16.3872703Z ##[endgroup]
2025-12-16T13:45:16.3976180Z ##[group]Run : set $CARGO_HOME
2025-12-16T13:45:16.3977031Z [36;1m: set $CARGO_HOME[0m
2025-12-16T13:45:16.3978119Z [36;1mecho CARGO_HOME=${CARGO_HOME:-"$HOME/.cargo"} >> $GITHUB_ENV[0m
2025-12-16T13:45:16.4009496Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:16.4010665Z env:
2025-12-16T13:45:16.4011316Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:16.4012086Z ##[endgroup]
2025-12-16T13:45:16.4114951Z ##[group]Run : install rustup if needed
2025-12-16T13:45:16.4115923Z [36;1m: install rustup if needed[0m
2025-12-16T13:45:16.4116903Z [36;1mif ! command -v rustup &>/dev/null; then[0m
2025-12-16T13:45:16.4119509Z [36;1m  curl --proto '=https' --tlsv1.2 --retry 10 --retry-connrefused --location --silent --show-error --fail https://sh.rustup.rs | sh -s -- --default-toolchain none -y[0m
2025-12-16T13:45:16.4122116Z [36;1m  echo "$CARGO_HOME/bin" >> $GITHUB_PATH[0m
2025-12-16T13:45:16.4123104Z [36;1mfi[0m
2025-12-16T13:45:16.4153704Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:16.4154835Z env:
2025-12-16T13:45:16.4155458Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:16.4156278Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:16.4157118Z ##[endgroup]
2025-12-16T13:45:16.4329234Z ##[group]Run rustup toolchain install stable --component rustfmt --profile minimal --no-self-update
2025-12-16T13:45:16.4331700Z [36;1mrustup toolchain install stable --component rustfmt --profile minimal --no-self-update[0m
2025-12-16T13:45:16.4363329Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:16.4364442Z env:
2025-12-16T13:45:16.4365069Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:16.4365937Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:16.4366767Z ##[endgroup]
2025-12-16T13:45:16.7566806Z info: syncing channel updates for 'stable-x86_64-unknown-linux-gnu'
2025-12-16T13:45:16.8886758Z info: latest update on 2025-12-11, rust version 1.92.0 (ded5c06cf 2025-12-08)
2025-12-16T13:45:16.9276322Z info: downloading component 'rustfmt'
2025-12-16T13:45:16.9448327Z info: downloading component 'clippy'
2025-12-16T13:45:16.9722672Z info: downloading component 'cargo'
2025-12-16T13:45:17.0202449Z info: downloading component 'rust-std'
2025-12-16T13:45:17.1503381Z info: downloading component 'rustc'
2025-12-16T13:45:17.4628631Z info: removing previous version of component 'clippy'
2025-12-16T13:45:17.4644970Z info: removing previous version of component 'rustfmt'
2025-12-16T13:45:17.4715138Z info: removing previous version of component 'cargo'
2025-12-16T13:45:17.4814800Z info: removing previous version of component 'rust-std'
2025-12-16T13:45:17.4892074Z info: removing previous version of component 'rustc'
2025-12-16T13:45:17.4950471Z info: installing component 'rustfmt'
2025-12-16T13:45:17.7272476Z info: installing component 'clippy'
2025-12-16T13:45:18.0998471Z info: installing component 'cargo'
2025-12-16T13:45:18.8030123Z info: installing component 'rust-std'
2025-12-16T13:45:20.6916983Z info: installing component 'rustc'
2025-12-16T13:45:25.2658263Z 
2025-12-16T13:45:25.2758264Z   stable-x86_64-unknown-linux-gnu updated - rustc 1.92.0 (ded5c06cf 2025-12-08) (from rustc 1.91.1 (ed61e7d7e 2025-11-07))
2025-12-16T13:45:25.2759459Z 
2025-12-16T13:45:25.2825197Z ##[group]Run rustup default stable
2025-12-16T13:45:25.2825510Z [36;1mrustup default stable[0m
2025-12-16T13:45:25.2860073Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:25.2860400Z env:
2025-12-16T13:45:25.2860573Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:25.2860809Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:25.2861044Z ##[endgroup]
2025-12-16T13:45:25.2964561Z info: using existing install for 'stable-x86_64-unknown-linux-gnu'
2025-12-16T13:45:25.3321869Z info: default toolchain set to 'stable-x86_64-unknown-linux-gnu'
2025-12-16T13:45:25.3322390Z 
2025-12-16T13:45:25.3409747Z   stable-x86_64-unknown-linux-gnu unchanged - rustc 1.92.0 (ded5c06cf 2025-12-08)
2025-12-16T13:45:25.3410120Z 
2025-12-16T13:45:25.3456532Z ##[group]Run : create cachekey
2025-12-16T13:45:25.3456805Z [36;1m: create cachekey[0m
2025-12-16T13:45:25.3457251Z [36;1mDATE=$(rustc +stable --version --verbose | sed -ne 's/^commit-date: \(20[0-9][0-9]\)-\([01][0-9]\)-\([0-3][0-9]\)$/\1\2\3/p')[0m
2025-12-16T13:45:25.3457823Z [36;1mHASH=$(rustc +stable --version --verbose | sed -ne 's/^commit-hash: //p')[0m
2025-12-16T13:45:25.3458302Z [36;1mecho "cachekey=$(echo $DATE$HASH | head -c12)" >> $GITHUB_OUTPUT[0m
2025-12-16T13:45:25.3493293Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:25.3493619Z env:
2025-12-16T13:45:25.3493797Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:25.3494018Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:25.3494244Z ##[endgroup]
2025-12-16T13:45:25.3877896Z ##[group]Run : disable incremental compilation
2025-12-16T13:45:25.3878506Z [36;1m: disable incremental compilation[0m
2025-12-16T13:45:25.3878831Z [36;1mif [ -z "${CARGO_INCREMENTAL+set}" ]; then[0m
2025-12-16T13:45:25.3879508Z [36;1m  echo CARGO_INCREMENTAL=0 >> $GITHUB_ENV[0m
2025-12-16T13:45:25.3879764Z [36;1mfi[0m
2025-12-16T13:45:25.3913517Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:25.3913868Z env:
2025-12-16T13:45:25.3914042Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:25.3914272Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:25.3914664Z ##[endgroup]
2025-12-16T13:45:25.3985945Z ##[group]Run : enable colors in Cargo output
2025-12-16T13:45:25.3986250Z [36;1m: enable colors in Cargo output[0m
2025-12-16T13:45:25.3986542Z [36;1mif [ -z "${CARGO_TERM_COLOR+set}" ]; then[0m
2025-12-16T13:45:25.3986866Z [36;1m  echo CARGO_TERM_COLOR=always >> $GITHUB_ENV[0m
2025-12-16T13:45:25.3987133Z [36;1mfi[0m
2025-12-16T13:45:25.4019797Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:25.4020112Z env:
2025-12-16T13:45:25.4020305Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:25.4020527Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:25.4020764Z   CARGO_INCREMENTAL: 0
2025-12-16T13:45:25.4020962Z ##[endgroup]
2025-12-16T13:45:25.4095884Z ##[group]Run : enable Cargo sparse registry
2025-12-16T13:45:25.4096195Z [36;1m: enable Cargo sparse registry[0m
2025-12-16T13:45:25.4096535Z [36;1m# implemented in 1.66, stabilized in 1.68, made default in 1.70[0m
2025-12-16T13:45:25.4097184Z [36;1mif [ -z "${CARGO_REGISTRIES_CRATES_IO_PROTOCOL+set}" -o -f "/home/runner/work/_temp"/.implicit_cargo_registries_crates_io_protocol ]; then[0m
2025-12-16T13:45:25.4097826Z [36;1m  if rustc +stable --version --verbose | grep -q '^release: 1\.6[89]\.'; then[0m
2025-12-16T13:45:25.4098339Z [36;1m    touch "/home/runner/work/_temp"/.implicit_cargo_registries_crates_io_protocol || true[0m
2025-12-16T13:45:25.4098818Z [36;1m    echo CARGO_REGISTRIES_CRATES_IO_PROTOCOL=sparse >> $GITHUB_ENV[0m
2025-12-16T13:45:25.4099494Z [36;1m  elif rustc +stable --version --verbose | grep -q '^release: 1\.6[67]\.'; then[0m
2025-12-16T13:45:25.4100011Z [36;1m    touch "/home/runner/work/_temp"/.implicit_cargo_registries_crates_io_protocol || true[0m
2025-12-16T13:45:25.4100471Z [36;1m    echo CARGO_REGISTRIES_CRATES_IO_PROTOCOL=git >> $GITHUB_ENV[0m
2025-12-16T13:45:25.4100779Z [36;1m  fi[0m
2025-12-16T13:45:25.4100952Z [36;1mfi[0m
2025-12-16T13:45:25.4133846Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:25.4134180Z env:
2025-12-16T13:45:25.4134356Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:25.4134582Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:25.4134828Z   CARGO_INCREMENTAL: 0
2025-12-16T13:45:25.4135015Z ##[endgroup]
2025-12-16T13:45:25.4499605Z ##[group]Run : work around spurious network errors in curl 8.0
2025-12-16T13:45:25.4500048Z [36;1m: work around spurious network errors in curl 8.0[0m
2025-12-16T13:45:25.4500595Z [36;1m# https://rust-lang.zulipchat.com/#narrow/stream/246057-t-cargo/topic/timeout.20investigation[0m
2025-12-16T13:45:25.4501174Z [36;1mif rustc +stable --version --verbose | grep -q '^release: 1\.7[01]\.'; then[0m
2025-12-16T13:45:25.4501589Z [36;1m  echo CARGO_HTTP_MULTIPLEXING=false >> $GITHUB_ENV[0m
2025-12-16T13:45:25.4501875Z [36;1mfi[0m
2025-12-16T13:45:25.4538324Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:25.4538639Z env:
2025-12-16T13:45:25.4538819Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:25.4539289Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:25.4539537Z   CARGO_INCREMENTAL: 0
2025-12-16T13:45:25.4539742Z ##[endgroup]
2025-12-16T13:45:25.4759956Z ##[group]Run rustc +stable --version --verbose
2025-12-16T13:45:25.4760305Z [36;1mrustc +stable --version --verbose[0m
2025-12-16T13:45:25.4795735Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-12-16T13:45:25.4796067Z env:
2025-12-16T13:45:25.4796246Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:25.4796471Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:25.4796711Z   CARGO_INCREMENTAL: 0
2025-12-16T13:45:25.4797070Z ##[endgroup]
2025-12-16T13:45:25.4972295Z rustc 1.92.0 (ded5c06cf 2025-12-08)
2025-12-16T13:45:25.4972858Z binary: rustc
2025-12-16T13:45:25.4973342Z commit-hash: ded5c06cf21d2b93bffd5d884aa6e96934ee4234
2025-12-16T13:45:25.4973960Z commit-date: 2025-12-08
2025-12-16T13:45:25.4974378Z host: x86_64-unknown-linux-gnu
2025-12-16T13:45:25.4974751Z release: 1.92.0
2025-12-16T13:45:25.4975291Z LLVM version: 21.1.3
2025-12-16T13:45:25.5049560Z ##[group]Run cargo fmt --all -- --check
2025-12-16T13:45:25.5049905Z [36;1mcargo fmt --all -- --check[0m
2025-12-16T13:45:25.5085932Z shell: /usr/bin/bash -e {0}
2025-12-16T13:45:25.5086181Z env:
2025-12-16T13:45:25.5086367Z   CARGO_TERM_COLOR: always
2025-12-16T13:45:25.5086592Z   CARGO_HOME: /home/runner/.cargo
2025-12-16T13:45:25.5086829Z   CARGO_INCREMENTAL: 0
2025-12-16T13:45:25.5087025Z ##[endgroup]
2025-12-16T13:45:25.6781915Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:17:
2025-12-16T13:45:25.6787784Z  use std::net::SocketAddr;
2025-12-16T13:45:25.6788073Z  use std::sync::Arc;
2025-12-16T13:45:25.6788310Z  use tokio::net::TcpListener;
2025-12-16T13:45:25.6788574Z -use tracing::{info, error, warn, Level};
2025-12-16T13:45:25.6789150Z +use tracing::{error, info, warn, Level};
2025-12-16T13:45:25.6789514Z  use tracing_subscriber::FmtSubscriber;
2025-12-16T13:45:25.6789769Z  
2025-12-16T13:45:25.6789930Z  mod socks5;
2025-12-16T13:45:25.6790512Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:24:
2025-12-16T13:45:25.6790934Z -mod tunnel;
2025-12-16T13:45:25.6791161Z  mod stream_manager;
2025-12-16T13:45:25.6791350Z +mod tunnel;
2025-12-16T13:45:25.6791527Z  mod vpn;
2025-12-16T13:45:25.6791686Z  
2025-12-16T13:45:25.6791872Z -use tunnel::TunnelClient;
2025-12-16T13:45:25.6792116Z  use socks5::Socks5Server;
2025-12-16T13:45:25.6792378Z -use vpn::{VpnController, VpnConfig};
2025-12-16T13:45:25.6792648Z +use tunnel::TunnelClient;
2025-12-16T13:45:25.6793006Z +use vpn::{VpnConfig, VpnController};
2025-12-16T13:45:25.6793415Z  
2025-12-16T13:45:25.6793716Z  /// Operating mode for the VPN client
2025-12-16T13:45:25.6794246Z  #[derive(Debug, Clone, Copy, ValueEnum, Default, PartialEq)]
2025-12-16T13:45:25.6795044Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:90:
2025-12-16T13:45:25.6795763Z      let args = Args::parse();
2025-12-16T13:45:25.6796110Z  
2025-12-16T13:45:25.6796401Z      // Initialize logging
2025-12-16T13:45:25.6796910Z -    let level = if args.verbose { Level::DEBUG } else { Level::INFO };
2025-12-16T13:45:25.6797491Z -    let subscriber = FmtSubscriber::builder()
2025-12-16T13:45:25.6797932Z -        .with_max_level(level)
2025-12-16T13:45:25.6798283Z -        .finish();
2025-12-16T13:45:25.6798604Z +    let level = if args.verbose {
2025-12-16T13:45:25.6799139Z +        Level::DEBUG
2025-12-16T13:45:25.6799385Z +    } else {
2025-12-16T13:45:25.6799559Z +        Level::INFO
2025-12-16T13:45:25.6799745Z +    };
2025-12-16T13:45:25.6800034Z +    let subscriber = FmtSubscriber::builder().with_max_level(level).finish();
2025-12-16T13:45:25.6800480Z      tracing::subscriber::set_global_default(subscriber)?;
2025-12-16T13:45:25.6800756Z  
2025-12-16T13:45:25.6800917Z      // Display banner
2025-12-16T13:45:25.6801308Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:119:
2025-12-16T13:45:25.6802102Z      info!("║         ZKS-Tunnel VPN - Serverless & Free                   ║");
2025-12-16T13:45:25.6802593Z      info!("╠══════════════════════════════════════════════════════════════╣");
2025-12-16T13:45:25.6802927Z      info!("║  Worker: {}  ", args.worker);
2025-12-16T13:45:25.6803168Z -    
2025-12-16T13:45:25.6803322Z +
2025-12-16T13:45:25.6803478Z      match args.mode {
2025-12-16T13:45:25.6803687Z          Mode::Socks5 => {
2025-12-16T13:45:25.6804047Z              info!("║  Mode:   SOCKS5 Proxy (browser only)                        ║");
2025-12-16T13:45:25.6804546Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:126:
2025-12-16T13:45:25.6805088Z -            info!("║  Listen: {}:{}                                  ", args.bind, args.port);
2025-12-16T13:45:25.6805394Z +            info!(
2025-12-16T13:45:25.6805665Z +                "║  Listen: {}:{}                                  ",
2025-12-16T13:45:25.6805949Z +                args.bind, args.port
2025-12-16T13:45:25.6806527Z +            );
2025-12-16T13:45:25.6806872Z          }
2025-12-16T13:45:25.6807057Z          Mode::Vpn => {
2025-12-16T13:45:25.6807414Z              info!("║  Mode:   System-Wide VPN (all traffic)                      ║");
2025-12-16T13:45:25.6807913Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:130:
2025-12-16T13:45:25.6808428Z -            info!("║  TUN:    {}                                             ", args.tun_name);
2025-12-16T13:45:25.6808846Z -            info!("║  VPN IP: {}                                          ", args.vpn_address);
2025-12-16T13:45:25.6809411Z +            info!(
2025-12-16T13:45:25.6809702Z +                "║  TUN:    {}                                             ",
2025-12-16T13:45:25.6809978Z +                args.tun_name
2025-12-16T13:45:25.6810182Z +            );
2025-12-16T13:45:25.6810356Z +            info!(
2025-12-16T13:45:25.6810621Z +                "║  VPN IP: {}                                          ",
2025-12-16T13:45:25.6810945Z +                args.vpn_address
2025-12-16T13:45:25.6811157Z +            );
2025-12-16T13:45:25.6811325Z          }
2025-12-16T13:45:25.6811476Z      }
2025-12-16T13:45:25.6811630Z -    
2025-12-16T13:45:25.6811788Z +
2025-12-16T13:45:25.6812097Z      info!("╚══════════════════════════════════════════════════════════════╝");
2025-12-16T13:45:25.6812373Z  }
2025-12-16T13:45:25.6812514Z  
2025-12-16T13:45:25.6812851Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:139:
2025-12-16T13:45:25.6813387Z  async fn run_socks5_mode(args: Args, tunnel: TunnelClient) -> Result<(), BoxError> {
2025-12-16T13:45:25.6813866Z      let bind_addr: SocketAddr = format!("{}:{}", args.bind, args.port).parse()?;
2025-12-16T13:45:25.6814268Z      let listener = TcpListener::bind(bind_addr).await?;
2025-12-16T13:45:25.6814530Z -    
2025-12-16T13:45:25.6814679Z +
2025-12-16T13:45:25.6814933Z      info!("🚀 SOCKS5 proxy listening on {}", bind_addr);
2025-12-16T13:45:25.6815372Z -    info!("   Configure your browser to use SOCKS5 proxy: {}:{}", args.bind, args.port);
2025-12-16T13:45:25.6815750Z +    info!(
2025-12-16T13:45:25.6815979Z +        "   Configure your browser to use SOCKS5 proxy: {}:{}",
2025-12-16T13:45:25.6816267Z +        args.bind, args.port
2025-12-16T13:45:25.6816472Z +    );
2025-12-16T13:45:25.6816622Z      info!("");
2025-12-16T13:45:25.6816937Z      info!("   Firefox: Settings → Network → Manual proxy → SOCKS5");
2025-12-16T13:45:25.6817276Z      info!("   Chrome:  Use SwitchyOmega extension");
2025-12-16T13:45:25.6817718Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:161:
2025-12-16T13:45:25.6818204Z          error!("   Rebuild with: cargo build --release --features vpn");
2025-12-16T13:45:25.6818549Z          return Err("VPN feature not enabled".into());
2025-12-16T13:45:25.6818801Z      }
2025-12-16T13:45:25.6819120Z -    
2025-12-16T13:45:25.6819311Z +
2025-12-16T13:45:25.6819472Z      #[cfg(feature = "vpn")]
2025-12-16T13:45:25.6819725Z      {
2025-12-16T13:45:25.6819905Z          // Check for admin/root privileges
2025-12-16T13:45:25.6820333Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:168:
2025-12-16T13:45:25.6820761Z          check_privileges()?;
2025-12-16T13:45:25.6820969Z -        
2025-12-16T13:45:25.6821127Z +
2025-12-16T13:45:25.6821395Z          let vpn_addr: std::net::Ipv4Addr = args.vpn_address.parse()?;
2025-12-16T13:45:25.6821694Z -        
2025-12-16T13:45:25.6821843Z +
2025-12-16T13:45:25.6822019Z          let config = VpnConfig {
2025-12-16T13:45:25.6822283Z              device_name: args.tun_name.clone(),
2025-12-16T13:45:25.6822555Z              address: vpn_addr,
2025-12-16T13:45:25.6822964Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:177:
2025-12-16T13:45:25.6823401Z              dns_protection: args.dns_protection,
2025-12-16T13:45:25.6823690Z              kill_switch: args.kill_switch,
2025-12-16T13:45:25.6824088Z          };
2025-12-16T13:45:25.6824363Z -        
2025-12-16T13:45:25.6824511Z +
2025-12-16T13:45:25.6824763Z          info!("🔒 Starting system-wide VPN...");
2025-12-16T13:45:25.6825105Z          info!("   All traffic will be routed through the tunnel.");
2025-12-16T13:45:25.6825391Z -        
2025-12-16T13:45:25.6825537Z +
2025-12-16T13:45:25.6825713Z          if args.kill_switch {
2025-12-16T13:45:25.6826029Z              info!("   Kill switch: ENABLED (traffic blocked if VPN drops)");
2025-12-16T13:45:25.6826328Z          }
2025-12-16T13:45:25.6826701Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:187:
2025-12-16T13:45:25.6827087Z -        
2025-12-16T13:45:25.6827237Z +
2025-12-16T13:45:25.6827407Z          if args.dns_protection {
2025-12-16T13:45:25.6827713Z              info!("   DNS protection: ENABLED (queries via DoH)");
2025-12-16T13:45:25.6827980Z          }
2025-12-16T13:45:25.6828380Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:191:
2025-12-16T13:45:25.6828855Z -        
2025-12-16T13:45:25.6829251Z +
2025-12-16T13:45:25.6829457Z          let tunnel = Arc::new(tunnel);
2025-12-16T13:45:25.6829773Z          let vpn = VpnController::new(tunnel, config);
2025-12-16T13:45:25.6830033Z -        
2025-12-16T13:45:25.6830187Z +
2025-12-16T13:45:25.6830351Z          vpn.start().await?;
2025-12-16T13:45:25.6830556Z -        
2025-12-16T13:45:25.6830702Z +
2025-12-16T13:45:25.6830867Z          // Wait for Ctrl+C
2025-12-16T13:45:25.6831069Z          info!("");
2025-12-16T13:45:25.6831306Z          info!("Press Ctrl+C to disconnect VPN...");
2025-12-16T13:45:25.6831840Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:200:
2025-12-16T13:45:25.6832539Z -        
2025-12-16T13:45:25.6832816Z +
2025-12-16T13:45:25.6833125Z          tokio::signal::ctrl_c().await?;
2025-12-16T13:45:25.6833518Z -        
2025-12-16T13:45:25.6833766Z +
2025-12-16T13:45:25.6834027Z          info!("");
2025-12-16T13:45:25.6834390Z          info!("Shutting down VPN...");
2025-12-16T13:45:25.6834810Z          vpn.stop().await?;
2025-12-16T13:45:25.6835479Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:206:
2025-12-16T13:45:25.6836050Z -        
2025-12-16T13:45:25.6836202Z +
2025-12-16T13:45:25.6836355Z          Ok(())
2025-12-16T13:45:25.6836525Z      }
2025-12-16T13:45:25.6836673Z -    
2025-12-16T13:45:25.6836832Z +
2025-12-16T13:45:25.6837001Z      #[cfg(not(feature = "vpn"))]
2025-12-16T13:45:25.6837218Z      Ok(())
2025-12-16T13:45:25.6837366Z  }
2025-12-16T13:45:25.6837857Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:221:
2025-12-16T13:45:25.6858697Z          warn!("⚠️  VPN mode requires Administrator privileges on Windows");
2025-12-16T13:45:25.6859714Z          warn!("   Right-click zks-vpn.exe → Run as administrator");
2025-12-16T13:45:25.6860202Z      }
2025-12-16T13:45:25.6860477Z -    
2025-12-16T13:45:25.6860720Z +
2025-12-16T13:45:25.6861040Z      #[cfg(unix)]
2025-12-16T13:45:25.6861339Z      {
2025-12-16T13:45:25.6861720Z          use std::os::unix::fs::MetadataExt;
2025-12-16T13:45:25.6862514Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/main.rs:231:
2025-12-16T13:45:25.6863379Z              return Err("Root privileges required for VPN mode".into());
2025-12-16T13:45:25.6863937Z          }
2025-12-16T13:45:25.6864229Z      }
2025-12-16T13:45:25.6864506Z -    
2025-12-16T13:45:25.6864767Z +
2025-12-16T13:45:25.6865033Z      Ok(())
2025-12-16T13:45:25.6865288Z  }
2025-12-16T13:45:25.6865540Z  
2025-12-16T13:45:25.6866267Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/socks5.rs:3:
2025-12-16T13:45:25.6867165Z  //! Implements RFC 1928 (SOCKS5) for proxying TCP connections.
2025-12-16T13:45:25.6867879Z  //! Only supports CONNECT command (not BIND or UDP ASSOCIATE).
2025-12-16T13:45:25.6868442Z  
2025-12-16T13:45:25.6868790Z -use tokio::net::{TcpListener, TcpStream};
2025-12-16T13:45:25.6870007Z -use tokio::io::{AsyncReadExt, AsyncWriteExt};
2025-12-16T13:45:25.6870525Z -use std::sync::Arc;
2025-12-16T13:45:25.6870914Z -use tracing::{info, error, debug};
2025-12-16T13:45:25.6871364Z  use crate::tunnel::TunnelClient;
2025-12-16T13:45:25.6871768Z +use std::sync::Arc;
2025-12-16T13:45:25.6872253Z +use tokio::io::{AsyncReadExt, AsyncWriteExt};
2025-12-16T13:45:25.6872789Z +use tokio::net::{TcpListener, TcpStream};
2025-12-16T13:45:25.6873297Z +use tracing::{debug, error, info};
2025-12-16T13:45:25.6873673Z  
2025-12-16T13:45:25.6873959Z  /// SOCKS5 versions
2025-12-16T13:45:25.6874231Z  const SOCKS_VERSION: u8 = 0x05;
2025-12-16T13:45:25.6874684Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/socks5.rs:42:
2025-12-16T13:45:25.6875097Z          }
2025-12-16T13:45:25.6875256Z      }
2025-12-16T13:45:25.6875412Z  
2025-12-16T13:45:25.6875854Z -    pub async fn run(&self, listener: TcpListener) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.6876323Z +    pub async fn run(
2025-12-16T13:45:25.6876520Z +        &self,
2025-12-16T13:45:25.6876728Z +        listener: TcpListener,
2025-12-16T13:45:25.6877040Z +    ) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.6877328Z          loop {
2025-12-16T13:45:25.6877567Z              let (stream, addr) = listener.accept().await?;
2025-12-16T13:45:25.6877902Z              debug!("New SOCKS5 connection from {}", addr);
2025-12-16T13:45:25.6878410Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/stream_manager.rs:2:
2025-12-16T13:45:25.6878827Z  //!
2025-12-16T13:45:25.6879355Z  //! Each stream corresponds to one TCP connection being proxied.
2025-12-16T13:45:25.6879655Z  
2025-12-16T13:45:25.6879836Z +use bytes::Bytes;
2025-12-16T13:45:25.6880050Z  use std::collections::HashMap;
2025-12-16T13:45:25.6880292Z  use tokio::sync::mpsc;
2025-12-16T13:45:25.6880496Z -use bytes::Bytes;
2025-12-16T13:45:25.6880725Z  use zks_tunnel_proto::StreamId;
2025-12-16T13:45:25.6880948Z  
2025-12-16T13:45:25.6881109Z  #[allow(dead_code)]
2025-12-16T13:45:25.6881551Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/stream_manager.rs:29:
2025-12-16T13:45:25.6882128Z      pub fn create_stream(&mut self, id: StreamId) -> mpsc::Receiver<Bytes> {
2025-12-16T13:45:25.6882508Z          let (tx, rx) = mpsc::channel(100);
2025-12-16T13:45:25.6882831Z          let (_out_tx, out_rx) = mpsc::channel::<Bytes>(100);
2025-12-16T13:45:25.6883106Z -        
2025-12-16T13:45:25.6883263Z +
2025-12-16T13:45:25.6883518Z          self.streams.insert(id, StreamState { tx, rx: out_rx });
2025-12-16T13:45:25.6883815Z          rx
2025-12-16T13:45:25.6883972Z      }
2025-12-16T13:45:25.6884375Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/stream_manager.rs:46:
2025-12-16T13:45:25.6884792Z          }
2025-12-16T13:45:25.6884955Z      }
2025-12-16T13:45:25.6885104Z  }
2025-12-16T13:45:25.6885253Z -
2025-12-16T13:45:25.6885413Z  
2025-12-16T13:45:25.6885776Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:6:
2025-12-16T13:45:25.6886215Z  //! - Connection keepalive via ping/pong
2025-12-16T13:45:25.6886508Z  //! - Memory-efficient buffer management
2025-12-16T13:45:25.6886737Z  
2025-12-16T13:45:25.6886910Z -use tokio::net::TcpStream;
2025-12-16T13:45:25.6887158Z -use tokio::sync::{mpsc, Mutex};
2025-12-16T13:45:25.6887591Z -use tokio_tungstenite::{connect_async, tungstenite::Message, WebSocketStream, MaybeTlsStream};
2025-12-16T13:45:25.6888007Z +use bytes::Bytes;
2025-12-16T13:45:25.6888214Z  use futures::{SinkExt, StreamExt};
2025-12-16T13:45:25.6888466Z  use std::collections::HashMap;
2025-12-16T13:45:25.6888685Z -use std::sync::Arc;
2025-12-16T13:45:25.6889125Z  use std::sync::atomic::{AtomicU32, Ordering};
2025-12-16T13:45:25.6889437Z -use tracing::{info, error, debug, warn};
2025-12-16T13:45:25.6889737Z -use zks_tunnel_proto::{TunnelMessage, StreamId};
2025-12-16T13:45:25.6890186Z -use bytes::Bytes;
2025-12-16T13:45:25.6890485Z +use std::sync::Arc;
2025-12-16T13:45:25.6890731Z  use tokio::io::{AsyncReadExt, AsyncWriteExt};
2025-12-16T13:45:25.6891001Z +use tokio::net::TcpStream;
2025-12-16T13:45:25.6891230Z +use tokio::sync::{mpsc, Mutex};
2025-12-16T13:45:25.6891655Z +use tokio_tungstenite::{connect_async, tungstenite::Message, MaybeTlsStream, WebSocketStream};
2025-12-16T13:45:25.6892102Z +use tracing::{debug, error, info, warn};
2025-12-16T13:45:25.6892410Z +use zks_tunnel_proto::{StreamId, TunnelMessage};
2025-12-16T13:45:25.6892661Z  
2025-12-16T13:45:25.6892818Z  #[allow(dead_code)]
2025-12-16T13:45:25.6893140Z  type WsStream = WebSocketStream<MaybeTlsStream<tokio::net::TcpStream>>;
2025-12-16T13:45:25.6893683Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:40:
2025-12-16T13:45:25.6894180Z      /// Connect to the ZKS-Tunnel Worker with automatic reconnection
2025-12-16T13:45:25.6894689Z      pub async fn connect_ws(url: &str) -> Result<Self, Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.6895160Z          info!("Connecting to ZKS-Tunnel Worker at {}", url);
2025-12-16T13:45:25.6895429Z -        
2025-12-16T13:45:25.6895585Z +
2025-12-16T13:45:25.6895819Z          let (ws_stream, response) = connect_async(url).await?;
2025-12-16T13:45:25.6896198Z          info!("WebSocket connected (status: {})", response.status());
2025-12-16T13:45:25.6896487Z  
2025-12-16T13:45:25.6896857Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:50:
2025-12-16T13:45:25.6897376Z          let (sender, mut receiver) = mpsc::channel::<TunnelMessage>(256);
2025-12-16T13:45:25.6897683Z  
2025-12-16T13:45:25.6897933Z          // Streams map - shared between reader task and main client
2025-12-16T13:45:25.6898316Z -        let streams: Arc<Mutex<HashMap<StreamId, StreamState>>> = 
2025-12-16T13:45:25.6898702Z +        let streams: Arc<Mutex<HashMap<StreamId, StreamState>>> =
2025-12-16T13:45:25.6899227Z              Arc::new(Mutex::new(HashMap::new()));
2025-12-16T13:45:25.6899530Z          let streams_clone = streams.clone();
2025-12-16T13:45:25.6899762Z  
2025-12-16T13:45:25.6900116Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:89:
2025-12-16T13:45:25.6900559Z                                      streams.remove(&stream_id);
2025-12-16T13:45:25.6900893Z                                      debug!("Stream {} closed by server", stream_id);
2025-12-16T13:45:25.6901187Z                                  }
2025-12-16T13:45:25.6901521Z -                                TunnelMessage::ErrorReply { stream_id, code, message } => {
2025-12-16T13:45:25.6901959Z -                                    error!("Stream {} error: {} (code {})", stream_id, message, code);
2025-12-16T13:45:25.6902336Z +                                TunnelMessage::ErrorReply {
2025-12-16T13:45:25.6902633Z +                                    stream_id,
2025-12-16T13:45:25.6902892Z +                                    code,
2025-12-16T13:45:25.6903158Z +                                    message,
2025-12-16T13:45:25.6903400Z +                                } => {
2025-12-16T13:45:25.6903637Z +                                    error!(
2025-12-16T13:45:25.6903913Z +                                        "Stream {} error: {} (code {})",
2025-12-16T13:45:25.6904213Z +                                        stream_id, message, code
2025-12-16T13:45:25.6904481Z +                                    );
2025-12-16T13:45:25.6904769Z                                      let mut streams = streams_clone.lock().await;
2025-12-16T13:45:25.6905092Z                                      streams.remove(&stream_id);
2025-12-16T13:45:25.6905359Z                                  }
2025-12-16T13:45:25.6905773Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:170:
2025-12-16T13:45:25.6906248Z          let local_to_tunnel = tokio::spawn(async move {
2025-12-16T13:45:25.6906702Z              // Use a reasonably sized buffer for efficiency
2025-12-16T13:45:25.6907125Z              let mut buf = vec![0u8; 16384]; // 16KB buffer
2025-12-16T13:45:25.6907374Z -            
2025-12-16T13:45:25.6907548Z +
2025-12-16T13:45:25.6907698Z              loop {
2025-12-16T13:45:25.6907924Z                  match read_half.read(&mut buf).await {
2025-12-16T13:45:25.6908189Z                      Ok(0) => {
2025-12-16T13:45:25.6908584Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/tunnel.rs:221:
2025-12-16T13:45:25.6909171Z          }
2025-12-16T13:45:25.6909328Z  
2025-12-16T13:45:25.6909513Z          // Send close command to server
2025-12-16T13:45:25.6909881Z -        let _ = sender_for_close.send(TunnelMessage::Close { stream_id }).await;
2025-12-16T13:45:25.6910224Z +        let _ = sender_for_close
2025-12-16T13:45:25.6910489Z +            .send(TunnelMessage::Close { stream_id })
2025-12-16T13:45:25.6910748Z +            .await;
2025-12-16T13:45:25.6910919Z  
2025-12-16T13:45:25.6911096Z          // Clean up stream
2025-12-16T13:45:25.6911303Z          {
2025-12-16T13:45:25.6949723Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:19:
2025-12-16T13:45:25.6950725Z  
2025-12-16T13:45:25.6951084Z  #[cfg(feature = "vpn")]
2025-12-16T13:45:25.6951525Z  mod implementation {
2025-12-16T13:45:25.6952016Z +    use futures::{SinkExt, StreamExt};
2025-12-16T13:45:25.6952554Z      use std::net::Ipv4Addr;
2025-12-16T13:45:25.6953032Z -    use std::sync::Arc;
2025-12-16T13:45:25.6953572Z -    use std::sync::atomic::{AtomicBool, Ordering};
2025-12-16T13:45:25.6954174Z      use std::process::Command;
2025-12-16T13:45:25.6954652Z -    use tokio::sync::Mutex;
2025-12-16T13:45:25.6955173Z +    use std::sync::atomic::{AtomicBool, Ordering};
2025-12-16T13:45:25.6955622Z +    use std::sync::Arc;
2025-12-16T13:45:25.6956075Z      use tokio::io::{AsyncReadExt, AsyncWriteExt}; // Still needed for tunnel stream
2025-12-16T13:45:25.6956585Z -    use tracing::{info, error, debug};
2025-12-16T13:45:25.6957052Z -    use futures::{StreamExt, SinkExt}; // Needed for Stack stream/sink
2025-12-16T13:45:25.6957372Z -    
2025-12-16T13:45:25.6957559Z +    use tokio::sync::Mutex;
2025-12-16T13:45:25.6957869Z +    use tracing::{debug, error, info}; // Needed for Stack stream/sink
2025-12-16T13:45:25.6958172Z +
2025-12-16T13:45:25.6958354Z      use crate::tunnel::TunnelClient;
2025-12-16T13:45:25.6958629Z      use zks_tunnel_proto::TunnelMessage;
2025-12-16T13:45:25.6958862Z -    
2025-12-16T13:45:25.6959280Z +
2025-12-16T13:45:25.6959479Z      // Import netstack-smoltcp types
2025-12-16T13:45:25.6959741Z      #[cfg(feature = "vpn")]
2025-12-16T13:45:25.6959988Z      use netstack_smoltcp::StackBuilder;
2025-12-16T13:45:25.6960428Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:37:
2025-12-16T13:45:25.6960814Z -    
2025-12-16T13:45:25.6960961Z +
2025-12-16T13:45:25.6961132Z      #[cfg(feature = "vpn")]
2025-12-16T13:45:25.6961351Z      use reqwest::Client;
2025-12-16T13:45:25.6961564Z -    
2025-12-16T13:45:25.6961710Z +
2025-12-16T13:45:25.6961880Z      /// VPN configuration
2025-12-16T13:45:25.6962098Z      #[derive(Debug, Clone)]
2025-12-16T13:45:25.6962315Z      #[allow(dead_code)]
2025-12-16T13:45:25.6962699Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:55:
2025-12-16T13:45:25.6963166Z          /// Enable kill switch (block traffic if disconnected)
2025-12-16T13:45:25.6963473Z          pub kill_switch: bool,
2025-12-16T13:45:25.6963679Z      }
2025-12-16T13:45:25.6963840Z -    
2025-12-16T13:45:25.6963986Z +
2025-12-16T13:45:25.6964165Z      impl Default for VpnConfig {
2025-12-16T13:45:25.6964404Z          fn default() -> Self {
2025-12-16T13:45:25.6964615Z              Self {
2025-12-16T13:45:25.6965093Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:68:
2025-12-16T13:45:25.6965755Z              }
2025-12-16T13:45:25.6966013Z          }
2025-12-16T13:45:25.6966177Z      }
2025-12-16T13:45:25.6966633Z -    
2025-12-16T13:45:25.6966787Z +
2025-12-16T13:45:25.6966957Z      /// VPN connection state
2025-12-16T13:45:25.6967216Z      #[derive(Debug, Clone, Copy, PartialEq, Eq)]
2025-12-16T13:45:25.6967507Z      pub enum VpnState {
2025-12-16T13:45:25.6967887Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:77:
2025-12-16T13:45:25.6968274Z          Connected,
2025-12-16T13:45:25.6968460Z          Disconnecting,
2025-12-16T13:45:25.6968650Z      }
2025-12-16T13:45:25.6968796Z -    
2025-12-16T13:45:25.6969072Z +
2025-12-16T13:45:25.6969267Z      /// Statistics for the VPN connection
2025-12-16T13:45:25.6969525Z      #[derive(Debug, Default)]
2025-12-16T13:45:25.6969753Z      pub struct VpnStats {
2025-12-16T13:45:25.6970140Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:87:
2025-12-16T13:45:25.6970551Z          pub packets_received: u64,
2025-12-16T13:45:25.6970801Z          pub connections_opened: u64,
2025-12-16T13:45:25.6971043Z      }
2025-12-16T13:45:25.6971189Z -    
2025-12-16T13:45:25.6971337Z +
2025-12-16T13:45:25.6971564Z      /// System-Wide VPN controller with full TUN integration
2025-12-16T13:45:25.6971875Z      pub struct VpnController {
2025-12-16T13:45:25.6972124Z          config: VpnConfig,
2025-12-16T13:45:25.6972507Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:99:
2025-12-16T13:45:25.6972911Z          #[cfg(target_os = "windows")]
2025-12-16T13:45:25.6973197Z          original_fw_policy: Arc<Mutex<Option<String>>>,
2025-12-16T13:45:25.6973455Z      }
2025-12-16T13:45:25.6973600Z -    
2025-12-16T13:45:25.6973751Z +
2025-12-16T13:45:25.6973915Z      impl VpnController {
2025-12-16T13:45:25.6974155Z          /// Create a new VPN controller
2025-12-16T13:45:25.6974502Z          pub fn new(tunnel: Arc<TunnelClient>, config: VpnConfig) -> Self {
2025-12-16T13:45:25.6975002Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:117:
2025-12-16T13:45:25.6975489Z                  original_fw_policy: Arc::new(Mutex::new(None)),
2025-12-16T13:45:25.6975756Z              }
2025-12-16T13:45:25.6975924Z          }
2025-12-16T13:45:25.6976078Z -        
2025-12-16T13:45:25.6976232Z +
2025-12-16T13:45:25.6976473Z          /// Start the VPN (create TUN device and begin routing traffic)
2025-12-16T13:45:25.6976933Z          pub async fn start(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.6977326Z              let mut state = self.state.lock().await;
2025-12-16T13:45:25.6977769Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:126:
2025-12-16T13:45:25.6978157Z              }
2025-12-16T13:45:25.6978362Z              *state = VpnState::Connecting;
2025-12-16T13:45:25.6978610Z              drop(state);
2025-12-16T13:45:25.6978802Z -            
2025-12-16T13:45:25.6979072Z +
2025-12-16T13:45:25.6979268Z              info!("Starting system-wide VPN...");
2025-12-16T13:45:25.6979593Z              info!("  Device: {}", self.config.device_name);
2025-12-16T13:45:25.6979974Z              info!("  Address: {}/{}", self.config.address, self.config.netmask);
2025-12-16T13:45:25.6980470Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:133:
2025-12-16T13:45:25.6980893Z              info!("  MTU: {}", self.config.mtu);
2025-12-16T13:45:25.6981127Z -            
2025-12-16T13:45:25.6981293Z +
2025-12-16T13:45:25.6981512Z              self.running.store(true, Ordering::SeqCst);
2025-12-16T13:45:25.6981771Z -            
2025-12-16T13:45:25.6981926Z +
2025-12-16T13:45:25.6982122Z              // Optional: enable OS-level kill switch
2025-12-16T13:45:25.6982407Z              if self.config.kill_switch {
2025-12-16T13:45:25.6982710Z                  if let Err(e) = self.enable_kill_switch().await {
2025-12-16T13:45:25.6983167Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:143:
2025-12-16T13:45:25.6983541Z  
2025-12-16T13:45:25.6983995Z              // Create TUN device and start packet processing
2025-12-16T13:45:25.6984292Z              self.run_tun_loop().await?;
2025-12-16T13:45:25.6984524Z -            
2025-12-16T13:45:25.6984676Z +
2025-12-16T13:45:25.6984873Z              let mut state = self.state.lock().await;
2025-12-16T13:45:25.6985162Z              *state = VpnState::Connected;
2025-12-16T13:45:25.6985393Z -            
2025-12-16T13:45:25.6985552Z +
2025-12-16T13:45:25.6985842Z              info!("✅ System-wide VPN is now active!");
2025-12-16T13:45:25.6986190Z              info!("   All traffic is being routed through the tunnel.");
2025-12-16T13:45:25.6986474Z -            
2025-12-16T13:45:25.6986634Z +
2025-12-16T13:45:25.6986783Z              Ok(())
2025-12-16T13:45:25.6986969Z          }
2025-12-16T13:45:25.6987123Z -        
2025-12-16T13:45:25.6987277Z +
2025-12-16T13:45:25.6987432Z          /// Stop the VPN
2025-12-16T13:45:25.6987803Z          pub async fn stop(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.6988463Z              let mut state = self.state.lock().await;
2025-12-16T13:45:25.6989354Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:161:
2025-12-16T13:45:25.6990034Z              }
2025-12-16T13:45:25.6990385Z              *state = VpnState::Disconnecting;
2025-12-16T13:45:25.6990808Z              drop(state);
2025-12-16T13:45:25.6991119Z -            
2025-12-16T13:45:25.6991393Z +
2025-12-16T13:45:25.6991618Z              info!("Stopping system-wide VPN...");
2025-12-16T13:45:25.6991878Z -            
2025-12-16T13:45:25.6992039Z +
2025-12-16T13:45:25.6992214Z              // Signal the TUN loop to stop
2025-12-16T13:45:25.6992517Z              self.running.store(false, Ordering::SeqCst);
2025-12-16T13:45:25.6992772Z  
2025-12-16T13:45:25.6993111Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:173:
2025-12-16T13:45:25.6993560Z                      error!("Failed to disable kill switch: {}", e);
2025-12-16T13:45:25.6993859Z                  }
2025-12-16T13:45:25.6994068Z              }
2025-12-16T13:45:25.6994240Z -            
2025-12-16T13:45:25.6994394Z +
2025-12-16T13:45:25.6994590Z              let mut state = self.state.lock().await;
2025-12-16T13:45:25.6994883Z              *state = VpnState::Disconnected;
2025-12-16T13:45:25.6995116Z -            
2025-12-16T13:45:25.6995281Z +
2025-12-16T13:45:25.6995442Z              // Print stats
2025-12-16T13:45:25.6995681Z              let stats = self.stats.lock().await;
2025-12-16T13:45:25.6995946Z              info!("VPN Statistics:");
2025-12-16T13:45:25.6996362Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:185:
2025-12-16T13:45:25.6996803Z              info!("  Packets sent: {}", stats.packets_sent);
2025-12-16T13:45:25.6997149Z              info!("  Packets received: {}", stats.packets_received);
2025-12-16T13:45:25.6997530Z              info!("  Connections opened: {}", stats.connections_opened);
2025-12-16T13:45:25.6997833Z -            
2025-12-16T13:45:25.6997991Z +
2025-12-16T13:45:25.6998233Z              info!("✅ System-wide VPN stopped.");
2025-12-16T13:45:25.6998477Z -            
2025-12-16T13:45:25.6998630Z +
2025-12-16T13:45:25.6998780Z              Ok(())
2025-12-16T13:45:25.6999151Z          }
2025-12-16T13:45:25.6999342Z -        
2025-12-16T13:45:25.6999496Z +
2025-12-16T13:45:25.6999750Z          /// Main TUN device loop - creates device and processes packets
2025-12-16T13:45:25.7000226Z          async fn run_tun_loop(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7000603Z              info!("Creating TUN device...");
2025-12-16T13:45:25.7001037Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:197:
2025-12-16T13:45:25.7001423Z -            
2025-12-16T13:45:25.7001582Z +
2025-12-16T13:45:25.7001765Z              // Use tun-rs DeviceBuilder API (v2)
2025-12-16T13:45:25.7002345Z              #[cfg(any(target_os = "linux", target_os = "macos", target_os = "windows"))]
2025-12-16T13:45:25.7002786Z              {
2025-12-16T13:45:25.7003145Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:202:
2025-12-16T13:45:25.7003649Z                      .ipv4(self.config.address, 24, None) // Hardcoded /24 for testing
2025-12-16T13:45:25.7003996Z                      .mtu(self.config.mtu)
2025-12-16T13:45:25.7004255Z                      .build_async()?;
2025-12-16T13:45:25.7004473Z -                
2025-12-16T13:45:25.7004749Z +
2025-12-16T13:45:25.7005057Z                  // Run the netstack with the device
2025-12-16T13:45:25.7005525Z                  self.run_netstack(device).await?;
2025-12-16T13:45:25.7005863Z -                
2025-12-16T13:45:25.7006034Z +
2025-12-16T13:45:25.7006192Z                  Ok(())
2025-12-16T13:45:25.7006373Z              }
2025-12-16T13:45:25.7006539Z -            
2025-12-16T13:45:25.7006696Z +
2025-12-16T13:45:25.7007001Z              #[cfg(not(any(target_os = "linux", target_os = "macos", target_os = "windows")))]
2025-12-16T13:45:25.7007348Z              {
2025-12-16T13:45:25.7007616Z                  Err("TUN devices are not supported on this platform".into())
2025-12-16T13:45:25.7008100Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:215:
2025-12-16T13:45:25.7008491Z              }
2025-12-16T13:45:25.7008649Z          }
2025-12-16T13:45:25.7008813Z -        
2025-12-16T13:45:25.7009087Z +
2025-12-16T13:45:25.7009321Z          /// Run the userspace network stack (netstack-smoltcp)
2025-12-16T13:45:25.7009866Z -        async fn run_netstack(&self, device: tun_rs::AsyncDevice) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7010315Z +        async fn run_netstack(
2025-12-16T13:45:25.7010524Z +            &self,
2025-12-16T13:45:25.7010726Z +            device: tun_rs::AsyncDevice,
2025-12-16T13:45:25.7011045Z +        ) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7011403Z              info!("Initializing userspace TCP/IP stack...");
2025-12-16T13:45:25.7011669Z -            
2025-12-16T13:45:25.7011830Z +
2025-12-16T13:45:25.7011991Z              // Create the stack
2025-12-16T13:45:25.7012339Z              // StackBuilder::build() returns (Stack, Runner, UdpSocket, TcpListener)
2025-12-16T13:45:25.7012843Z              let (stack, runner_opt, udp_socket_opt, tcp_listener_opt) = StackBuilder::default()
2025-12-16T13:45:25.7013386Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:230:
2025-12-16T13:45:25.7013830Z              let runner = runner_opt.ok_or("Runner missing")?;
2025-12-16T13:45:25.7014190Z              let udp_socket = udp_socket_opt.ok_or("UDP socket missing")?;
2025-12-16T13:45:25.7014596Z              let tcp_listener = tcp_listener_opt.ok_or("TCP listener missing")?;
2025-12-16T13:45:25.7014901Z -            
2025-12-16T13:45:25.7015065Z +
2025-12-16T13:45:25.7015230Z              // Spawn stack runner
2025-12-16T13:45:25.7015492Z              tokio::spawn(async move {
2025-12-16T13:45:25.7015755Z                  if let Err(e) = runner.await {
2025-12-16T13:45:25.7016182Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:244:
2025-12-16T13:45:25.7016596Z              let stats = self.stats.clone();
2025-12-16T13:45:25.7016904Z              let http_client = self.http_client.clone();
2025-12-16T13:45:25.7017224Z              let dns_protection = self.config.dns_protection;
2025-12-16T13:45:25.7017494Z -            
2025-12-16T13:45:25.7017653Z +
2025-12-16T13:45:25.7017833Z              // Spawn TCP listener task
2025-12-16T13:45:25.7018120Z              let tcp_task = tokio::spawn(async move {
2025-12-16T13:45:25.7018411Z                  // Pin locally inside the async block
2025-12-16T13:45:25.7018841Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:251:
2025-12-16T13:45:25.7019365Z                  tokio::pin!(tcp_listener);
2025-12-16T13:45:25.7019853Z -                
2025-12-16T13:45:25.7020029Z +
2025-12-16T13:45:25.7020244Z                  while running.load(Ordering::SeqCst) {
2025-12-16T13:45:25.7020539Z                      match tcp_listener.next().await {
2025-12-16T13:45:25.7020842Z                          Some((stream, local_addr, remote_addr)) => {
2025-12-16T13:45:25.7021294Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:256:
2025-12-16T13:45:25.7021781Z                              debug!("New TCP connection: {} -> {}", remote_addr, local_addr);
2025-12-16T13:45:25.7022101Z -                            
2025-12-16T13:45:25.7022292Z +
2025-12-16T13:45:25.7022487Z                              let tunnel = tunnel.clone();
2025-12-16T13:45:25.7022766Z                              let stats = stats.clone();
2025-12-16T13:45:25.7023016Z -                            
2025-12-16T13:45:25.7023212Z +
2025-12-16T13:45:25.7023396Z                              // Spawn connection handler
2025-12-16T13:45:25.7023699Z                              tokio::spawn(async move {
2025-12-16T13:45:25.7023947Z                                  {
2025-12-16T13:45:25.7024340Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:264:
2025-12-16T13:45:25.7024766Z                                      let mut s = stats.lock().await;
2025-12-16T13:45:25.7025063Z                                      s.connections_opened += 1;
2025-12-16T13:45:25.7025321Z                                  }
2025-12-16T13:45:25.7025545Z -                                
2025-12-16T13:45:25.7025747Z +
2025-12-16T13:45:25.7025945Z                                  // Open tunnel stream to destination
2025-12-16T13:45:25.7026485Z                                  let dest_host: String = local_addr.to_string(); // Assuming SocketAddr
2025-12-16T13:45:25.7026866Z                                  let dest_port = local_addr.port();
2025-12-16T13:45:25.7027341Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:271:
2025-12-16T13:45:25.7027765Z -                                
2025-12-16T13:45:25.7027970Z +
2025-12-16T13:45:25.7028210Z                                  match tunnel.open_stream(&dest_host, dest_port).await {
2025-12-16T13:45:25.7028540Z                                      Ok((stream_id, rx)) => {
2025-12-16T13:45:25.7029012Z -                                        debug!("Tunnel stream {} opened for {}", stream_id, local_addr);
2025-12-16T13:45:25.7029353Z -                                        
2025-12-16T13:45:25.7029606Z +                                        debug!(
2025-12-16T13:45:25.7029889Z +                                            "Tunnel stream {} opened for {}",
2025-12-16T13:45:25.7030194Z +                                            stream_id, local_addr
2025-12-16T13:45:25.7030460Z +                                        );
2025-12-16T13:45:25.7030676Z +
2025-12-16T13:45:25.7030856Z                                          // Relay data
2025-12-16T13:45:25.7031231Z -                                        let (mut read_half, mut write_half) = tokio::io::split(stream);
2025-12-16T13:45:25.7031596Z +                                        let (mut read_half, mut write_half) =
2025-12-16T13:45:25.7031910Z +                                            tokio::io::split(stream);
2025-12-16T13:45:25.7032219Z                                          let tunnel_tx = tunnel.sender();
2025-12-16T13:45:25.7032499Z -                                        
2025-12-16T13:45:25.7032714Z +
2025-12-16T13:45:25.7032916Z                                          // Task 1: Netstack -> Tunnel
2025-12-16T13:45:25.7033209Z                                          let mut buf = vec![0u8; 16384];
2025-12-16T13:45:25.7033519Z                                          let tunnel_tx_clone = tunnel_tx.clone();
2025-12-16T13:45:25.7033968Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:283:
2025-12-16T13:45:25.7034545Z                                          let stats_clone = stats.clone();
2025-12-16T13:45:25.7034931Z -                                        
2025-12-16T13:45:25.7035153Z +
2025-12-16T13:45:25.7035360Z                                          let ns_to_tunnel = async move {
2025-12-16T13:45:25.7035642Z                                              loop {
2025-12-16T13:45:25.7035946Z                                                  match read_half.read(&mut buf).await {
2025-12-16T13:45:25.7036395Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:289:
2025-12-16T13:45:25.7036826Z                                                      Ok(n) => {
2025-12-16T13:45:25.7037145Z                                                          let msg = TunnelMessage::Data {
2025-12-16T13:45:25.7037449Z                                                              stream_id,
2025-12-16T13:45:25.7037915Z -                                                            payload: bytes::Bytes::copy_from_slice(&buf[..n]),
2025-12-16T13:45:25.7038583Z +                                                            payload: bytes::Bytes::copy_from_slice(
2025-12-16T13:45:25.7039268Z +                                                                &buf[..n],
2025-12-16T13:45:25.7039741Z +                                                            ),
2025-12-16T13:45:25.7040197Z                                                          };
2025-12-16T13:45:25.7040740Z -                                                        if tunnel_tx_clone.send(msg).await.is_err() {
2025-12-16T13:45:25.7041337Z +                                                        if tunnel_tx_clone.send(msg).await.is_err()
2025-12-16T13:45:25.7041856Z +                                                        {
2025-12-16T13:45:25.7042299Z                                                              break;
2025-12-16T13:45:25.7042752Z                                                          }
2025-12-16T13:45:25.7043043Z -                                                        
2025-12-16T13:45:25.7043309Z +
2025-12-16T13:45:25.7043534Z                                                          let mut s = stats_clone.lock().await;
2025-12-16T13:45:25.7043853Z                                                          s.bytes_sent += n as u64;
2025-12-16T13:45:25.7044138Z                                                      }
2025-12-16T13:45:25.7044563Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:302:
2025-12-16T13:45:25.7044980Z                                                  }
2025-12-16T13:45:25.7045230Z                                              }
2025-12-16T13:45:25.7045481Z                                          };
2025-12-16T13:45:25.7045726Z -                                        
2025-12-16T13:45:25.7045940Z +
2025-12-16T13:45:25.7046142Z                                          // Task 2: Tunnel -> Netstack
2025-12-16T13:45:25.7046429Z                                          let mut rx = rx;
2025-12-16T13:45:25.7046731Z                                          let stats_clone2 = stats.clone();
2025-12-16T13:45:25.7047180Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:315:
2025-12-16T13:45:25.7047634Z                                                  s.bytes_received += data.len() as u64;
2025-12-16T13:45:25.7047924Z                                              }
2025-12-16T13:45:25.7048163Z                                          };
2025-12-16T13:45:25.7048405Z -                                        
2025-12-16T13:45:25.7048620Z +
2025-12-16T13:45:25.7048817Z                                          // Run both directions
2025-12-16T13:45:25.7049366Z                                          let _ = tokio::join!(ns_to_tunnel, tunnel_to_ns);
2025-12-16T13:45:25.7049670Z -                                        
2025-12-16T13:45:25.7049888Z +
2025-12-16T13:45:25.7050080Z                                          // Close tunnel stream
2025-12-16T13:45:25.7050608Z -                                        let _ = tunnel_tx.send(TunnelMessage::Close { stream_id }).await;
2025-12-16T13:45:25.7051080Z +                                        let _ = tunnel_tx
2025-12-16T13:45:25.7051401Z +                                            .send(TunnelMessage::Close { stream_id })
2025-12-16T13:45:25.7051697Z +                                            .await;
2025-12-16T13:45:25.7051954Z                                      }
2025-12-16T13:45:25.7052199Z                                      Err(e) => {
2025-12-16T13:45:25.7052508Z                                          error!("Failed to open tunnel stream: {}", e);
2025-12-16T13:45:25.7052968Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:335:
2025-12-16T13:45:25.7053355Z                      }
2025-12-16T13:45:25.7053543Z                  }
2025-12-16T13:45:25.7053711Z              });
2025-12-16T13:45:25.7053883Z -            
2025-12-16T13:45:25.7054042Z +
2025-12-16T13:45:25.7054238Z              // Spawn UDP handler (for DNS)
2025-12-16T13:45:25.7054649Z              // Note: netstack-smoltcp v0.2.0 UdpSocket doesn't expose standard Stream/Sink traits
2025-12-16T13:45:25.7055117Z              // For now, we keep the socket alive but don't actively process UDP
2025-12-16T13:45:25.7055608Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:342:
2025-12-16T13:45:25.7056116Z              // DNS will work through the system resolver or future DoH implementation
2025-12-16T13:45:25.7056486Z              let _dns_protection = dns_protection;
2025-12-16T13:45:25.7056766Z              let _http_client = http_client;
2025-12-16T13:45:25.7057003Z -            
2025-12-16T13:45:25.7057162Z +
2025-12-16T13:45:25.7057383Z              let udp_task = tokio::spawn(async move {
2025-12-16T13:45:25.7057740Z                  // Keep UDP socket alive - it's required for the stack to function
2025-12-16T13:45:25.7058159Z                  // In future versions, we can implement UDP tunneling via worker
2025-12-16T13:45:25.7058664Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:352:
2025-12-16T13:45:25.7059220Z                  // Ensure socket is kept alive until task ends
2025-12-16T13:45:25.7059508Z                  drop(udp_socket);
2025-12-16T13:45:25.7059726Z              });
2025-12-16T13:45:25.7059900Z -            
2025-12-16T13:45:25.7060061Z +
2025-12-16T13:45:25.7060256Z              // Bridge TUN device and Netstack
2025-12-16T13:45:25.7060532Z              let device = Arc::new(device);
2025-12-16T13:45:25.7060800Z              let device_reader = device.clone();
2025-12-16T13:45:25.7061226Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:359:
2025-12-16T13:45:25.7061643Z              let device_writer = device.clone();
2025-12-16T13:45:25.7061884Z -            
2025-12-16T13:45:25.7062043Z +
2025-12-16T13:45:25.7062261Z              // Stack implements Stream and Sink (of packets)
2025-12-16T13:45:25.7062600Z              // We split it into sink (writer) and stream (reader)
2025-12-16T13:45:25.7063170Z              let (mut stack_sink, mut stack_stream) = stack.split();
2025-12-16T13:45:25.7063979Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:364:
2025-12-16T13:45:25.7064639Z -            
2025-12-16T13:45:25.7064915Z +
2025-12-16T13:45:25.7065169Z              // TUN -> Netstack
2025-12-16T13:45:25.7065573Z              let tun_to_ns = tokio::spawn(async move {
2025-12-16T13:45:25.7065862Z                  let mut buf = vec![0u8; 1500];
2025-12-16T13:45:25.7066284Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:382:
2025-12-16T13:45:25.7066669Z                      }
2025-12-16T13:45:25.7066857Z                  }
2025-12-16T13:45:25.7067028Z              });
2025-12-16T13:45:25.7067202Z -            
2025-12-16T13:45:25.7067370Z +
2025-12-16T13:45:25.7067535Z              // Netstack -> TUN
2025-12-16T13:45:25.7068021Z              let ns_to_tun = tokio::spawn(async move {
2025-12-16T13:45:25.7069134Z                  while let Some(packet_result) = stack_stream.next().await {
2025-12-16T13:45:25.7069987Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:401:
2025-12-16T13:45:25.7070432Z                      }
2025-12-16T13:45:25.7070624Z                  }
2025-12-16T13:45:25.7070802Z              });
2025-12-16T13:45:25.7070976Z -            
2025-12-16T13:45:25.7071147Z +
2025-12-16T13:45:25.7071319Z              // Wait for bridge tasks
2025-12-16T13:45:25.7071663Z              let _ = tokio::join!(tun_to_ns, ns_to_tun, tcp_task, udp_task);
2025-12-16T13:45:25.7071957Z -            
2025-12-16T13:45:25.7072123Z +
2025-12-16T13:45:25.7072272Z              Ok(())
2025-12-16T13:45:25.7072449Z          }
2025-12-16T13:45:25.7072600Z  
2025-12-16T13:45:25.7072953Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:426:
2025-12-16T13:45:25.7073335Z  
2025-12-16T13:45:25.7073583Z                  // Set default outbound to block for current profile
2025-12-16T13:45:25.7073911Z                  let _ = Command::new("netsh")
2025-12-16T13:45:25.7074352Z -                    .args(["advfirewall", "set", "currentprofile", "firewallpolicy", "blockinbound,blockoutbound"])
2025-12-16T13:45:25.7074770Z +                    .args([
2025-12-16T13:45:25.7074992Z +                        "advfirewall",
2025-12-16T13:45:25.7075233Z +                        "set",
2025-12-16T13:45:25.7075462Z +                        "currentprofile",
2025-12-16T13:45:25.7075717Z +                        "firewallpolicy",
2025-12-16T13:45:25.7075987Z +                        "blockinbound,blockoutbound",
2025-12-16T13:45:25.7076248Z +                    ])
2025-12-16T13:45:25.7076450Z                      .status()?;
2025-12-16T13:45:25.7076654Z  
2025-12-16T13:45:25.7076902Z                  // Allow this executable to go out so the tunnel can connect
2025-12-16T13:45:25.7077403Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:434:
2025-12-16T13:45:25.7077867Z                  let exe_str = exe.to_string_lossy().to_string();
2025-12-16T13:45:25.7078174Z                  let _ = Command::new("netsh")
2025-12-16T13:45:25.7078419Z                      .args([
2025-12-16T13:45:25.7078675Z -                        "advfirewall", "firewall", "add", "rule",
2025-12-16T13:45:25.7079244Z -                        "name=ZKS VPN Allow", "dir=out", "action=allow", "program=",
2025-12-16T13:45:25.7079574Z +                        "advfirewall",
2025-12-16T13:45:25.7079819Z +                        "firewall",
2025-12-16T13:45:25.7080055Z +                        "add",
2025-12-16T13:45:25.7080264Z +                        "rule",
2025-12-16T13:45:25.7080502Z +                        "name=ZKS VPN Allow",
2025-12-16T13:45:25.7080746Z +                        "dir=out",
2025-12-16T13:45:25.7080986Z +                        "action=allow",
2025-12-16T13:45:25.7081223Z +                        "program=",
2025-12-16T13:45:25.7081467Z                      ])
2025-12-16T13:45:25.7081666Z                      .status();
2025-12-16T13:45:25.7082038Z                  // Note: The above approach to join args with program= may not include path with spaces.
2025-12-16T13:45:25.7082605Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:442:
2025-12-16T13:45:25.7083053Z                  // Use a single command string fallback for safety.
2025-12-16T13:45:25.7083370Z                  let _ = Command::new("netsh")
2025-12-16T13:45:25.7083610Z                      .args([
2025-12-16T13:45:25.7083868Z -                        "advfirewall", "firewall", "add", "rule",
2025-12-16T13:45:25.7084262Z -                        "name=ZKS VPN Allow", "dir=out", "action=allow", "enable=yes", "profile=any",
2025-12-16T13:45:25.7084614Z +                        "advfirewall",
2025-12-16T13:45:25.7084852Z +                        "firewall",
2025-12-16T13:45:25.7085071Z +                        "add",
2025-12-16T13:45:25.7085568Z +                        "rule",
2025-12-16T13:45:25.7085801Z +                        "name=ZKS VPN Allow",
2025-12-16T13:45:25.7086051Z +                        "dir=out",
2025-12-16T13:45:25.7086278Z +                        "action=allow",
2025-12-16T13:45:25.7086521Z +                        "enable=yes",
2025-12-16T13:45:25.7086763Z +                        "profile=any",
2025-12-16T13:45:25.7087030Z                          &format!("program={}", exe_str),
2025-12-16T13:45:25.7087279Z                      ])
2025-12-16T13:45:25.7087471Z                      .status()?;
2025-12-16T13:45:25.7087864Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:462:
2025-12-16T13:45:25.7088247Z          }
2025-12-16T13:45:25.7088405Z  
2025-12-16T13:45:25.7088648Z          /// Disable OS-level kill switch and restore firewall defaults
2025-12-16T13:45:25.7089371Z -        async fn disable_kill_switch(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7089789Z +        async fn disable_kill_switch(
2025-12-16T13:45:25.7090018Z +            &self,
2025-12-16T13:45:25.7090277Z +        ) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7090581Z              #[cfg(target_os = "windows")]
2025-12-16T13:45:25.7090820Z              {
2025-12-16T13:45:25.7091003Z                  use std::env;
2025-12-16T13:45:25.7091394Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:472:
2025-12-16T13:45:25.7091845Z                      let exe_str = exe.to_string_lossy().to_string();
2025-12-16T13:45:25.7092158Z                      let _ = Command::new("netsh")
2025-12-16T13:45:25.7092415Z                          .args([
2025-12-16T13:45:25.7092678Z -                            "advfirewall", "firewall", "delete", "rule",
2025-12-16T13:45:25.7092976Z +                            "advfirewall",
2025-12-16T13:45:25.7093222Z +                            "firewall",
2025-12-16T13:45:25.7093478Z +                            "delete",
2025-12-16T13:45:25.7093706Z +                            "rule",
2025-12-16T13:45:25.7093985Z                              "name=ZKS VPN Allow",
2025-12-16T13:45:25.7094265Z                              &format!("program={}", exe_str),
2025-12-16T13:45:25.7094525Z                          ])
2025-12-16T13:45:25.7094906Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:482:
2025-12-16T13:45:25.7095377Z                  // Attempt to restore original profile policy if captured
2025-12-16T13:45:25.7095797Z                  if let Some(snapshot) = self.original_fw_policy.lock().await.clone() {
2025-12-16T13:45:25.7096300Z                      // Heuristic: if snapshot contains "Outbound Policy\s+:\s+Allow" then set allowoutbound
2025-12-16T13:45:25.7096719Z -                    let allow_out = snapshot
2025-12-16T13:45:25.7096974Z -                        .lines()
2025-12-16T13:45:25.7097420Z -                        .any(|l| l.to_ascii_lowercase().contains("outbound policy") && l.to_ascii_lowercase().contains("allow"));
2025-12-16T13:45:25.7097909Z +                    let allow_out = snapshot.lines().any(|l| {
2025-12-16T13:45:25.7098244Z +                        l.to_ascii_lowercase().contains("outbound policy")
2025-12-16T13:45:25.7098597Z +                            && l.to_ascii_lowercase().contains("allow")
2025-12-16T13:45:25.7098860Z +                    });
2025-12-16T13:45:25.7099220Z  
2025-12-16T13:45:25.7099590Z -                    let policy = if allow_out { "allowinbound,allowoutbound" } else { "blockinbound,allowoutbound" };
2025-12-16T13:45:25.7100037Z +                    let policy = if allow_out {
2025-12-16T13:45:25.7100329Z +                        "allowinbound,allowoutbound"
2025-12-16T13:45:25.7100588Z +                    } else {
2025-12-16T13:45:25.7100826Z +                        "blockinbound,allowoutbound"
2025-12-16T13:45:25.7101069Z +                    };
2025-12-16T13:45:25.7101440Z                      let _ = Command::new("netsh")
2025-12-16T13:45:25.7101920Z -                        .args(["advfirewall", "set", "currentprofile", "firewallpolicy", policy])
2025-12-16T13:45:25.7102268Z +                        .args([
2025-12-16T13:45:25.7102498Z +                            "advfirewall",
2025-12-16T13:45:25.7102740Z +                            "set",
2025-12-16T13:45:25.7102987Z +                            "currentprofile",
2025-12-16T13:45:25.7103243Z +                            "firewallpolicy",
2025-12-16T13:45:25.7103491Z +                            policy,
2025-12-16T13:45:25.7103710Z +                        ])
2025-12-16T13:45:25.7103918Z                          .status();
2025-12-16T13:45:25.7104130Z                  } else {
2025-12-16T13:45:25.7104384Z                      // Fallback: set default back to allow outbounds
2025-12-16T13:45:25.7104841Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:495:
2025-12-16T13:45:25.7105273Z                      let _ = Command::new("netsh")
2025-12-16T13:45:25.7105720Z -                        .args(["advfirewall", "set", "currentprofile", "firewallpolicy", "blockinbound,allowoutbound"])
2025-12-16T13:45:25.7106122Z +                        .args([
2025-12-16T13:45:25.7106353Z +                            "advfirewall",
2025-12-16T13:45:25.7106586Z +                            "set",
2025-12-16T13:45:25.7106824Z +                            "currentprofile",
2025-12-16T13:45:25.7107076Z +                            "firewallpolicy",
2025-12-16T13:45:25.7107353Z +                            "blockinbound,allowoutbound",
2025-12-16T13:45:25.7107624Z +                        ])
2025-12-16T13:45:25.7107825Z                          .status();
2025-12-16T13:45:25.7108040Z                  }
2025-12-16T13:45:25.7108206Z  
2025-12-16T13:45:25.7108544Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:507:
2025-12-16T13:45:25.7109070Z  
2025-12-16T13:45:25.7109254Z              Ok(())
2025-12-16T13:45:25.7109435Z          }
2025-12-16T13:45:25.7109597Z -        
2025-12-16T13:45:25.7109750Z +
2025-12-16T13:45:25.7109957Z          /// Resolve DNS query via DoH (Cloudflare 1.1.1.1)
2025-12-16T13:45:25.7110371Z          /// Note: Currently unused - will be enabled when UDP handling is implemented
2025-12-16T13:45:25.7110736Z          #[allow(dead_code)]
2025-12-16T13:45:25.7111135Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:514:
2025-12-16T13:45:25.7111783Z -        async fn resolve_doh(client: &Client, query: &[u8]) -> Result<Vec<u8>, Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7112236Z +        async fn resolve_doh(
2025-12-16T13:45:25.7112457Z +            client: &Client,
2025-12-16T13:45:25.7112674Z +            query: &[u8],
2025-12-16T13:45:25.7112966Z +        ) -> Result<Vec<u8>, Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7113331Z              let url = "https://1.1.1.1/dns-query";
2025-12-16T13:45:25.7113609Z -            
2025-12-16T13:45:25.7113816Z -            let response = client.post(url)
2025-12-16T13:45:25.7114061Z +
2025-12-16T13:45:25.7114226Z +            let response = client
2025-12-16T13:45:25.7114460Z +                .post(url)
2025-12-16T13:45:25.7114725Z                  .header("Content-Type", "application/dns-message")
2025-12-16T13:45:25.7115059Z                  .header("Accept", "application/dns-message")
2025-12-16T13:45:25.7115338Z                  .body(query.to_vec())
2025-12-16T13:45:25.7115754Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:521:
2025-12-16T13:45:25.7116150Z                  .send()
2025-12-16T13:45:25.7116342Z                  .await?;
2025-12-16T13:45:25.7116534Z -                
2025-12-16T13:45:25.7116700Z +
2025-12-16T13:45:25.7116889Z              if !response.status().is_success() {
2025-12-16T13:45:25.7117257Z                  return Err(format!("DoH request failed: {}", response.status()).into());
2025-12-16T13:45:25.7117874Z              }
2025-12-16T13:45:25.7118229Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:527:
2025-12-16T13:45:25.7118619Z -            
2025-12-16T13:45:25.7118782Z +
2025-12-16T13:45:25.7119125Z              let bytes = response.bytes().await?;
2025-12-16T13:45:25.7119397Z              Ok(bytes.to_vec())
2025-12-16T13:45:25.7119602Z          }
2025-12-16T13:45:25.7119951Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:531:
2025-12-16T13:45:25.7120338Z -        
2025-12-16T13:45:25.7120497Z +
2025-12-16T13:45:25.7120665Z          /// Get current VPN state
2025-12-16T13:45:25.7120904Z          #[allow(dead_code)]
2025-12-16T13:45:25.7121145Z          pub async fn state(&self) -> VpnState {
2025-12-16T13:45:25.7121585Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:535:
2025-12-16T13:45:25.7122002Z              *self.state.lock().await
2025-12-16T13:45:25.7122222Z          }
2025-12-16T13:45:25.7122403Z -        
2025-12-16T13:45:25.7122552Z +
2025-12-16T13:45:25.7122732Z          /// Get current VPN statistics
2025-12-16T13:45:25.7122974Z          #[allow(dead_code)]
2025-12-16T13:45:25.7123217Z          pub async fn stats(&self) -> VpnStats {
2025-12-16T13:45:25.7123639Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:566:
2025-12-16T13:45:25.7124052Z          pub dns_protection: bool,
2025-12-16T13:45:25.7124296Z          pub kill_switch: bool,
2025-12-16T13:45:25.7124500Z      }
2025-12-16T13:45:25.7124656Z -    
2025-12-16T13:45:25.7124806Z +
2025-12-16T13:45:25.7124974Z      /// VPN state (stub)
2025-12-16T13:45:25.7125214Z      #[derive(Debug, Clone, Copy, PartialEq, Eq)]
2025-12-16T13:45:25.7125484Z      pub enum VpnState {
2025-12-16T13:45:25.7125858Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:573:
2025-12-16T13:45:25.7126255Z          Disconnected,
2025-12-16T13:45:25.7126437Z      }
2025-12-16T13:45:25.7126610Z -    
2025-12-16T13:45:25.7126761Z +
2025-12-16T13:45:25.7126964Z      /// VPN controller (stub - feature not enabled)
2025-12-16T13:45:25.7127254Z      pub struct VpnController;
2025-12-16T13:45:25.7127464Z -    
2025-12-16T13:45:25.7127613Z +
2025-12-16T13:45:25.7127772Z      impl VpnController {
2025-12-16T13:45:25.7128163Z -        pub fn new(_tunnel: std::sync::Arc<crate::tunnel::TunnelClient>, _config: VpnConfig) -> Self {
2025-12-16T13:45:25.7128547Z +        pub fn new(
2025-12-16T13:45:25.7128804Z +            _tunnel: std::sync::Arc<crate::tunnel::TunnelClient>,
2025-12-16T13:45:25.7129346Z +            _config: VpnConfig,
2025-12-16T13:45:25.7129570Z +        ) -> Self {
2025-12-16T13:45:25.7129752Z              Self
2025-12-16T13:45:25.7129919Z          }
2025-12-16T13:45:25.7130080Z -        
2025-12-16T13:45:25.7130230Z +
2025-12-16T13:45:25.7130531Z          pub async fn start(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7131001Z              Err("VPN feature is not enabled. Rebuild with --features vpn".into())
2025-12-16T13:45:25.7131334Z          }
2025-12-16T13:45:25.7131674Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:587:
2025-12-16T13:45:25.7132062Z -        
2025-12-16T13:45:25.7132210Z +
2025-12-16T13:45:25.7132503Z          pub async fn stop(&self) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {
2025-12-16T13:45:25.7132956Z              Err("VPN feature is not enabled. Rebuild with --features vpn".into())
2025-12-16T13:45:25.7133265Z          }
2025-12-16T13:45:25.7133607Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-client/src/vpn.rs:591:
2025-12-16T13:45:25.7133983Z -        
2025-12-16T13:45:25.7134138Z +
2025-12-16T13:45:25.7134324Z          pub async fn state(&self) -> VpnState {
2025-12-16T13:45:25.7134603Z              VpnState::Disconnected
2025-12-16T13:45:25.7134825Z          }
2025-12-16T13:45:25.7135317Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/lib.rs:3:
2025-12-16T13:45:25.7135914Z  //! This crate defines the binary protocol for communication between
2025-12-16T13:45:25.7136248Z  //! the ZKS-Tunnel client and worker.
2025-12-16T13:45:25.7136480Z  
2025-12-16T13:45:25.7136629Z -mod message;
2025-12-16T13:45:25.7136801Z  mod error;
2025-12-16T13:45:25.7136963Z +mod message;
2025-12-16T13:45:25.7137124Z  
2025-12-16T13:45:25.7137288Z -pub use message::*;
2025-12-16T13:45:25.7137517Z  pub use error::*;
2025-12-16T13:45:25.7137710Z +pub use message::*;
2025-12-16T13:45:25.7138001Z  
2025-12-16T13:45:25.7138444Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:68:
2025-12-16T13:45:25.7139187Z          port: u16,
2025-12-16T13:45:25.7139469Z      },
2025-12-16T13:45:25.7139765Z      /// Data payload for a stream (TCP)
2025-12-16T13:45:25.7140083Z -    Data {
2025-12-16T13:45:25.7140436Z -        stream_id: StreamId,
2025-12-16T13:45:25.7140721Z -        payload: Bytes,
2025-12-16T13:45:25.7141020Z -    },
2025-12-16T13:45:25.7141355Z +    Data { stream_id: StreamId, payload: Bytes },
2025-12-16T13:45:25.7141752Z      /// Close a stream
2025-12-16T13:45:25.7142057Z -    Close {
2025-12-16T13:45:25.7142369Z -        stream_id: StreamId,
2025-12-16T13:45:25.7142668Z -    },
2025-12-16T13:45:25.7142888Z +    Close { stream_id: StreamId },
2025-12-16T13:45:25.7153929Z      /// Error on a stream
2025-12-16T13:45:25.7154255Z      ErrorReply {
2025-12-16T13:45:25.7154466Z          stream_id: StreamId,
2025-12-16T13:45:25.7154912Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:131:
2025-12-16T13:45:25.7155406Z          let mut buf = BytesMut::with_capacity(256);
2025-12-16T13:45:25.7155667Z  
2025-12-16T13:45:25.7155823Z          match self {
2025-12-16T13:45:25.7156103Z -            TunnelMessage::Connect { stream_id, host, port } => {
2025-12-16T13:45:25.7156425Z +            TunnelMessage::Connect {
2025-12-16T13:45:25.7156666Z +                stream_id,
2025-12-16T13:45:25.7156896Z +                host,
2025-12-16T13:45:25.7157086Z +                port,
2025-12-16T13:45:25.7157275Z +            } => {
2025-12-16T13:45:25.7157508Z                  buf.put_u8(CommandType::Connect as u8);
2025-12-16T13:45:25.7157791Z                  buf.put_u32(*stream_id);
2025-12-16T13:45:25.7158040Z                  buf.put_u16(*port);
2025-12-16T13:45:25.7158472Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:148:
2025-12-16T13:45:25.7159089Z                  buf.put_u8(CommandType::Close as u8);
2025-12-16T13:45:25.7159394Z                  buf.put_u32(*stream_id);
2025-12-16T13:45:25.7159622Z              }
2025-12-16T13:45:25.7159898Z -            TunnelMessage::ErrorReply { stream_id, code, message } => {
2025-12-16T13:45:25.7160249Z +            TunnelMessage::ErrorReply {
2025-12-16T13:45:25.7160489Z +                stream_id,
2025-12-16T13:45:25.7160694Z +                code,
2025-12-16T13:45:25.7160886Z +                message,
2025-12-16T13:45:25.7161087Z +            } => {
2025-12-16T13:45:25.7161315Z                  buf.put_u8(CommandType::ErrorReply as u8);
2025-12-16T13:45:25.7161600Z                  buf.put_u32(*stream_id);
2025-12-16T13:45:25.7161844Z                  buf.put_u16(*code);
2025-12-16T13:45:25.7162264Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:161:
2025-12-16T13:45:25.7162693Z              TunnelMessage::Pong => {
2025-12-16T13:45:25.7162965Z                  buf.put_u8(CommandType::Pong as u8);
2025-12-16T13:45:25.7163214Z              }
2025-12-16T13:45:25.7163508Z -            TunnelMessage::UdpDatagram { request_id, host, port, payload } => {
2025-12-16T13:45:25.7163879Z +            TunnelMessage::UdpDatagram {
2025-12-16T13:45:25.7164118Z +                request_id,
2025-12-16T13:45:25.7164319Z +                host,
2025-12-16T13:45:25.7164499Z +                port,
2025-12-16T13:45:25.7164680Z +                payload,
2025-12-16T13:45:25.7165159Z +            } => {
2025-12-16T13:45:25.7165403Z                  buf.put_u8(CommandType::UdpDatagram as u8);
2025-12-16T13:45:25.7165708Z                  buf.put_u32(*request_id);
2025-12-16T13:45:25.7165963Z                  buf.put_u16(*port);
2025-12-16T13:45:25.7166391Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:176:
2025-12-16T13:45:25.7166829Z                  buf.put_u32(query.len() as u32);
2025-12-16T13:45:25.7167100Z                  buf.put_slice(query);
2025-12-16T13:45:25.7167326Z              }
2025-12-16T13:45:25.7167596Z -            TunnelMessage::DnsResponse { request_id, response } => {
2025-12-16T13:45:25.7167936Z +            TunnelMessage::DnsResponse {
2025-12-16T13:45:25.7168182Z +                request_id,
2025-12-16T13:45:25.7168394Z +                response,
2025-12-16T13:45:25.7168583Z +            } => {
2025-12-16T13:45:25.7168821Z                  buf.put_u8(CommandType::DnsResponse as u8);
2025-12-16T13:45:25.7169451Z                  buf.put_u32(*request_id);
2025-12-16T13:45:25.7169751Z                  buf.put_u32(response.len() as u32);
2025-12-16T13:45:25.7170201Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:204:
2025-12-16T13:45:25.7170628Z                  let stream_id = cursor.get_u32();
2025-12-16T13:45:25.7170901Z                  let port = cursor.get_u16();
2025-12-16T13:45:25.7171177Z                  let host_len = cursor.get_u16() as usize;
2025-12-16T13:45:25.7171428Z -                
2025-12-16T13:45:25.7171591Z +
2025-12-16T13:45:25.7171775Z                  if cursor.remaining() < host_len {
2025-12-16T13:45:25.7172101Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7172381Z                  }
2025-12-16T13:45:25.7172763Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:211:
2025-12-16T13:45:25.7173200Z                  let mut host_bytes = vec![0u8; host_len];
2025-12-16T13:45:25.7173509Z                  cursor.copy_to_slice(&mut host_bytes);
2025-12-16T13:45:25.7173807Z -                let host = String::from_utf8(host_bytes)
2025-12-16T13:45:25.7174128Z -                    .map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7174408Z +                let host =
2025-12-16T13:45:25.7174751Z +                    String::from_utf8(host_bytes).map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7175084Z  
2025-12-16T13:45:25.7175309Z -                Ok(TunnelMessage::Connect { stream_id, host, port })
2025-12-16T13:45:25.7175626Z +                Ok(TunnelMessage::Connect {
2025-12-16T13:45:25.7175863Z +                    stream_id,
2025-12-16T13:45:25.7176073Z +                    host,
2025-12-16T13:45:25.7176262Z +                    port,
2025-12-16T13:45:25.7176444Z +                })
2025-12-16T13:45:25.7176606Z              }
2025-12-16T13:45:25.7176797Z              CommandType::Data => {
2025-12-16T13:45:25.7177051Z                  if cursor.remaining() < 8 {
2025-12-16T13:45:25.7177330Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:221:
2025-12-16T13:45:25.7177399Z                  }
2025-12-16T13:45:25.7177501Z                  let stream_id = cursor.get_u32();
2025-12-16T13:45:25.7177637Z                  let payload_len = cursor.get_u32() as usize;
2025-12-16T13:45:25.7177705Z -                
2025-12-16T13:45:25.7177768Z +
2025-12-16T13:45:25.7177880Z                  if cursor.remaining() < payload_len {
2025-12-16T13:45:25.7178034Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7178103Z                  }
2025-12-16T13:45:25.7178363Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:228:
2025-12-16T13:45:25.7178621Z -                let payload = Bytes::copy_from_slice(&data[cursor.position() as usize..][..payload_len]);
2025-12-16T13:45:25.7178705Z +                let payload =
2025-12-16T13:45:25.7179246Z +                    Bytes::copy_from_slice(&data[cursor.position() as usize..][..payload_len]);
2025-12-16T13:45:25.7179435Z  
2025-12-16T13:45:25.7179589Z                  Ok(TunnelMessage::Data { stream_id, payload })
2025-12-16T13:45:25.7179658Z              }
2025-12-16T13:45:25.7179963Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:243:
2025-12-16T13:45:25.7180078Z                  let stream_id = cursor.get_u32();
2025-12-16T13:45:25.7180175Z                  let code = cursor.get_u16();
2025-12-16T13:45:25.7180290Z                  let msg_len = cursor.get_u16() as usize;
2025-12-16T13:45:25.7180367Z -                
2025-12-16T13:45:25.7180430Z +
2025-12-16T13:45:25.7180538Z                  if cursor.remaining() < msg_len {
2025-12-16T13:45:25.7180696Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7180766Z                  }
2025-12-16T13:45:25.7181048Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:250:
2025-12-16T13:45:25.7181168Z                  let mut msg_bytes = vec![0u8; msg_len];
2025-12-16T13:45:25.7181281Z                  cursor.copy_to_slice(&mut msg_bytes);
2025-12-16T13:45:25.7181404Z -                let message = String::from_utf8(msg_bytes)
2025-12-16T13:45:25.7181544Z -                    .map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7181632Z +                let message =
2025-12-16T13:45:25.7181843Z +                    String::from_utf8(msg_bytes).map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7181906Z  
2025-12-16T13:45:25.7182082Z -                Ok(TunnelMessage::ErrorReply { stream_id, code, message })
2025-12-16T13:45:25.7182196Z +                Ok(TunnelMessage::ErrorReply {
2025-12-16T13:45:25.7182276Z +                    stream_id,
2025-12-16T13:45:25.7182350Z +                    code,
2025-12-16T13:45:25.7182436Z +                    message,
2025-12-16T13:45:25.7182504Z +                })
2025-12-16T13:45:25.7182585Z              }
2025-12-16T13:45:25.7182718Z              CommandType::Ping => Ok(TunnelMessage::Ping),
2025-12-16T13:45:25.7182842Z              CommandType::Pong => Ok(TunnelMessage::Pong),
2025-12-16T13:45:25.7183108Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:263:
2025-12-16T13:45:25.7183217Z                  let request_id = cursor.get_u32();
2025-12-16T13:45:25.7183315Z                  let port = cursor.get_u16();
2025-12-16T13:45:25.7183424Z                  let host_len = cursor.get_u16() as usize;
2025-12-16T13:45:25.7183492Z -                
2025-12-16T13:45:25.7183560Z +
2025-12-16T13:45:25.7183664Z                  if cursor.remaining() < host_len {
2025-12-16T13:45:25.7183809Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7183883Z                  }
2025-12-16T13:45:25.7184154Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:270:
2025-12-16T13:45:25.7184267Z                  let mut host_bytes = vec![0u8; host_len];
2025-12-16T13:45:25.7184383Z                  cursor.copy_to_slice(&mut host_bytes);
2025-12-16T13:45:25.7184506Z -                let host = String::from_utf8(host_bytes)
2025-12-16T13:45:25.7184643Z -                    .map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7184711Z -                
2025-12-16T13:45:25.7184794Z +                let host =
2025-12-16T13:45:25.7185008Z +                    String::from_utf8(host_bytes).map_err(|_| crate::ProtoError::InvalidUtf8)?;
2025-12-16T13:45:25.7185070Z +
2025-12-16T13:45:25.7185176Z                  if cursor.remaining() < 4 {
2025-12-16T13:45:25.7185319Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7185388Z                  }
2025-12-16T13:45:25.7185653Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:278:
2025-12-16T13:45:25.7185780Z                  let payload_len = cursor.get_u32() as usize;
2025-12-16T13:45:25.7186020Z -                
2025-12-16T13:45:25.7186083Z +
2025-12-16T13:45:25.7186197Z                  if cursor.remaining() < payload_len {
2025-12-16T13:45:25.7186340Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7186406Z                  }
2025-12-16T13:45:25.7186662Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:283:
2025-12-16T13:45:25.7186919Z -                let payload = Bytes::copy_from_slice(&data[cursor.position() as usize..][..payload_len]);
2025-12-16T13:45:25.7186986Z -                
2025-12-16T13:45:25.7187180Z -                Ok(TunnelMessage::UdpDatagram { request_id, host, port, payload })
2025-12-16T13:45:25.7187265Z +                let payload =
2025-12-16T13:45:25.7187476Z +                    Bytes::copy_from_slice(&data[cursor.position() as usize..][..payload_len]);
2025-12-16T13:45:25.7187537Z +
2025-12-16T13:45:25.7187652Z +                Ok(TunnelMessage::UdpDatagram {
2025-12-16T13:45:25.7187755Z +                    request_id,
2025-12-16T13:45:25.7187831Z +                    host,
2025-12-16T13:45:25.7187906Z +                    port,
2025-12-16T13:45:25.7187988Z +                    payload,
2025-12-16T13:45:25.7188055Z +                })
2025-12-16T13:45:25.7188119Z              }
2025-12-16T13:45:25.7188222Z              CommandType::DnsQuery => {
2025-12-16T13:45:25.7188319Z                  if cursor.remaining() < 8 {
2025-12-16T13:45:25.7188579Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:290:
2025-12-16T13:45:25.7188652Z                  }
2025-12-16T13:45:25.7188754Z                  let request_id = cursor.get_u32();
2025-12-16T13:45:25.7188866Z                  let query_len = cursor.get_u32() as usize;
2025-12-16T13:45:25.7189100Z -                
2025-12-16T13:45:25.7189174Z +
2025-12-16T13:45:25.7189292Z                  if cursor.remaining() < query_len {
2025-12-16T13:45:25.7189456Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7189537Z                  }
2025-12-16T13:45:25.7189802Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:297:
2025-12-16T13:45:25.7190041Z -                let query = Bytes::copy_from_slice(&data[cursor.position() as usize..][..query_len]);
2025-12-16T13:45:25.7190108Z -                
2025-12-16T13:45:25.7190195Z +                let query =
2025-12-16T13:45:25.7190397Z +                    Bytes::copy_from_slice(&data[cursor.position() as usize..][..query_len]);
2025-12-16T13:45:25.7190461Z +
2025-12-16T13:45:25.7190609Z                  Ok(TunnelMessage::DnsQuery { request_id, query })
2025-12-16T13:45:25.7190676Z              }
2025-12-16T13:45:25.7190784Z              CommandType::DnsResponse => {
2025-12-16T13:45:25.7191046Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:304:
2025-12-16T13:45:25.7191113Z                  }
2025-12-16T13:45:25.7191225Z                  let request_id = cursor.get_u32();
2025-12-16T13:45:25.7191354Z                  let response_len = cursor.get_u32() as usize;
2025-12-16T13:45:25.7191426Z -                
2025-12-16T13:45:25.7191487Z +
2025-12-16T13:45:25.7191600Z                  if cursor.remaining() < response_len {
2025-12-16T13:45:25.7191752Z                      return Err(crate::ProtoError::InsufficientData);
2025-12-16T13:45:25.7191820Z                  }
2025-12-16T13:45:25.7192078Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:311:
2025-12-16T13:45:25.7192346Z -                let response = Bytes::copy_from_slice(&data[cursor.position() as usize..][..response_len]);
2025-12-16T13:45:25.7192414Z -                
2025-12-16T13:45:25.7192582Z -                Ok(TunnelMessage::DnsResponse { request_id, response })
2025-12-16T13:45:25.7192668Z +                let response =
2025-12-16T13:45:25.7193058Z +                    Bytes::copy_from_slice(&data[cursor.position() as usize..][..response_len]);
2025-12-16T13:45:25.7193225Z +
2025-12-16T13:45:25.7193338Z +                Ok(TunnelMessage::DnsResponse {
2025-12-16T13:45:25.7193425Z +                    request_id,
2025-12-16T13:45:25.7193506Z +                    response,
2025-12-16T13:45:25.7193574Z +                })
2025-12-16T13:45:25.7193641Z              }
2025-12-16T13:45:25.7193712Z          }
2025-12-16T13:45:25.7193776Z      }
2025-12-16T13:45:25.7194072Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:329:
2025-12-16T13:45:25.7194146Z          };
2025-12-16T13:45:25.7194238Z          let encoded = msg.encode();
2025-12-16T13:45:25.7194391Z          let decoded = TunnelMessage::decode(&encoded).unwrap();
2025-12-16T13:45:25.7194459Z -        
2025-12-16T13:45:25.7194526Z +
2025-12-16T13:45:25.7194604Z          match decoded {
2025-12-16T13:45:25.7194756Z -            TunnelMessage::Connect { stream_id, host, port } => {
2025-12-16T13:45:25.7194867Z +            TunnelMessage::Connect {
2025-12-16T13:45:25.7194968Z +                stream_id,
2025-12-16T13:45:25.7195041Z +                host,
2025-12-16T13:45:25.7195115Z +                port,
2025-12-16T13:45:25.7195189Z +            } => {
2025-12-16T13:45:25.7195285Z                  assert_eq!(stream_id, 42);
2025-12-16T13:45:25.7195385Z                  assert_eq!(host, "google.com");
2025-12-16T13:45:25.7195480Z                  assert_eq!(port, 443);
2025-12-16T13:45:25.7195737Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-proto/src/message.rs:349:
2025-12-16T13:45:25.7195805Z          };
2025-12-16T13:45:25.7195899Z          let encoded = msg.encode();
2025-12-16T13:45:25.7196048Z          let decoded = TunnelMessage::decode(&encoded).unwrap();
2025-12-16T13:45:25.7196116Z -        
2025-12-16T13:45:25.7196177Z +
2025-12-16T13:45:25.7196262Z          match decoded {
2025-12-16T13:45:25.7196418Z -            TunnelMessage::Data { stream_id, payload: p } => {
2025-12-16T13:45:25.7196527Z +            TunnelMessage::Data {
2025-12-16T13:45:25.7196617Z +                stream_id,
2025-12-16T13:45:25.7196700Z +                payload: p,
2025-12-16T13:45:25.7196768Z +            } => {
2025-12-16T13:45:25.7196862Z                  assert_eq!(stream_id, 1);
2025-12-16T13:45:25.7196963Z                  assert_eq!(p, payload);
2025-12-16T13:45:25.7197030Z              }
2025-12-16T13:45:25.7197280Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/lib.rs:28:
2025-12-16T13:45:25.7197351Z  
2025-12-16T13:45:25.7197426Z      // Health check
2025-12-16T13:45:25.7197531Z      if path == "/health" || path == "/" {
2025-12-16T13:45:25.7197643Z -        return Response::ok(serde_json::json!({
2025-12-16T13:45:25.7197731Z -            "status": "ok",
2025-12-16T13:45:25.7197823Z -            "service": "zks-tunnel",
2025-12-16T13:45:25.7197904Z -            "version": "0.1.0",
2025-12-16T13:45:25.7198026Z -            "capabilities": ["tcp", "websocket", "zks"]
2025-12-16T13:45:25.7198109Z -        }).to_string());
2025-12-16T13:45:25.7198205Z +        return Response::ok(
2025-12-16T13:45:25.7198291Z +            serde_json::json!({
2025-12-16T13:45:25.7198378Z +                "status": "ok",
2025-12-16T13:45:25.7198474Z +                "service": "zks-tunnel",
2025-12-16T13:45:25.7198559Z +                "version": "0.1.0",
2025-12-16T13:45:25.7198690Z +                "capabilities": ["tcp", "websocket", "zks"]
2025-12-16T13:45:25.7198757Z +            })
2025-12-16T13:45:25.7198836Z +            .to_string(),
2025-12-16T13:45:25.7198901Z +        );
2025-12-16T13:45:25.7199127Z      }
2025-12-16T13:45:25.7199191Z  
2025-12-16T13:45:25.7199390Z      Response::error("Not Found. Use /tunnel for VPN connection.", 404)
2025-12-16T13:45:25.7199658Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/lib.rs:43:
2025-12-16T13:45:25.7199845Z  async fn handle_tunnel(req: Request, env: Env) -> Result<Response> {
2025-12-16T13:45:25.7200096Z      // Get or create Durable Object for this session
2025-12-16T13:45:25.7200354Z      let namespace = env.durable_object("TUNNEL_SESSION")?;
2025-12-16T13:45:25.7200418Z -    
2025-12-16T13:45:25.7200483Z +
2025-12-16T13:45:25.7200575Z      // Generate unique session ID
2025-12-16T13:45:25.7200679Z      let session_id = generate_session_id();
2025-12-16T13:45:25.7200799Z      let id = namespace.id_from_name(&session_id)?;
2025-12-16T13:45:25.7201192Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:6:
2025-12-16T13:45:25.7201295Z  //! - Memory-efficient buffer management
2025-12-16T13:45:25.7201439Z  //! - Hibernation support for zero-cost idle connections
2025-12-16T13:45:25.7201502Z  
2025-12-16T13:45:25.7201579Z -use worker::*;
2025-12-16T13:45:25.7201678Z -use worker::wasm_bindgen::JsCast;
2025-12-16T13:45:25.7201814Z -use zks_tunnel_proto::{TunnelMessage, StreamId};
2025-12-16T13:45:25.7201907Z -use std::collections::HashMap;
2025-12-16T13:45:25.7201990Z  use std::cell::RefCell;
2025-12-16T13:45:25.7202100Z +use std::collections::HashMap;
2025-12-16T13:45:25.7202175Z  use std::rc::Rc;
2025-12-16T13:45:25.7202267Z +use worker::wasm_bindgen::JsCast;
2025-12-16T13:45:25.7202341Z +use worker::*;
2025-12-16T13:45:25.7202474Z +use zks_tunnel_proto::{StreamId, TunnelMessage};
2025-12-16T13:45:25.7202534Z  
2025-12-16T13:45:25.7202646Z  /// Connection state for tracking active streams
2025-12-16T13:45:25.7202748Z  #[derive(Clone, Copy, PartialEq, Eq)]
2025-12-16T13:45:25.7203037Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:61:
2025-12-16T13:45:25.7203144Z          self.state.accept_web_socket(&server);
2025-12-16T13:45:25.7203204Z  
2025-12-16T13:45:25.7203319Z          *self.connection_count.borrow_mut() += 1;
2025-12-16T13:45:25.7203577Z -        console_log!("[TunnelSession] Connection #{} established", self.connection_count.borrow());
2025-12-16T13:45:25.7203651Z +        console_log!(
2025-12-16T13:45:25.7203785Z +            "[TunnelSession] Connection #{} established",
2025-12-16T13:45:25.7203891Z +            self.connection_count.borrow()
2025-12-16T13:45:25.7203956Z +        );
2025-12-16T13:45:25.7204019Z  
2025-12-16T13:45:25.7204121Z          Response::from_websocket(client)
2025-12-16T13:45:25.7204184Z      }
2025-12-16T13:45:25.7204465Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:77:
2025-12-16T13:45:25.7204534Z              }
2025-12-16T13:45:25.7204666Z              WebSocketIncomingMessage::String(text) => {
2025-12-16T13:45:25.7204819Z                  // Handle text messages (could be JSON commands in future)
2025-12-16T13:45:25.7205036Z -                console_log!("[TunnelSession] Text message received: {} bytes", text.len());
2025-12-16T13:45:25.7205116Z +                console_log!(
2025-12-16T13:45:25.7205249Z +                    "[TunnelSession] Text message received: {} bytes",
2025-12-16T13:45:25.7205330Z +                    text.len()
2025-12-16T13:45:25.7205398Z +                );
2025-12-16T13:45:25.7205478Z              }
2025-12-16T13:45:25.7205542Z          }
2025-12-16T13:45:25.7205612Z          Ok(())
2025-12-16T13:45:25.7205892Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:92:
2025-12-16T13:45:25.7205969Z      ) -> Result<()> {
2025-12-16T13:45:25.7206047Z          console_log!(
2025-12-16T13:45:25.7206227Z              "[TunnelSession] Connection closed: code={}, reason={}, clean={}",
2025-12-16T13:45:25.7206315Z -            code, reason, was_clean
2025-12-16T13:45:25.7206382Z +            code,
2025-12-16T13:45:25.7206459Z +            reason,
2025-12-16T13:45:25.7206530Z +            was_clean
2025-12-16T13:45:25.7206595Z          );
2025-12-16T13:45:25.7206663Z -        
2025-12-16T13:45:25.7206723Z +
2025-12-16T13:45:25.7206807Z          // Clean up all streams
2025-12-16T13:45:25.7206949Z          let stream_count = self.active_streams.borrow().len();
2025-12-16T13:45:25.7207158Z          self.active_streams.borrow_mut().clear();
2025-12-16T13:45:25.7207520Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:101:
2025-12-16T13:45:25.7207583Z -        
2025-12-16T13:45:25.7207647Z +
2025-12-16T13:45:25.7207834Z          console_log!("[TunnelSession] Cleaned up {} streams", stream_count);
2025-12-16T13:45:25.7207901Z          Ok(())
2025-12-16T13:45:25.7207963Z      }
2025-12-16T13:45:25.7208251Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:121:
2025-12-16T13:45:25.7208317Z          };
2025-12-16T13:45:25.7208377Z  
2025-12-16T13:45:25.7208453Z          match msg {
2025-12-16T13:45:25.7208608Z -            TunnelMessage::Connect { stream_id, host, port } => {
2025-12-16T13:45:25.7208706Z +            TunnelMessage::Connect {
2025-12-16T13:45:25.7208783Z +                stream_id,
2025-12-16T13:45:25.7208857Z +                host,
2025-12-16T13:45:25.7209084Z +                port,
2025-12-16T13:45:25.7209173Z +            } => {
2025-12-16T13:45:25.7209299Z                  // Validate host to prevent SSRF
2025-12-16T13:45:25.7209405Z                  if !Self::is_valid_host(&host) {
2025-12-16T13:45:25.7209586Z                      console_warn!("[TunnelSession] Rejected invalid host: {}", host);
2025-12-16T13:45:25.7209872Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:128:
2025-12-16T13:45:25.7210016Z                      Self::send_error(ws, stream_id, 400, "Invalid host");
2025-12-16T13:45:25.7210101Z                      return Ok(());
2025-12-16T13:45:25.7210169Z                  }
2025-12-16T13:45:25.7210242Z -                
2025-12-16T13:45:25.7210468Z -                console_log!("[TunnelSession] CONNECT stream={} to {}:{}", stream_id, host, port);
2025-12-16T13:45:25.7210532Z +
2025-12-16T13:45:25.7210611Z +                console_log!(
2025-12-16T13:45:25.7210734Z +                    "[TunnelSession] CONNECT stream={} to {}:{}",
2025-12-16T13:45:25.7210821Z +                    stream_id,
2025-12-16T13:45:25.7210903Z +                    host,
2025-12-16T13:45:25.7210982Z +                    port
2025-12-16T13:45:25.7211049Z +                );
2025-12-16T13:45:25.7211197Z                  self.handle_connect(ws, stream_id, &host, port).await?;
2025-12-16T13:45:25.7211266Z              }
2025-12-16T13:45:25.7211404Z              TunnelMessage::Data { stream_id, payload } => {
2025-12-16T13:45:25.7211685Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:151:
2025-12-16T13:45:25.7211905Z                  console_warn!("[TunnelSession] Received unexpected ErrorReply from client");
2025-12-16T13:45:25.7211972Z              }
2025-12-16T13:45:25.7212114Z              TunnelMessage::DnsQuery { request_id, query } => {
2025-12-16T13:45:25.7212360Z -                console_log!("[TunnelSession] DNS query request_id={} len={}", request_id, query.len());
2025-12-16T13:45:25.7212444Z +                console_log!(
2025-12-16T13:45:25.7212592Z +                    "[TunnelSession] DNS query request_id={} len={}",
2025-12-16T13:45:25.7212673Z +                    request_id,
2025-12-16T13:45:25.7212755Z +                    query.len()
2025-12-16T13:45:25.7212822Z +                );
2025-12-16T13:45:25.7212961Z                  self.handle_dns_query(ws, request_id, &query).await?;
2025-12-16T13:45:25.7213032Z              }
2025-12-16T13:45:25.7213145Z              TunnelMessage::DnsResponse { .. } => {
2025-12-16T13:45:25.7213431Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:158:
2025-12-16T13:45:25.7213567Z                  // Unexpected - worker sends responses, not client
2025-12-16T13:45:25.7213791Z                  console_warn!("[TunnelSession] Received unexpected DnsResponse from client");
2025-12-16T13:45:25.7213857Z              }
2025-12-16T13:45:25.7214057Z -            TunnelMessage::UdpDatagram { request_id, host, port, payload } => {
2025-12-16T13:45:25.7214391Z -                console_log!("[TunnelSession] UDP datagram request_id={} to {}:{} len={}", 
2025-12-16T13:45:25.7214609Z -                    request_id, host, port, payload.len());
2025-12-16T13:45:25.7214714Z +            TunnelMessage::UdpDatagram {
2025-12-16T13:45:25.7214796Z +                request_id,
2025-12-16T13:45:25.7214868Z +                host,
2025-12-16T13:45:25.7214939Z +                port,
2025-12-16T13:45:25.7215014Z +                payload,
2025-12-16T13:45:25.7215084Z +            } => {
2025-12-16T13:45:25.7215161Z +                console_log!(
2025-12-16T13:45:25.7215329Z +                    "[TunnelSession] UDP datagram request_id={} to {}:{} len={}",
2025-12-16T13:45:25.7215411Z +                    request_id,
2025-12-16T13:45:25.7215484Z +                    host,
2025-12-16T13:45:25.7215557Z +                    port,
2025-12-16T13:45:25.7215639Z +                    payload.len()
2025-12-16T13:45:25.7215712Z +                );
2025-12-16T13:45:25.7215849Z                  // Note: Workers don't have raw UDP socket support
2025-12-16T13:45:25.7215968Z                  // For DNS (port 53), we redirect to DoH
2025-12-16T13:45:25.7216050Z                  if port == 53 {
2025-12-16T13:45:25.7216335Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:183:
2025-12-16T13:45:25.7216448Z      /// Validate hostname to prevent SSRF attacks
2025-12-16T13:45:25.7216552Z      fn is_valid_host(host: &str) -> bool {
2025-12-16T13:45:25.7216651Z          // Block internal/private networks
2025-12-16T13:45:25.7216827Z -        let blocked_prefixes = ["127.", "10.", "192.168.", "172.16.", "172.17.", 
2025-12-16T13:45:25.7216953Z -                                "172.18.", "172.19.", "172.20.", "172.21.", "172.22.",
2025-12-16T13:45:25.7217076Z -                                "172.23.", "172.24.", "172.25.", "172.26.", "172.27.",
2025-12-16T13:45:25.7217201Z -                                "172.28.", "172.29.", "172.30.", "172.31.", "169.254.",
2025-12-16T13:45:25.7217346Z -                                "0.", "localhost", "::1", "fc", "fd", "fe80"];
2025-12-16T13:45:25.7217416Z -        
2025-12-16T13:45:25.7217503Z +        let blocked_prefixes = [
2025-12-16T13:45:25.7217572Z +            "127.",
2025-12-16T13:45:25.7217643Z +            "10.",
2025-12-16T13:45:25.7217714Z +            "192.168.",
2025-12-16T13:45:25.7217785Z +            "172.16.",
2025-12-16T13:45:25.7217853Z +            "172.17.",
2025-12-16T13:45:25.7217923Z +            "172.18.",
2025-12-16T13:45:25.7217989Z +            "172.19.",
2025-12-16T13:45:25.7218056Z +            "172.20.",
2025-12-16T13:45:25.7218123Z +            "172.21.",
2025-12-16T13:45:25.7218194Z +            "172.22.",
2025-12-16T13:45:25.7218261Z +            "172.23.",
2025-12-16T13:45:25.7218327Z +            "172.24.",
2025-12-16T13:45:25.7218397Z +            "172.25.",
2025-12-16T13:45:25.7218464Z +            "172.26.",
2025-12-16T13:45:25.7218529Z +            "172.27.",
2025-12-16T13:45:25.7218604Z +            "172.28.",
2025-12-16T13:45:25.7218681Z +            "172.29.",
2025-12-16T13:45:25.7218749Z +            "172.30.",
2025-12-16T13:45:25.7218818Z +            "172.31.",
2025-12-16T13:45:25.7218890Z +            "169.254.",
2025-12-16T13:45:25.7219145Z +            "0.",
2025-12-16T13:45:25.7219228Z +            "localhost",
2025-12-16T13:45:25.7219302Z +            "::1",
2025-12-16T13:45:25.7219393Z +            "fc",
2025-12-16T13:45:25.7219464Z +            "fd",
2025-12-16T13:45:25.7219533Z +            "fe80",
2025-12-16T13:45:25.7219602Z +        ];
2025-12-16T13:45:25.7219664Z +
2025-12-16T13:45:25.7219775Z          let host_lower = host.to_lowercase();
2025-12-16T13:45:25.7219840Z -        
2025-12-16T13:45:25.7219905Z +
2025-12-16T13:45:25.7220008Z          for prefix in blocked_prefixes {
2025-12-16T13:45:25.7220116Z              if host_lower.starts_with(prefix) {
2025-12-16T13:45:25.7220204Z                  return false;
2025-12-16T13:45:25.7220634Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:197:
2025-12-16T13:45:25.7220811Z              }
2025-12-16T13:45:25.7220874Z          }
2025-12-16T13:45:25.7220944Z -        
2025-12-16T13:45:25.7221007Z +
2025-12-16T13:45:25.7221100Z          // Block empty or too long hosts
2025-12-16T13:45:25.7221210Z          if host.is_empty() || host.len() > 253 {
2025-12-16T13:45:25.7221289Z              return false;
2025-12-16T13:45:25.7221577Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:203:
2025-12-16T13:45:25.7221641Z          }
2025-12-16T13:45:25.7221709Z -        
2025-12-16T13:45:25.7221771Z +
2025-12-16T13:45:25.7221838Z          true
2025-12-16T13:45:25.7221907Z      }
2025-12-16T13:45:25.7221967Z  
2025-12-16T13:45:25.7222248Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:231:
2025-12-16T13:45:25.7222312Z          }
2025-12-16T13:45:25.7222377Z  
2025-12-16T13:45:25.7222477Z          // Mark stream as connecting
2025-12-16T13:45:25.7222718Z -        self.active_streams.borrow_mut().insert(stream_id, StreamStatus::Connecting);
2025-12-16T13:45:25.7222805Z +        self.active_streams
2025-12-16T13:45:25.7222881Z +            .borrow_mut()
2025-12-16T13:45:25.7223014Z +            .insert(stream_id, StreamStatus::Connecting);
2025-12-16T13:45:25.7223073Z  
2025-12-16T13:45:25.7223190Z          let address = format!("{}:{}", host, port);
2025-12-16T13:45:25.7223342Z          console_log!("[TunnelSession] Connecting to {}", address);
2025-12-16T13:45:25.7223626Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:240:
2025-12-16T13:45:25.7223753Z          match Socket::builder().connect(host, port) {
2025-12-16T13:45:25.7223831Z              Ok(_socket) => {
2025-12-16T13:45:25.7223983Z                  console_log!("[TunnelSession] Connected to {}", address);
2025-12-16T13:45:25.7224053Z -                
2025-12-16T13:45:25.7224114Z +
2025-12-16T13:45:25.7224207Z                  // Mark as connected
2025-12-16T13:45:25.7224443Z -                self.active_streams.borrow_mut().insert(stream_id, StreamStatus::Connected);
2025-12-16T13:45:25.7224517Z -                
2025-12-16T13:45:25.7224602Z +                self.active_streams
2025-12-16T13:45:25.7224683Z +                    .borrow_mut()
2025-12-16T13:45:25.7224821Z +                    .insert(stream_id, StreamStatus::Connected);
2025-12-16T13:45:25.7224882Z +
2025-12-16T13:45:25.7225031Z                  // Note: Full bidirectional I/O requires spawning tasks
2025-12-16T13:45:25.7225171Z                  // In production, we'd spawn reader/writer tasks here
2025-12-16T13:45:25.7225305Z                  // For now, connection is established and tracked
2025-12-16T13:45:25.7225592Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:250:
2025-12-16T13:45:25.7225659Z -                
2025-12-16T13:45:25.7225724Z +
2025-12-16T13:45:25.7225917Z                  console_log!("[TunnelSession] Stream {} ready for data", stream_id);
2025-12-16T13:45:25.7225990Z              }
2025-12-16T13:45:25.7226067Z              Err(e) => {
2025-12-16T13:45:25.7226349Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:264:
2025-12-16T13:45:25.7226608Z      async fn handle_data(&self, ws: &WebSocket, stream_id: StreamId, payload: &[u8]) -> Result<()> {
2025-12-16T13:45:25.7226714Z          // Check stream exists and is connected
2025-12-16T13:45:25.7226898Z          let status = self.active_streams.borrow().get(&stream_id).copied();
2025-12-16T13:45:25.7226963Z -        
2025-12-16T13:45:25.7227025Z +
2025-12-16T13:45:25.7227103Z          match status {
2025-12-16T13:45:25.7227215Z              Some(StreamStatus::Connected) => {
2025-12-16T13:45:25.7227356Z                  // TODO: Write to socket when full I/O is implemented
2025-12-16T13:45:25.7227749Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:271:
2025-12-16T13:45:25.7228051Z -                console_log!("[TunnelSession] DATA stream={} len={}", stream_id, payload.len());
2025-12-16T13:45:25.7228135Z +                console_log!(
2025-12-16T13:45:25.7228251Z +                    "[TunnelSession] DATA stream={} len={}",
2025-12-16T13:45:25.7228336Z +                    stream_id,
2025-12-16T13:45:25.7228424Z +                    payload.len()
2025-12-16T13:45:25.7228492Z +                );
2025-12-16T13:45:25.7228565Z              }
2025-12-16T13:45:25.7228678Z              Some(StreamStatus::Connecting) => {
2025-12-16T13:45:25.7229092Z -                console_warn!("[TunnelSession] DATA received while stream {} still connecting", stream_id);
2025-12-16T13:45:25.7229185Z +                console_warn!(
2025-12-16T13:45:25.7229372Z +                    "[TunnelSession] DATA received while stream {} still connecting",
2025-12-16T13:45:25.7229448Z +                    stream_id
2025-12-16T13:45:25.7229517Z +                );
2025-12-16T13:45:25.7229605Z              }
2025-12-16T13:45:25.7229725Z              Some(StreamStatus::Closing) | None => {
2025-12-16T13:45:25.7229876Z                  Self::send_error(ws, stream_id, 404, "Stream not found");
2025-12-16T13:45:25.7230175Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:278:
2025-12-16T13:45:25.7230243Z              }
2025-12-16T13:45:25.7230307Z          }
2025-12-16T13:45:25.7230371Z -        
2025-12-16T13:45:25.7230437Z +
2025-12-16T13:45:25.7230504Z          Ok(())
2025-12-16T13:45:25.7230567Z      }
2025-12-16T13:45:25.7230633Z  
2025-12-16T13:45:25.7230916Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:284:
2025-12-16T13:45:25.7231024Z      /// Handle CLOSE command - close TCP socket
2025-12-16T13:45:25.7231192Z      async fn handle_close(&self, stream_id: StreamId) -> Result<()> {
2025-12-16T13:45:25.7231388Z          if let Some(status) = self.active_streams.borrow_mut().remove(&stream_id) {
2025-12-16T13:45:25.7231619Z -            console_log!("[TunnelSession] CLOSE stream={} (was {:?})", stream_id, status);
2025-12-16T13:45:25.7231697Z +            console_log!(
2025-12-16T13:45:25.7231820Z +                "[TunnelSession] CLOSE stream={} (was {:?})",
2025-12-16T13:45:25.7231899Z +                stream_id,
2025-12-16T13:45:25.7231968Z +                status
2025-12-16T13:45:25.7232038Z +            );
2025-12-16T13:45:25.7232104Z          } else {
2025-12-16T13:45:25.7232287Z              console_log!("[TunnelSession] CLOSE stream={} (not found)", stream_id);
2025-12-16T13:45:25.7232352Z          }
2025-12-16T13:45:25.7232642Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:296:
2025-12-16T13:45:25.7232883Z      async fn handle_dns_query(&self, ws: &WebSocket, request_id: u32, query: &[u8]) -> Result<()> {
2025-12-16T13:45:25.7233037Z          // Use resolve_dns_via_doh which uses web_sys fetch directly
2025-12-16T13:45:25.7233184Z          let response = self.resolve_dns_via_doh(query).await;
2025-12-16T13:45:25.7233255Z -        
2025-12-16T13:45:25.7233315Z +
2025-12-16T13:45:25.7233399Z          match response {
2025-12-16T13:45:25.7233485Z              Ok(dns_response) => {
2025-12-16T13:45:25.7233607Z                  let msg = TunnelMessage::DnsResponse {
2025-12-16T13:45:25.7233897Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:304:
2025-12-16T13:45:25.7234032Z                      response: bytes::Bytes::from(dns_response),
2025-12-16T13:45:25.7234100Z                  };
2025-12-16T13:45:25.7234217Z                  let _ = ws.send_with_bytes(&msg.encode());
2025-12-16T13:45:25.7234445Z -                console_log!("[TunnelSession] DNS response sent for request_id={}", request_id);
2025-12-16T13:45:25.7234523Z +                console_log!(
2025-12-16T13:45:25.7234675Z +                    "[TunnelSession] DNS response sent for request_id={}",
2025-12-16T13:45:25.7234883Z +                    request_id
2025-12-16T13:45:25.7235054Z +                );
2025-12-16T13:45:25.7235122Z              }
2025-12-16T13:45:25.7235197Z              Err(e) => {
2025-12-16T13:45:25.7235379Z                  console_error!("[TunnelSession] DoH resolution failed: {:?}", e);
2025-12-16T13:45:25.7235670Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:317:
2025-12-16T13:45:25.7235799Z                  let _ = ws.send_with_bytes(&error_msg.encode());
2025-12-16T13:45:25.7235869Z              }
2025-12-16T13:45:25.7235937Z          }
2025-12-16T13:45:25.7236006Z -        
2025-12-16T13:45:25.7236066Z +
2025-12-16T13:45:25.7236136Z          Ok(())
2025-12-16T13:45:25.7236200Z      }
2025-12-16T13:45:25.7236261Z  
2025-12-16T13:45:25.7236546Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:324:
2025-12-16T13:45:25.7236663Z      /// Resolve DNS query via DoH using native fetch
2025-12-16T13:45:25.7236850Z      async fn resolve_dns_via_doh(&self, query: &[u8]) -> Result<Vec<u8>> {
2025-12-16T13:45:25.7236963Z -        use worker::wasm_bindgen::JsValue;
2025-12-16T13:45:25.7237092Z          use worker::js_sys::{ArrayBuffer, Uint8Array};
2025-12-16T13:45:25.7237155Z -        
2025-12-16T13:45:25.7237252Z +        use worker::wasm_bindgen::JsValue;
2025-12-16T13:45:25.7237317Z +
2025-12-16T13:45:25.7237406Z          // Cloudflare DoH endpoint
2025-12-16T13:45:25.7237523Z          let url = "https://1.1.1.1/dns-query";
2025-12-16T13:45:25.7237587Z -        
2025-12-16T13:45:25.7237653Z +
2025-12-16T13:45:25.7237754Z          // Create the request using web_sys
2025-12-16T13:45:25.7237865Z          let opts = web_sys::RequestInit::new();
2025-12-16T13:45:25.7237959Z          opts.set_method("POST");
2025-12-16T13:45:25.7238246Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:335:
2025-12-16T13:45:25.7238311Z -        
2025-12-16T13:45:25.7238376Z +
2025-12-16T13:45:25.7238470Z          // Set body as ArrayBuffer
2025-12-16T13:45:25.7238655Z          let body_array = Uint8Array::new_with_length(query.len() as u32);
2025-12-16T13:45:25.7238747Z          body_array.copy_from(query);
2025-12-16T13:45:25.7239203Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:339:
2025-12-16T13:45:25.7239311Z          opts.set_body(&body_array.buffer());
2025-12-16T13:45:25.7239375Z -        
2025-12-16T13:45:25.7239440Z +
2025-12-16T13:45:25.7239518Z          // Create headers
2025-12-16T13:45:25.7239754Z -        let headers = web_sys::Headers::new().map_err(|_| Error::from("Headers creation failed"))?;
2025-12-16T13:45:25.7240062Z -        headers.set("Content-Type", "application/dns-message").map_err(|_| Error::from("Set header failed"))?;
2025-12-16T13:45:25.7240344Z -        headers.set("Accept", "application/dns-message").map_err(|_| Error::from("Set header failed"))?;
2025-12-16T13:45:25.7240419Z +        let headers =
2025-12-16T13:45:25.7240629Z +            web_sys::Headers::new().map_err(|_| Error::from("Headers creation failed"))?;
2025-12-16T13:45:25.7240708Z +        headers
2025-12-16T13:45:25.7240840Z +            .set("Content-Type", "application/dns-message")
2025-12-16T13:45:25.7240970Z +            .map_err(|_| Error::from("Set header failed"))?;
2025-12-16T13:45:25.7241041Z +        headers
2025-12-16T13:45:25.7241155Z +            .set("Accept", "application/dns-message")
2025-12-16T13:45:25.7241277Z +            .map_err(|_| Error::from("Set header failed"))?;
2025-12-16T13:45:25.7241367Z          opts.set_headers(&headers);
2025-12-16T13:45:25.7241434Z -        
2025-12-16T13:45:25.7241493Z +
2025-12-16T13:45:25.7241572Z          // Create request
2025-12-16T13:45:25.7241748Z          let request = web_sys::Request::new_with_str_and_init(url, &opts)
2025-12-16T13:45:25.7241891Z              .map_err(|_| Error::from("Request creation failed"))?;
2025-12-16T13:45:25.7242302Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:350:
2025-12-16T13:45:25.7242475Z -        
2025-12-16T13:45:25.7242534Z +
2025-12-16T13:45:25.7242617Z          // Use worker's Fetch
2025-12-16T13:45:25.7242726Z          let global = worker::js_sys::global();
2025-12-16T13:45:25.7242948Z          let fetch_fn = worker::js_sys::Reflect::get(&global, &JsValue::from_str("fetch"))
2025-12-16T13:45:25.7243235Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:354:
2025-12-16T13:45:25.7243364Z              .map_err(|_| Error::from("fetch not found"))?;
2025-12-16T13:45:25.7243432Z -        
2025-12-16T13:45:25.7243493Z +
2025-12-16T13:45:25.7243563Z          // Call fetch
2025-12-16T13:45:25.7243731Z -        let fetch_fn = fetch_fn.dyn_into::<worker::js_sys::Function>()
2025-12-16T13:45:25.7243817Z +        let fetch_fn = fetch_fn
2025-12-16T13:45:25.7243928Z +            .dyn_into::<worker::js_sys::Function>()
2025-12-16T13:45:25.7244076Z              .map_err(|_| Error::from("fetch is not a function"))?;
2025-12-16T13:45:25.7244152Z -        
2025-12-16T13:45:25.7244297Z -        let promise = fetch_fn.call1(&JsValue::NULL, &request)
2025-12-16T13:45:25.7244358Z +
2025-12-16T13:45:25.7244447Z +        let promise = fetch_fn
2025-12-16T13:45:25.7244549Z +            .call1(&JsValue::NULL, &request)
2025-12-16T13:45:25.7244672Z              .map_err(|_| Error::from("fetch call failed"))?;
2025-12-16T13:45:25.7244736Z -        
2025-12-16T13:45:25.7244799Z +
2025-12-16T13:45:25.7244941Z          let promise = worker::js_sys::Promise::from(promise);
2025-12-16T13:45:25.7245099Z          let future = wasm_bindgen_futures::JsFuture::from(promise);
2025-12-16T13:45:25.7245168Z -        
2025-12-16T13:45:25.7245413Z -        let response = future.await.map_err(|e| Error::from(format!("fetch failed: {:?}", e)))?;
2025-12-16T13:45:25.7245555Z -        let response: web_sys::Response = response.dyn_into()
2025-12-16T13:45:25.7245619Z +
2025-12-16T13:45:25.7245702Z +        let response = future
2025-12-16T13:45:25.7245786Z +            .await
2025-12-16T13:45:25.7245937Z +            .map_err(|e| Error::from(format!("fetch failed: {:?}", e)))?;
2025-12-16T13:45:25.7246060Z +        let response: web_sys::Response = response
2025-12-16T13:45:25.7246135Z +            .dyn_into()
2025-12-16T13:45:25.7246265Z              .map_err(|_| Error::from("response cast failed"))?;
2025-12-16T13:45:25.7246337Z -        
2025-12-16T13:45:25.7246399Z +
2025-12-16T13:45:25.7246483Z          if !response.ok() {
2025-12-16T13:45:25.7246699Z -            return Err(Error::from(format!("DoH returned status {}", response.status())));
2025-12-16T13:45:25.7246807Z +            return Err(Error::from(format!(
2025-12-16T13:45:25.7246900Z +                "DoH returned status {}",
2025-12-16T13:45:25.7246988Z +                response.status()
2025-12-16T13:45:25.7247057Z +            )));
2025-12-16T13:45:25.7247120Z          }
2025-12-16T13:45:25.7247183Z -        
2025-12-16T13:45:25.7247243Z +
2025-12-16T13:45:25.7247353Z          // Get response body as ArrayBuffer
2025-12-16T13:45:25.7247479Z -        let body_promise = response.array_buffer()
2025-12-16T13:45:25.7247568Z +        let body_promise = response
2025-12-16T13:45:25.7247658Z +            .array_buffer()
2025-12-16T13:45:25.7247800Z              .map_err(|_| Error::from("array_buffer() failed"))?;
2025-12-16T13:45:25.7247864Z -        
2025-12-16T13:45:25.7247935Z +
2025-12-16T13:45:25.7248121Z          let body_future = wasm_bindgen_futures::JsFuture::from(body_promise);
2025-12-16T13:45:25.7248326Z -        let body = body_future.await.map_err(|_| Error::from("body await failed"))?;
2025-12-16T13:45:25.7248390Z -        
2025-12-16T13:45:25.7248521Z -        let array_buffer: ArrayBuffer = body.dyn_into()
2025-12-16T13:45:25.7248606Z +        let body = body_future
2025-12-16T13:45:25.7248676Z +            .await
2025-12-16T13:45:25.7248809Z +            .map_err(|_| Error::from("body await failed"))?;
2025-12-16T13:45:25.7248873Z +
2025-12-16T13:45:25.7249300Z +        let array_buffer: ArrayBuffer = body
2025-12-16T13:45:25.7249494Z +            .dyn_into()
2025-12-16T13:45:25.7249635Z              .map_err(|_| Error::from("body cast failed"))?;
2025-12-16T13:45:25.7249699Z -        
2025-12-16T13:45:25.7249761Z +
2025-12-16T13:45:25.7249898Z          let uint8_array = Uint8Array::new(&array_buffer);
2025-12-16T13:45:25.7250030Z          let mut vec = vec![0u8; uint8_array.length() as usize];
2025-12-16T13:45:25.7250124Z          uint8_array.copy_to(&mut vec);
2025-12-16T13:45:25.7250424Z Diff in /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN/zks-tunnel-worker/src/tunnel_session.rs:387:
2025-12-16T13:45:25.7250489Z -        
2025-12-16T13:45:25.7250548Z +
2025-12-16T13:45:25.7250616Z          Ok(vec)
2025-12-16T13:45:25.7250683Z      }
2025-12-16T13:45:25.7250743Z  }
2025-12-16T13:45:25.7260559Z ##[error]Process completed with exit code 1.
2025-12-16T13:45:25.7363174Z Post job cleanup.
2025-12-16T13:45:25.8288047Z [command]/usr/bin/git version
2025-12-16T13:45:25.8323654Z git version 2.52.0
2025-12-16T13:45:25.8368077Z Temporarily overriding HOME='/home/runner/work/_temp/c29aecc0-3c24-466e-8b71-9ef71ce4a484' before making global git config changes
2025-12-16T13:45:25.8368563Z Adding repository directory to the temporary git global config as a safe directory
2025-12-16T13:45:25.8374046Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/ZKS-Tunnel-VPN/ZKS-Tunnel-VPN
2025-12-16T13:45:25.8413932Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-12-16T13:45:25.8446526Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-12-16T13:45:25.8675034Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-12-16T13:45:25.8694976Z http.https://github.com/.extraheader
2025-12-16T13:45:25.8710028Z [command]/usr/bin/git config --local --unset-all http.https://github.com/.extraheader
2025-12-16T13:45:25.8740572Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-12-16T13:45:25.8956665Z [command]/usr/bin/git config --local --name-only --get-regexp ^includeIf\.gitdir:
2025-12-16T13:45:25.8985409Z [command]/usr/bin/git submodule foreach --recursive git config --local --show-origin --name-only --get-regexp remote.origin.url
2025-12-16T13:45:25.9308488Z Cleaning up orphan processes
